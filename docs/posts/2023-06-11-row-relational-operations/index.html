<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
<title>June Choe: Row relational operations with slice()</title>

<meta property="description" itemprop="description" content="A love letter to dplyr::slice() and a gallery of usecases"/>

<link rel="canonical" href="https://yjunechoe.github.io/posts/2023-06-11-row-relational-operations/"/>
<link rel="icon" type="image/png" href="../../static/img/icon.png"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2023-06-11"/>
<meta property="article:created" itemprop="dateCreated" content="2023-06-11"/>
<meta name="article:author" content="June Choe"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="June Choe: Row relational operations with slice()"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="A love letter to dplyr::slice() and a gallery of usecases"/>
<meta property="og:url" content="https://yjunechoe.github.io/posts/2023-06-11-row-relational-operations/"/>
<meta property="og:image" content="https://yjunechoe.github.io/posts/2023-06-11-row-relational-operations/preview.png"/>
<meta property="og:image:width" content="1800"/>
<meta property="og:image:height" content="1080"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="June Choe"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="June Choe: Row relational operations with slice()"/>
<meta property="twitter:description" content="A love letter to dplyr::slice() and a gallery of usecases"/>
<meta property="twitter:url" content="https://yjunechoe.github.io/posts/2023-06-11-row-relational-operations/"/>
<meta property="twitter:image" content="https://yjunechoe.github.io/posts/2023-06-11-row-relational-operations/preview.png"/>
<meta property="twitter:image:width" content="1800"/>
<meta property="twitter:image:height" content="1080"/>
<meta property="twitter:site" content="@yjunechoe"/>

<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","categories","base_url","author","date","output","editor_options","preview","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["Row relational operations with slice()"]},{"type":"character","attributes":{},"value":["A love letter to dplyr::slice() and a gallery of usecases"]},{"type":"character","attributes":{},"value":["data wrangling","dplyr"]},{"type":"character","attributes":{},"value":["https://yjunechoe.github.io"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","affiliation_url","orcid_id"]}},"value":[{"type":"character","attributes":{},"value":["June Choe"]},{"type":"character","attributes":{},"value":["University of Pennsylvania Linguistics"]},{"type":"character","attributes":{},"value":["https://live-sas-www-ling.pantheon.sas.upenn.edu/"]},{"type":"character","attributes":{},"value":["0000-0002-0701-921X"]}]}]},{"type":"character","attributes":{},"value":["2023-06-11"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["include-after-body","toc","self_contained","css"]}},"value":[{"type":"character","attributes":{},"value":["highlighting.html"]},{"type":"logical","attributes":{},"value":[true]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["../../styles.css"]}]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["chunk_output_type"]}},"value":[{"type":"character","attributes":{},"value":["console"]}]},{"type":"character","attributes":{},"value":["preview.png"]},{"type":"character","attributes":{},"value":["https://yjunechoe.github.io/posts/2023-06-11-row-relational-operations/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["preview.png","row-relational-operations_files/anchor-4.2.2/anchor.min.js","row-relational-operations_files/bowser-1.9.3/bowser.min.js","row-relational-operations_files/clipboard-2.0.6/clipboard.min.js","row-relational-operations_files/distill-2.2.21/template.v2.js","row-relational-operations_files/figure-html5/final-gapminder-plot-1.png","row-relational-operations_files/header-attrs-2.19/header-attrs.js","row-relational-operations_files/header-attrs-2.21/header-attrs.js","row-relational-operations_files/jquery-3.6.0/jquery-3.6.0.js","row-relational-operations_files/jquery-3.6.0/jquery-3.6.0.min.js","row-relational-operations_files/jquery-3.6.0/jquery-3.6.0.min.map","row-relational-operations_files/panelset-0.2.6/panelset.css","row-relational-operations_files/panelset-0.2.6/panelset.js","row-relational-operations_files/popper-2.6.0/popper.min.js","row-relational-operations_files/tippy-6.2.7/tippy-bundle.umd.min.js","row-relational-operations_files/tippy-6.2.7/tippy-light-border.css","row-relational-operations_files/tippy-6.2.7/tippy.css","row-relational-operations_files/tippy-6.2.7/tippy.umd.min.js","row-relational-operations_files/webcomponents-2.0.0/webcomponents.js","row-relational-operations_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.css","row-relational-operations_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
  font-size: 100%;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

hr.section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  margin: 0px;
}


d-byline {
  border-top: none;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
  border-top: none;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

/* tweak for Pandoc numbered line within distill */
d-article pre.numberSource code > span {
    left: -2em;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // separator
  var separator = '<hr class="section-separator" style="clear: both"/>';
  // prepend separator above appendix
  $('.d-byline').before(separator);
  $('.d-article').before(separator);

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme, except when numbering line
  // in code chunk
  $('pre:not(.numberLines) code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      var author_name = front_matter.authors[i].author
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', author_name ? 'ORCID ID for ' + author_name : 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      const citeChild = $(this).children()[0]
      // Do not process if @xyz has been used without escaping and without bibliography activated
      // https://github.com/rstudio/distill/issues/466
      if (citeChild === undefined) return true

      if (citeChild.nodeName == "D-FOOTNOTE") {
        var fn = citeChild
        $(this).html(fn.shadowRoot.querySelector("sup"))
        $(this).id = fn.id
        fn.remove()
      }
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        // Could use CSS.escape too here, we insure backward compatibility in navigator
        return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // fix footnotes in tables (#411)
    // replacing broken distill.pub feature
    $('table d-footnote').each(function() {
      // we replace internal showAtNode methode which is triggered when hovering a footnote
      this.hoverBox.showAtNode = function(node) {
        // ported from https://github.com/distillpub/template/pull/105/files
        calcOffset = function(elem) {
            let x = elem.offsetLeft;
            let y = elem.offsetTop;
            // Traverse upwards until an `absolute` element is found or `elem`
            // becomes null.
            while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                x += elem.offsetLeft;
                y += elem.offsetTop;
            }

            return { left: x, top: y };
        }
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
        const bbox = node.getBoundingClientRect();
        const offset = calcOffset(node);
        this.show([offset.left + bbox.width, offset.top + bbox.height]);
      }
    })

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    // ignore leaflet img layers (#106)
    figures = figures.filter(':not(img[class*="leaflet"])')
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.21/header-attrs.js"></script>
  <link href="../../site_libs/panelset-0.2.6/panelset.css" rel="stylesheet" />
  <script src="../../site_libs/panelset-0.2.6/panelset.js"></script>
  <script src="../../site_libs/clipboard-2.0.6/clipboard.min.js"></script>
  <link href="../../site_libs/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.css" rel="stylesheet" />
  <script src="../../site_libs/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.js"></script>
  <script>window.xaringanExtraClipboard(null, {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>
  <script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script type="text/javascript" cookie-consent="tracking" async src="https://www.googletagmanager.com/gtag/js?id=UA-178413324-1"></script>
<script type="text/javascript" cookie-consent="tracking">
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-178413324-1');
</script>
<style type="text/css">
/* ---------- Global Styles ---------- */

@import url('https://fonts.googleapis.com/css?family=Atkinson+Hyperlegible&display=swap');
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap');
@import url('https://fonts.googleapis.com/css?family=Roboto+Slab&display=swap');
@import url('https://fonts.googleapis.com/css?family=Roboto&display=swap');
@import url('https://fonts.googleapis.com/css?family=Fira+Mono&display=swap');

html, body, p {
  
  font-family: 'Atkinson Hyperlegible';
  font-weight: 400;
  line-height: 1.7; 
  font-size: 1em;
  color: #333333;
  font-style: normal;
  
}

h2, h3 {
  font-family: 'Roboto Slab'
}

d-article h4 {
  font-size: 20px;
  text-align: center;
  margin-top: 0.5em;
  padding: 5px 0px;
  outline: 1px solid black;
}

d-article h5 {
  font-size: 18px;
  text-decoration: underline;
  margin-bottom: 0.5em;
}

em {
  margin-right: 3px;
}

div.opener {
  text-align: justify;
}

/* Small caps */

.sc {
  font-variant: small-caps;
  letter-spacing: 0.1em;
}


/* ---------- Index Page Styles ---------- */


/* Name time */

div.nav-left.title {
  font-family: 'Roboto Slab';
}


/* Search bar */

.angolia-autocomplete {
  width: 300px;
}

.nav-search {
    font-size: inherit;
}

/* Publication Date */

.publishedDate {
  font-size: 1.1em;
}


/* Post Description */

.posts-list .description h2 {
  font-family: 'Roboto Slab';
}

.description p {
  font-style: italic;
  padding-top: 5px;
}


/* Tags */

.posts-list .dt-tags {
  margin-top: 10px;
  margin-right: 10px;
}


.posts-list .dt-tags .dt-tag {
  font-family: 'Roboto Slab';
  font-weight: bold;
  letter-spacing: 1px;
  background-color: #565656;
  color: white;
}

/* Top & Bot bars */

.distill-site-nav {
  background-color: #262c2f;
}

.distill-site-footer p {
  color: white;
}



/* Post published date medatada */
.posts-list .metadata .publishedDate{
  font-family: 'Roboto Mono';
}


/* Post list caption */
.posts-list .posts-list-caption{
  font-family: 'Fira Mono';
  border-bottom: 5px solid #f3f3f3;
  padding-bottom: 2rem;
}


/* Sidebar Categories */
.posts-sidebar {
  font-family: 'Fira Mono';
}

.sidebar-section h3 {
  font-size: 22px;
  margin-bottom: 20px;
}


/* ---------- Article Styles ---------- */


/* Title */

d-title {
  padding-bottom: 0;
}

d-title h1 {
  font-family: 'Roboto Slab';
  line-height: 1.3;
}

d-title p {
  font-weight: 600;
}


/* General */

d-article > h2 {
  margin: 2.5rem 0 1.5rem 0;
  border-bottom: 2px solid black;
}

div.l-body + h2 {
  margin-top: 0px;
}

d-article > h3 {
  margin-top: 1em;
  font-size: 28px;
  padding-bottom: 10px;
  border-bottom: 2px solid lightgrey;
}

d-article ol {
  padding-bottom: 15px;
}

/* Aside */

aside {
  margin-left: 20px;
  width: 200px;
  font-family: 'Roboto Slab';
}

div.sourceCode + aside {
  margin-top: 1.5em;
}

aside code {
  font-weight: 600;
}

/* Details */
summary {
  padding-left: 5px;
}

details {
  background-color: #008bff0f;
  outline: 2px solid #38566F;
  padding: 1rem;
}

d-article details[open] summary {
  margin-bottom: 1em;
}

/* Block Quotes */

d-article blockquote {
  border-left: 5px solid rgba(0, 0, 0, 0.2);
  padding-left: 1em;
}

blockquote p {
  margin-bottom: 0;
}


/* Footnote margins */
d-footnote {
  margin-left: -.2em;
  margin-right: .1em;
}

/* Footnote Image */

d-footnote-list ol li img {
  width: 700px;
}

d-footnote img {
  width: 660px;
  padding: 10px;
}


/* -------- Layout Helpers -------- */

/* 2-column Even */

.pull-left {
  float: left;
  width: 47%;
}

.pull-right {
  float: right;
  width: 47%;
}

/* 2-column Left-skew */

.pull-left-wide {
  float: left;
  width: 75%;
}

.pull-right-narrow {
  float: right;
  width: 20%;
}

/* 2-column Right-skew */

.pull-left-narrow {
  float: left;
  width: 20%;
}

.pull-right-wide {
  float: right;
  width: 75%;
}


/* ---------- Code Styles ---------- */

/* Inline Code */

p > code, li > code, summary > code {
  border-radius: 4px;
  padding: 2px;
  color: black;
  background-color: #fbc4ff80;
  font-family: 'Fira Mono';
  font-weight: 600;
  font-size: 0.8em;
}

a > code {
    font-weight: bold;
}


/* Code Chunk */

d-article div.sourceCode pre {
  position: relative;
  background-color: white;
  padding-top: 10px;
  padding-bottom: 10px;
  margin-bottom: 10px;
  border-left: 5px solid #4D8DC9;
}

d-article pre.out-extended {
  width: fit-content;
  max-width: fit-content;
  padding-right: 10px;
}

/* R chunk */
d-article div.sourceCode pre.r {
  background-color: #faffff;
}

/* Julia chunk */
d-article div.sourceCode pre.julia {
  background-color: #f8fffb;
  border-left: 5px solid #4A916B;
}

d-article details div.sourceCode pre {
  background-color: white;
}

/*
d-article div.sourceCode pre.r:before {
  position: absolute;
  font-size: 1rem;
  content: 'R';
  font-family: 'Fira Mono';
  font-weight: 600;
  left: -20px;
  top: -5px;
  color: #59a2e6;
}
*/

d-article div.sourceCode pre code {
  font-family: 'Fira Mono';
  font-weight: 600;
}


/* overrides some syntax highlighting */

span.va {
  color: black;
}
span.fu {
  color: #3456cc;
}
span.cn {
  color: #ef3e3a;
}
span.fl {
  color: #c8531d;
}
span.kw {
  color: #9f1eb1;
}
span.st {
  color: #148a14;
}
span.co {
  color: #999999;
  font-weight: 500;
}

i.code-hl {
  font-style: normal;
  font-weight: bold;
  background-color: #acf120;
  padding: 2px 5px;
  font-size: 1.1em;
  outline: 1px solid lightgrey;
}

/* underline auto-linked functions */

span.va a {
  text-decoration: underline;
}
span.fu a {
  text-decoration: underline;
}


/* Output Chunk */

d-article pre code {
  font-family: 'Fira Mono';
  font-weight: 500;
}

d-article pre {
  background-color: #f9f9f9;
  padding-top: 10px;
  padding-bottom: 10px;
  margin-bottom: 30px;
  overflow-x: scroll;
}


/* Footnote inline code */

d-footnote-list code {
  color: rgb(0 0 0 / 0.70);
  font-weight: 600;
}

/* ---------- ADD-ONS ---------- */


/* {rmarkdown} */

.pagedtable-wrapper {
  margin-bottom: 20px;
}


/* html widgets */

.html-widget {
  margin-top: 1.0em;
  margin-bottom: 1.0em;
}


/* {reactable} */

.ReactTable {
  font-size: 14px;
  font-family: 'Roboto Slab';
  background-color: #fbfbfb;
}


/* {xaringanExtra} */

.panelset {
  margin-top: 10px;
  --panel-tabs-border-bottom: black;
  --panel-tab-font-family: 'Roboto Slab';
  --panel-tab-hover-background: #ddd;
  --panel-tab-text-decoration: none;
  border-bottom: 2px solid black;
  margin-bottom: 30px;
}

.panelset section {
    margin-top: 30px;
    margin-bottom: 20px;
}

.panel > pre {
  overflow-x: auto !important;
}

</style>
<!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="../../styles.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Row relational operations with slice()","description":"A love letter to dplyr::slice() and a gallery of usecases","authors":[{"author":"June Choe","authorURL":"#","affiliation":"University of Pennsylvania Linguistics","affiliationURL":"https://live-sas-www-ling.pantheon.sas.upenn.edu/","orcidID":"0000-0002-0701-921X"}],"publishedDate":"2023-06-11T00:00:00.000-04:00","citationText":"Choe, 2023"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="../../index.html" class="title">June Choe</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../index.html">Home</a>
<a href="../../blog.html">Blog</a>
<a href="../../research.html">Research</a>
<a href="../../static/CV.pdf">CV</a>
<a href="../../software.html">Software</a>
<a href="../../news.html">News</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Misc.
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="../../resources.html">Resources</a>
</div>
</div>
<a href="https://twitter.com/yjunechoe">
<i class="fa fa-twitter" aria-hidden="true"></i>
</a>
<a href="https://fosstodon.org/@yjunechoe">
<i class="fa fa-brands fa-mastodon" aria-hidden="true"></i>
</a>
<a href="https://github.com/yjunechoe">
<i class="fa fa-github" aria-hidden="true"></i>
</a>
<a href="https://osf.io/72vrb/" class="nav-image">
<img src="../../static/img/osf.png"/>
</a>
<a href="../../sitemap.xml">
<i class="fa fa-rss" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Row relational operations with slice()</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../blog.html#category:data_wrangling" class="dt-tag">data wrangling</a>
  <a href="../../blog.html#category:dplyr" class="dt-tag">dplyr</a>
</div>
<!--/radix_placeholder_categories-->
<p><p>A love letter to dplyr::slice() and a gallery of usecases</p></p>
</div>

<div class="d-byline">
  June Choe  (University of Pennsylvania Linguistics)<a href="https://live-sas-www-ling.pantheon.sas.upenn.edu/" class="uri">https://live-sas-www-ling.pantheon.sas.upenn.edu/</a>
  
<br/>2023-06-11
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#intro" id="toc-intro">Intro</a></li>
<li><a href="#special-properties-of-dplyrslice" id="toc-special-properties-of-dplyrslice">Special properties of <code>dplyr::slice()</code></a>
<ul>
<li><a href="#basic-usage" id="toc-basic-usage">Basic usage</a></li>
<li><a href="#re-imagining-slice-with-data-masking" id="toc-re-imagining-slice-with-data-masking">Re-imagining <code>slice()</code> with data-masking</a></li>
<li><a href="#special-properties-of-slice" id="toc-special-properties-of-slice">Special properties of <code>slice()</code></a></li>
</ul></li>
<li><a href="#a-gallery-of-row-operations-with-slice" id="toc-a-gallery-of-row-operations-with-slice">A gallery of row operations with <code>slice()</code></a>
<ul>
<li><a href="#repeat-rows-in-place" id="toc-repeat-rows-in-place">Repeat rows (in place)</a></li>
<li><a href="#subset-a-selection-of-rows-the-following-row" id="toc-subset-a-selection-of-rows-the-following-row">Subset a selection of rows + the following row</a></li>
<li><a href="#subset-a-selection-of-rows-multiple-following-rows" id="toc-subset-a-selection-of-rows-multiple-following-rows">Subset a selection of rows + multiple following rows</a></li>
<li><a href="#filter-and-encode-neighboring-rows" id="toc-filter-and-encode-neighboring-rows">Filter (and encode) neighboring rows</a></li>
<li><a href="#windowed-minmaxmedian-etc." id="toc-windowed-minmaxmedian-etc.">Windowed min/max/median (etc.)</a></li>
<li><a href="#evenly-distributed-row-shuffling-of-balanced-categories" id="toc-evenly-distributed-row-shuffling-of-balanced-categories">Evenly distributed row shuffling of balanced categories</a></li>
<li><a href="#inserting-a-new-row-at-specific-intervals" id="toc-inserting-a-new-row-at-specific-intervals">Inserting a new row at specific intervals</a></li>
<li><a href="#evenly-distributed-row-shuffling-of-unequal-categories" id="toc-evenly-distributed-row-shuffling-of-unequal-categories">Evenly distributed row shuffling of unequal categories</a></li>
</ul></li>
<li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
</ul>
</nav>
</div>
<h2 id="intro">Intro</h2>
<p>In data wrangling, there are a handful of <strong>classes</strong> of operations on data frames that we think of as theoretically well-defined and tackling distinct problems. To name a few, these include subsetting, joins, split-apply-combine, pairwise operations, nested-column workflows, and so on.</p>
<p>Against this rich backdrop, there’s one aspect of data wrangling that doesn’t receive as much attention: <strong>ordering of rows</strong>. This isn’t necessarily surprising - we often think of row order as an auxiliary attribute of data frames since they don’t speak to the content of the data, <em>per se</em>. I think we all share the intuition that two dataframe that differ only in row order are practically the same for most analysis purposes.</p>
<p><em>Except when they aren’t.</em></p>
<p>In this blog post I want to talk about a few, somewhat esoteric cases of what I like to call <strong>row-relational operations</strong>. My goal is to try to motivate row-relational operations as a full-blown class of data wrangling operation that includes not only row ordering, but also sampling, shuffling, repeating, interweaving, and so on (I’ll go over all of these later).</p>
<p>Without spoiling too much, I believe that <code>dplyr::slice()</code> offers a powerful context for operations over row indices, even those that at first seem to lack a “tidy” solution. You may already know <code>slice()</code> as an indexing function, but my hope is to convince you that it can do so much more.</p>
<p>Let’s start by first talking about some special properties of <code>dplyr::slice()</code>, and then see how we can use it for various row-relational operations.</p>
<h2 id="special-properties-of-dplyrslice">Special properties of <code>dplyr::slice()</code></h2>
<h3 id="basic-usage">Basic usage</h3>
<p>For the following demonstration, I’ll use a small subset of the <code>dplyr::starwars</code> dataset:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>&lt;-</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='va'><a href='https://dplyr.tidyverse.org/reference/starwars.html'>starwars</a></span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>3</span><span class='op'>]</span></span>
<span><span class='va'>starwars_sm</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 Luke Skywalker        172    77
   2 C-3PO                 167    75
   3 R2-D2                  96    32
   4 Darth Vader           202   136
   5 Leia Organa           150    49
   6 Owen Lars             178   120
   7 Beru Whitesun lars    165    75
   8 R5-D4                  97    32
   9 Biggs Darklighter     183    84
  10 Obi-Wan Kenobi        182    77</code></pre>
</div>
<h4 id="row-selection">1) Row selection</h4>
<p><code>slice()</code> is a row indexing verb - if you pass it a vector of integers, it subsets data frame rows:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>6</span><span class='op'>)</span> <span class='co'># First six rows</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 3
    name           height  mass
    &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;
  1 Luke Skywalker    172    77
  2 C-3PO             167    75
  3 R2-D2              96    32
  4 Darth Vader       202   136
  5 Leia Organa       150    49
  6 Owen Lars         178   120</code></pre>
</div>
<p>Like other dplyr verbs with mutate-semantics, you can use <a href="https://dplyr.tidyverse.org/reference/context.html">context-dependent expressions</a> inside <code>slice()</code>. For example, you can use <code>n()</code> to grab the last row (or last couple of rows):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>)</span> <span class='co'># Last row</span></span></code></pre>
</div>
<pre><code>  # A tibble: 1 × 3
    name           height  mass
    &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;
  1 Obi-Wan Kenobi    182    77</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>-</span> <span class='fl'>2</span><span class='op'>:</span><span class='fl'>0</span> <span class='op'>)</span> <span class='co'># Last three rows</span></span></code></pre>
</div>
<pre><code>  # A tibble: 3 × 3
    name              height  mass
    &lt;chr&gt;              &lt;int&gt; &lt;dbl&gt;
  1 R5-D4                 97    32
  2 Biggs Darklighter    183    84
  3 Obi-Wan Kenobi       182    77</code></pre>
</div>
<p>Another context-dependent expression that comes in handy is <code>row_number()</code>, which returns all row indices. Using it inside <code>slice()</code> essentially performs an identity transformation:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span></span>
<span>  <span class='va'>starwars_sm</span>,</span>
<span>  <span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>)</span></span>
<span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] TRUE</code></pre>
</div>
<p>Lastly, similar to in <code>select()</code>, you can use <code>-</code> for negative indexing (to remove rows):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span></span>
<span>  <span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>3</span><span class='op'>)</span>,      <span class='co'># First three rows</span></span>
<span>  <span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='op'>-</span><span class='op'>(</span><span class='fl'>4</span><span class='op'>:</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>  <span class='co'># All rows except fourth row to last row</span></span>
<span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] TRUE</code></pre>
</div>
<h4 id="dynamic-dots">2) Dynamic dots</h4>
<p><code>slice()</code> supports <a href="https://rlang.r-lib.org/reference/dyn-dots.html">dynamic dots</a>. If you pass row indices into multiple argument positions, <code>slice()</code> will concatenate them for you:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span></span>
<span>  <span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>6</span><span class='op'>)</span>,</span>
<span>  <span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>:</span><span class='fl'>4</span>, <span class='fl'>5</span>, <span class='fl'>6</span><span class='op'>)</span></span>
<span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] TRUE</code></pre>
</div>
<p>If you have a <code>list()</code> of row indices, you can use the <a href="https://rlang.r-lib.org/reference/splice-operator.html">splice operator</a> <code>!!!</code> to spread them out:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='op'>!</span><span class='op'>!</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>:</span><span class='fl'>4</span>, <span class='fl'>5</span>, <span class='fl'>6</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 3
    name           height  mass
    &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;
  1 Luke Skywalker    172    77
  2 C-3PO             167    75
  3 R2-D2              96    32
  4 Darth Vader       202   136
  5 Leia Organa       150    49
  6 Owen Lars         178   120</code></pre>
</div>
<p>The above call to <code>slice()</code> evaluates to the following after splicing:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/expr.html'>expr</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='op'>!</span><span class='op'>!</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>:</span><span class='fl'>4</span>, <span class='fl'>5</span>, <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  slice(1, 2:4, 5, 6)</code></pre>
</div>
<h4 id="row-ordering">3) Row ordering</h4>
<p><code>slice()</code> respects the order in which you supplied the row indices:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>3</span>, <span class='fl'>1</span>, <span class='fl'>2</span>, <span class='fl'>5</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 4 × 3
    name           height  mass
    &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;
  1 R2-D2              96    32
  2 Luke Skywalker    172    77
  3 C-3PO             167    75
  4 Leia Organa       150    49</code></pre>
</div>
<p>This means you can do stuff like random sampling with <code>sample()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 Obi-Wan Kenobi        182    77
   2 Owen Lars             178   120
   3 Leia Organa           150    49
   4 Darth Vader           202   136
   5 Luke Skywalker        172    77
   6 R5-D4                  97    32
   7 C-3PO                 167    75
   8 Beru Whitesun lars    165    75
   9 Biggs Darklighter     183    84
  10 R2-D2                  96    32</code></pre>
</div>
<p>You can also shuffle a subset of rows (ex: just the first five):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fl'>5</span><span class='op'>)</span>, <span class='fl'>6</span><span class='op'>:</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 C-3PO                 167    75
   2 Leia Organa           150    49
   3 R2-D2                  96    32
   4 Darth Vader           202   136
   5 Luke Skywalker        172    77
   6 Owen Lars             178   120
   7 Beru Whitesun lars    165    75
   8 R5-D4                  97    32
   9 Biggs Darklighter     183    84
  10 Obi-Wan Kenobi        182    77</code></pre>
</div>
<p>Or reorder all rows by their indices (ex: in reverse):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/rev.html'>rev</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 Obi-Wan Kenobi        182    77
   2 Biggs Darklighter     183    84
   3 R5-D4                  97    32
   4 Beru Whitesun lars    165    75
   5 Owen Lars             178   120
   6 Leia Organa           150    49
   7 Darth Vader           202   136
   8 R2-D2                  96    32
   9 C-3PO                 167    75
  10 Luke Skywalker        172    77</code></pre>
</div>
<h4 id="out-of-bounds-handling">4) Out-of-bounds handling</h4>
<p>If you pass a row index that’s out of bounds, <code>slice()</code> returns a 0-row data frame:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span> <span class='op'>)</span> <span class='co'># Select the row after the last row</span></span></code></pre>
</div>
<pre><code>  # A tibble: 0 × 3
  # ℹ 3 variables: name &lt;chr&gt;, height &lt;int&gt;, mass &lt;dbl&gt;</code></pre>
</div>
<p>When mixed with valid row indices, out-of-bounds indices are simply ignored (much 💜 for this behavior):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fl'>0</span>,       <span class='co'># 0th row - ignored</span></span>
<span>    <span class='fl'>1</span><span class='op'>:</span><span class='fl'>3</span>,     <span class='co'># first three rows</span></span>
<span>    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span>  <span class='co'># 1 after last row - ignored</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 3 × 3
    name           height  mass
    &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;
  1 Luke Skywalker    172    77
  2 C-3PO             167    75
  3 R2-D2              96    32</code></pre>
</div>
<p>This lets you do funky stuff like select all even numbered rows by passing <code>slice()</code> all row indices times 2:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>)</span> <span class='co'># Add `- 1` at the end for *odd* rows!</span></span></code></pre>
</div>
<pre><code>  # A tibble: 5 × 3
    name           height  mass
    &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;
  1 C-3PO             167    75
  2 Darth Vader       202   136
  3 Owen Lars         178   120
  4 R5-D4              97    32
  5 Obi-Wan Kenobi    182    77</code></pre>
</div>
<h3 id="re-imagining-slice-with-data-masking">Re-imagining <code>slice()</code> with data-masking</h3>
<p><code>slice()</code> is already pretty neat as it is, but that’s just the tip of the iceberg.</p>
<p>The really cool, under-rated feature of <code>slice()</code> is that it’s <a href="https://dplyr.tidyverse.org/reference/dplyr_data_masking.html"><strong>data-masked</strong></a>, meaning that you can reference column vectors as if they’re variables. Another way of describing this property of <code>slice()</code> is to say that it has <a href="https://rlang.r-lib.org/reference/topic-data-mask-programming.html"><strong>mutate-semantics</strong></a>.</p>
<p>At a very basic level, this means that <code>slice()</code> can straightforwardly replicate the behavior of some dplyr verbs like <code>arrange()</code> and <code>filter()</code>!</p>
<h4 id="slice-as-arrange"><code>slice()</code> as <code>arrange()</code></h4>
<p>From our <code>starwars_sm</code> data, if we want to sort by <code>height</code> we can use <code>arrange()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>height</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 R2-D2                  96    32
   2 R5-D4                  97    32
   3 Leia Organa           150    49
   4 Beru Whitesun lars    165    75
   5 C-3PO                 167    75
   6 Luke Skywalker        172    77
   7 Owen Lars             178   120
   8 Obi-Wan Kenobi        182    77
   9 Biggs Darklighter     183    84
  10 Darth Vader           202   136</code></pre>
</div>
<p>But we can also do this with <code>slice()</code> to the same effect, using <code>order()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>height</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 R2-D2                  96    32
   2 R5-D4                  97    32
   3 Leia Organa           150    49
   4 Beru Whitesun lars    165    75
   5 C-3PO                 167    75
   6 Luke Skywalker        172    77
   7 Owen Lars             178   120
   8 Obi-Wan Kenobi        182    77
   9 Biggs Darklighter     183    84
  10 Darth Vader           202   136</code></pre>
</div>
<p>This is conceptually equivalent to combining the following 2-step process:</p>
<ol type="1">
<li><div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ordered_val_ind</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>starwars_sm</span><span class='op'>$</span><span class='va'>height</span><span class='op'>)</span></span>
  <span><span class='va'>ordered_val_ind</span></span></code></pre>
</div>
<pre><code>   [1]  3  8  5  7  2  1  6 10  9  4</code></pre>
</div></li>
<li><div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
  <span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='va'>ordered_val_ind</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 R2-D2                  96    32
   2 R5-D4                  97    32
   3 Leia Organa           150    49
   4 Beru Whitesun lars    165    75
   5 C-3PO                 167    75
   6 Luke Skywalker        172    77
   7 Owen Lars             178   120
   8 Obi-Wan Kenobi        182    77
   9 Biggs Darklighter     183    84
  10 Darth Vader           202   136</code></pre>
</div></li>
</ol>
<h4 id="slice-as-filter"><code>slice()</code> as <code>filter()</code></h4>
<p>We can also use <code>slice()</code> to <code>filter()</code>, using <code>which()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span></span>
<span>  <span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span> <span class='va'>height</span> <span class='op'>&gt;</span> <span class='fl'>150</span> <span class='op'>)</span>,</span>
<span>  <span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>height</span> <span class='op'>&gt;</span> <span class='fl'>150</span><span class='op'>)</span> <span class='op'>)</span></span>
<span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] TRUE</code></pre>
</div>
<p>Thus, we can think of <code>filter()</code> and <code>slice()</code> as two sides of the same coin:</p>
<ul>
<li><p><code>filter()</code> takes a logical vector that’s the same length as the number of rows in the data frame</p></li>
<li><p><code>slice()</code> takes an integer vector that’s a (sub)set of a data frame’s row indices.</p></li>
</ul>
<p>To put it more concretely, this logical vector was being passed to the above <code>filter()</code> call:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span><span class='op'>$</span><span class='va'>height</span> <span class='op'>&gt;</span> <span class='fl'>150</span></span></code></pre>
</div>
<pre><code>   [1]  TRUE  TRUE FALSE  TRUE FALSE  TRUE  TRUE FALSE  TRUE  TRUE</code></pre>
</div>
<p>While this integer vector was being passed to the above <code>slice()</code> call, where <code>which()</code> returns the position of <code>TRUE</code> values, given a logical vector:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span> <span class='va'>starwars_sm</span><span class='op'>$</span><span class='va'>height</span> <span class='op'>&gt;</span> <span class='fl'>150</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1]  1  2  4  6  7  9 10</code></pre>
</div>
<h3 id="special-properties-of-slice">Special properties of <code>slice()</code></h3>
<p>This re-imagined <code>slice()</code> that heavily exploits data-masking gives us two interesting properties:</p>
<ol type="1">
<li><p>We can work with <strong>sets</strong> of row indices that need not to be the same length as the data frame (vs. <code>filter()</code>).</p></li>
<li><p>We can work with row indices as <strong>integers</strong>, which are legible to arithmetic operations (ex: <code>+</code> and <code>*</code>)</p></li>
</ol>
<p>To grok the significance of working with rows as <strong>integer sets</strong>, let’s work through some examples where <code>slice()</code> comes in very handy.</p>
<h2 id="a-gallery-of-row-operations-with-slice">A gallery of row operations with <code>slice()</code></h2>
<h3 id="repeat-rows-in-place">Repeat rows (in place)</h3>
<p>In <code>{tidyr}</code>, there’s a function called <code>uncount()</code> which does the opposite of <code>dplyr::count()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyr.tidyverse.org'>tidyr</a></span><span class='op'>)</span></span>
<span><span class='co'># Example from `tidyr::uncount()` docs</span></span>
<span><span class='va'>uncount_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"a"</span>, <span class='st'>"b"</span><span class='op'>)</span>, n <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>uncount_df</span></span></code></pre>
</div>
<pre><code>  # A tibble: 2 × 2
    x         n
    &lt;chr&gt; &lt;dbl&gt;
  1 a         1
  2 b         2</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>uncount_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/uncount.html'>uncount</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 3 × 1
    x    
    &lt;chr&gt;
  1 a    
  2 b    
  3 b</code></pre>
</div>
<p>We can mimic this behavior with <code>slice()</code>, using <code>rep(times = ...)</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>uncount_df</span><span class='op'>)</span>, times <span class='op'>=</span> <span class='va'>uncount_df</span><span class='op'>$</span><span class='va'>n</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] 1 2 2</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>uncount_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span>, times <span class='op'>=</span> <span class='va'>n</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span> <span class='op'>-</span><span class='va'>n</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 3 × 1
    x    
    &lt;chr&gt;
  1 a    
  2 b    
  3 b</code></pre>
</div>
<p>What if instead of a whole column storing that information, we only have information about row position?</p>
<p>Let’s say we want to duplicate the rows of <code>starwars_sm</code> at the <code>repeat_at</code> positions:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>repeat_at</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fl'>5</span>, <span class='fl'>2</span><span class='op'>)</span></span>
<span><span class='va'>repeat_at</span></span></code></pre>
</div>
<pre><code>  [1] 4 5</code></pre>
</div>
<p>In <code>slice()</code>, you’d just select all rows plus those additional rows, then sort the integer row indices:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='va'>repeat_at</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 12 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 Luke Skywalker        172    77
   2 C-3PO                 167    75
   3 R2-D2                  96    32
   4 Darth Vader           202   136
   5 Darth Vader           202   136
   6 Leia Organa           150    49
   7 Leia Organa           150    49
   8 Owen Lars             178   120
   9 Beru Whitesun lars    165    75
  10 R5-D4                  97    32
  11 Biggs Darklighter     183    84
  12 Obi-Wan Kenobi        182    77</code></pre>
</div>
<p>What if we also separately have information about how much to repeat those rows by?</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>repeat_by</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>3</span>, <span class='fl'>4</span><span class='op'>)</span></span></code></pre>
</div>
</div>
<p>You can apply the same <code>rep()</code> method for just the subset of rows to repeat:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='va'>repeat_at</span>, times <span class='op'>=</span> <span class='va'>repeat_by</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 15 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 Luke Skywalker        172    77
   2 C-3PO                 167    75
   3 R2-D2                  96    32
   4 Darth Vader           202   136
   5 Darth Vader           202   136
   6 Darth Vader           202   136
   7 Leia Organa           150    49
   8 Leia Organa           150    49
   9 Leia Organa           150    49
  10 Leia Organa           150    49
  11 Owen Lars             178   120
  12 Beru Whitesun lars    165    75
  13 R5-D4                  97    32
  14 Biggs Darklighter     183    84
  15 Obi-Wan Kenobi        182    77</code></pre>
</div>
<p>Circling back to <code>uncount()</code>, you could also initialize a vector of <code>1s</code> and <code>replace()</code> where the rows should be repeated:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>starwars_sm</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/uncount.html'>uncount</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/replace.html'>replace</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>, <span class='va'>repeat_at</span>, <span class='va'>repeat_by</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 15 × 3
     name               height  mass
     &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
   1 Luke Skywalker        172    77
   2 C-3PO                 167    75
   3 R2-D2                  96    32
   4 Darth Vader           202   136
   5 Darth Vader           202   136
   6 Darth Vader           202   136
   7 Leia Organa           150    49
   8 Leia Organa           150    49
   9 Leia Organa           150    49
  10 Leia Organa           150    49
  11 Owen Lars             178   120
  12 Beru Whitesun lars    165    75
  13 R5-D4                  97    32
  14 Biggs Darklighter     183    84
  15 Obi-Wan Kenobi        182    77</code></pre>
</div>
<h3 id="subset-a-selection-of-rows-the-following-row">Subset a selection of rows + the following row</h3>
<p>Row order can sometimes encode a meaningful continuous measure, like time.</p>
<p>Take for example this subset of the <code>flights</code> dataset in <code>{nycflights13}</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>&lt;-</span> <span class='fu'>nycflights13</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/pkg/nycflights13/man/flights.html'>flights</a></span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>month</span> <span class='op'>==</span> <span class='fl'>3</span>, <span class='va'>day</span> <span class='op'>==</span> <span class='fl'>3</span>, <span class='va'>origin</span> <span class='op'>==</span> <span class='st'>"JFK"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>dep_time</span>, <span class='va'>flight</span>, <span class='va'>carrier</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>dep_time</span><span class='op'>)</span></span>
<span><span class='va'>flights_df</span></span></code></pre>
</div>
<pre><code>  # A tibble: 100 × 3
     dep_time flight carrier
        &lt;int&gt;  &lt;int&gt; &lt;chr&gt;  
   1      535   1141 AA     
   2      551   5716 EV     
   3      555    145 B6     
   4      556    208 B6     
   5      556     79 B6     
   6      601    501 B6     
   7      604    725 B6     
   8      606    135 B6     
   9      606    600 UA     
  10      607    829 US     
  # ℹ 90 more rows</code></pre>
</div>
<p>Here, the rows are ordered by <code>dep_time</code>, such that given a row, the next row is a data point for the next flight that departed from the airport.</p>
<p>And let’s say we’re interested in flights that took off immediately after American Airlines (<code>"AA"</code>) flights. Given what we just noted about the ordering of rows in the data frame, we can do this in <code>slice()</code> by adding <code>1</code> to the row index of AA flights:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 14 × 3
     dep_time flight carrier
        &lt;int&gt;  &lt;int&gt; &lt;chr&gt;  
   1      551   5716 EV     
   2      627    905 B6     
   3      652    117 B6     
   4      714    825 AA     
   5      717    987 B6     
   6      724     11 VX     
   7      742    183 DL     
   8      802    655 AA     
   9      805   2143 DL     
  10      847     59 B6     
  11      858    647 AA     
  12      859    120 DL     
  13     1031    179 AA     
  14     1036    641 B6</code></pre>
</div>
<p>What if we also want to keep observations for the preceding AA flights as well? We can just stick <code>which(carrier == "AA")</code> inside <code>slice()</code> too:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 28 × 3
     dep_time flight carrier
        &lt;int&gt;  &lt;int&gt; &lt;chr&gt;  
   1      535   1141 AA     
   2      626    413 AA     
   3      652   1815 AA     
   4      711    443 AA     
   5      714    825 AA     
   6      724     33 AA     
   7      739     59 AA     
   8      802   1838 AA     
   9      802    655 AA     
  10      843   1357 AA     
  # ℹ 18 more rows</code></pre>
</div>
<p>But now the rows are now ordered such that all the AA flights come before the other flights! How can we preserve the original order of increasing <code>dep_time</code>?</p>
<p>We <em>could</em> reconstruct the initial row order by piping the result into <code>arrange(dep_time)</code> again, but the simplest solution would be to concatenate the set of row indices and <code>sort()</code> them, since the output of <code>which()</code> is already integer!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>,</span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span></span>
<span>    <span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 28 × 3
     dep_time flight carrier
        &lt;int&gt;  &lt;int&gt; &lt;chr&gt;  
   1      535   1141 AA     
   2      551   5716 EV     
   3      626    413 AA     
   4      627    905 B6     
   5      652   1815 AA     
   6      652    117 B6     
   7      711    443 AA     
   8      714    825 AA     
   9      714    825 AA     
  10      717    987 B6     
  # ℹ 18 more rows</code></pre>
</div>
<p>Notice how the 8th and 9th rows are repeated here - that’s because 2 AA flights departed in a row (ha!). We can use <code>unique()</code> to remove duplicate rows in the same call to <code>slice()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>,</span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span></span>
<span>    <span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 24 × 3
     dep_time flight carrier
        &lt;int&gt;  &lt;int&gt; &lt;chr&gt;  
   1      535   1141 AA     
   2      551   5716 EV     
   3      626    413 AA     
   4      627    905 B6     
   5      652   1815 AA     
   6      652    117 B6     
   7      711    443 AA     
   8      714    825 AA     
   9      717    987 B6     
  10      724     33 AA     
  # ℹ 14 more rows</code></pre>
</div>
<p>Importantly, we can do all of this inside <code>slice()</code> because we’re working with <strong>integer sets</strong>. The <strong>integer</strong> part allows us to do things like <code>+ 1</code> and <code>sort()</code>, while the <strong>set</strong> part allows us to combine with <code>c()</code> and remove duplicates with <code>unique()</code>.</p>
<h3 id="subset-a-selection-of-rows-multiple-following-rows">Subset a selection of rows + multiple following rows</h3>
<p>In this example, let’s problematize our approach with the repeated <code>which()</code> calls in our previous solution.</p>
<p>Imagine another scenario where we want to filter for all AA flights and <em>three</em> subsequent flights for each.</p>
<p>Do we need to write the solution out like this? That’s a lot of repetition!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>2</span>,</span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>3</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
</div>
<p>You might think we can get away with <code>+ 0:3</code>, but it doesn’t work as we’d like. The <code>+</code> just forces <code>0:3</code> to be (partially) recycled to the same length as <code>carrier</code> for element-wise addition:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>0</span><span class='op'>:</span><span class='fl'>3</span></span></code></pre>
</div>
<pre><code>  Warning in which(flights_df$carrier == &quot;AA&quot;) + 0:3: longer object length is not
  a multiple of shorter object length</code></pre>
<pre><code>   [1]  1 14 20 27 25 28 34 40 38 62 66 68 91 93</code></pre>
</div>
<p>If only we can get the <strong>outer</strong> sum of the two arrays, <code>0:3</code> and <code>which(carrier == "AA")</code> … Oh wait, we can - that’s what <code>outer()</code> does!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>:</span><span class='fl'>3</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>, <span class='va'>`+`</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]
  [1,]    1   13   18   24   25   27   32   37   38    61    64    65    91    92
  [2,]    2   14   19   25   26   28   33   38   39    62    65    66    92    93
  [3,]    3   15   20   26   27   29   34   39   40    63    66    67    93    94
  [4,]    4   16   21   27   28   30   35   40   41    64    67    68    94    95</code></pre>
</div>
<p>This is essentially the repeated <code>which()</code> vectors stacked on top of each other, but as a matrix:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>     <span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span> <span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>2</span> <span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>3</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>   [1]  1 13 18 24 25 27 32 37 38 61 64 65 91 92
   [1]  2 14 19 25 26 28 33 38 39 62 65 66 92 93
   [1]  3 15 20 26 27 29 34 39 40 63 66 67 93 94
   [1]  4 16 21 27 28 30 35 40 41 64 67 68 94 95</code></pre>
</div>
<p>The fact that <code>outer()</code> returns all the relevant row indices inside a single matrix is nice because we can collect the indices column-by-column, preserving row order. Matrices, like data frames, are <strong>column-major</strong>, so coercing a matrix to a vector collapses it column-wise:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>:</span><span class='fl'>3</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>, <span class='va'>`+`</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>   [1]  1  2  3  4 13 14 15 16 18 19 20 21 24 25 26 27 25 26 27 28 27 28 29 30 32
  [26] 33 34 35 37 38 39 40 38 39 40 41 61 62 63 64 64 65 66 67 65 66 67 68 91 92
  [51] 93 94 92 93 94 95</code></pre>
</div>
<details>
<summary>
Other ways to coerce matrix to vector
</summary>
<p>There are two other options for coercing a matrix to vector - <code>c()</code> and <code>as.vector()</code>. I like to stick with <code>as.integer()</code> because that enforces integer type (which makes sense for row indices), and <code>c()</code> can be nice because it’s less to type (although it’s <a href="https://youtu.be/izFssYRsLZs?t=1143">off-label usage</a>):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='co'># Not run, but equivalent to `as.integer()` method</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/vector.html'>as.vector</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>:</span><span class='fl'>3</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>, <span class='va'>`+`</span><span class='op'>)</span> <span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>:</span><span class='fl'>3</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>flights_df</span><span class='op'>$</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>, <span class='va'>`+`</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
</div>
<p>Somewhat relatedly - and this only works inside the tidy-eval context of <code>slice()</code> - you can get a similar effect of “collapsing” a matrix using the <a href="https://rlang.r-lib.org/reference/topic-inject.html#splicing-with-">splice operator</a> <code>!!!</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>seq_matrix</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>9</span>, byrow <span class='op'>=</span> <span class='cn'>TRUE</span>, nrow <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>seq_matrix</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] 1 4 7 2 5 8 3 6 9</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span></span>
<span>  <span class='va'>mtcars</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>as.vector</a></span><span class='op'>(</span><span class='va'>seq_matrix</span><span class='op'>)</span> <span class='op'>)</span>,</span>
<span>  <span class='va'>mtcars</span> <span class='op'>|&gt;</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='op'>!</span><span class='op'>!</span><span class='op'>!</span><span class='va'>seq_matrix</span> <span class='op'>)</span></span>
<span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] TRUE</code></pre>
</div>
<p>Here, the <code>!!!seq_matrix</code> was slotting each individual “cell” as argument to <code>slice()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/expr.html'>expr</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='op'>!</span><span class='op'>!</span><span class='op'>!</span><span class='va'>seq_matrix</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  slice(1L, 4L, 7L, 2L, 5L, 8L, 3L, 6L, 9L)</code></pre>
</div>
<p>A big difference in behavior between <code>as.integer()</code> vs. <code>!!!</code> is that the latter works for <strong>lists</strong> of indices too, by slotting each element of the list as an argument to <code>slice()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>seq_list</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>4</span>, <span class='fl'>7</span>, <span class='fl'>2</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>5</span>, <span class='fl'>8</span>, <span class='fl'>3</span>, <span class='fl'>6</span>, <span class='fl'>9</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/expr.html'>expr</a></span><span class='op'>(</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='op'>!</span><span class='op'>!</span><span class='op'>!</span><span class='va'>seq_list</span> <span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  slice(c(1, 4, 7, 2), c(5, 8, 3, 6, 9))</code></pre>
</div>
<p>However, as you may already know, <code>as.integer()</code> cannot flatten lists:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>seq_list</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  Error in eval(expr, envir, enclos): &#39;list&#39; object cannot be coerced to type &#39;integer&#39;</code></pre>
</div>
<p>Note that <code>as.vector()</code> and <code>c()</code> leaves lists <em>as is</em>, which is another reason to prefer <code>as.integer()</code> for type-checking:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='va'>seq_list</span>, <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>as.vector</a></span><span class='op'>(</span><span class='va'>seq_list</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='va'>seq_list</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>seq_list</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] TRUE
  [1] TRUE</code></pre>
</div>
<p>Finally, back in our <code>!!!seq_matrix</code> example, we could have applied <code>asplit(MARGIN = 2)</code> to chunk the splicing by <em>matrix column</em>, although the overall effect would be the same:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/expr.html'>expr</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='op'>!</span><span class='op'>!</span><span class='op'>!</span><span class='va'>seq_matrix</span>            <span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  slice(1L, 4L, 7L, 2L, 5L, 8L, 3L, 6L, 9L)</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'>rlang</span><span class='fu'>::</span><span class='fu'><a href='https://rlang.r-lib.org/reference/expr.html'>expr</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='op'>!</span><span class='op'>!</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/asplit.html'>asplit</a></span><span class='op'>(</span><span class='va'>seq_matrix</span>, <span class='fl'>2</span><span class='op'>)</span> <span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  slice(c(1L, 4L, 7L), c(2L, 5L, 8L), c(3L, 6L, 9L))</code></pre>
</div>
</details>
<p>This lets us ask questions like: Which AA flights departed within 3 flights of another AA flight?</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>:</span><span class='fl'>3</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>, <span class='va'>`+`</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span> <span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span>, <span class='fu'><a href='https://rdrr.io/r/base/duplicated.html'>duplicated</a></span><span class='op'>(</span><span class='va'>flight</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/distinct.html'>distinct</a></span><span class='op'>(</span><span class='va'>flight</span>, <span class='va'>carrier</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 2
    flight carrier
     &lt;int&gt; &lt;chr&gt;  
  1    825 AA     
  2     33 AA     
  3    655 AA     
  4      1 AA     
  5    647 AA     
  6    179 AA</code></pre>
</div>
<details>
<summary>
Slicing all the way down: Case 1
</summary>
<p>With the addition of the <code>.by</code> argument to <code>slice()</code> in <a href="https://www.tidyverse.org/blog/2023/02/dplyr-1-1-0-per-operation-grouping/">dplyr v1.10</a>, we can re-write the above code as three calls to <code>slice()</code> (+ a call to <code>select()</code>):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>flights_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='fl'>0</span><span class='op'>:</span><span class='fl'>3</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span><span class='op'>)</span>, <span class='va'>`+`</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>carrier</span> <span class='op'>==</span> <span class='st'>"AA"</span> <span class='op'>&amp;</span> <span class='fu'><a href='https://rdrr.io/r/base/duplicated.html'>duplicated</a></span><span class='op'>(</span><span class='va'>flight</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span>  <span class='co'># filter()</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fl'>1</span>, .by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>flight</span>, <span class='va'>carrier</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span>                  <span class='co'># distinct()</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>flight</span>, <span class='va'>carrier</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 2
    flight carrier
     &lt;int&gt; &lt;chr&gt;  
  1    825 AA     
  2     33 AA     
  3    655 AA     
  4      1 AA     
  5    647 AA     
  6    179 AA</code></pre>
</div>
</details>
<p>The next example will demonstrate another, perhaps more practical usecase for <code>outer()</code> in <code>slice()</code>.</p>
<h3 id="filter-and-encode-neighboring-rows">Filter (and encode) neighboring rows</h3>
<p>Let’s use a subset of the <code>{gapminder}</code> data set for this one. Here, we have data for each European country’s GDP-per-capita by year, between 1992 to 2007:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_df</span> <span class='op'>&lt;-</span> <span class='fu'>gapminder</span><span class='fu'>::</span><span class='va'><a href='https://jennybc.github.io/gapminder/reference/gapminder.html'>gapminder</a></span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='fu'>gapminder</span><span class='fu'>::</span><span class='va'><a href='https://jennybc.github.io/gapminder/reference/country_codes.html'>country_codes</a></span>, by <span class='op'>=</span> <span class='st'>"country"</span><span class='op'>)</span> <span class='op'>|&gt;</span>  <span class='co'># `multiple = "all"`</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>year</span> <span class='op'>&gt;=</span> <span class='fl'>1992</span>, <span class='va'>continent</span> <span class='op'>==</span> <span class='st'>"Europe"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>country</span>, country_code <span class='op'>=</span> <span class='va'>iso_alpha</span>, <span class='va'>year</span>, <span class='va'>gdpPercap</span><span class='op'>)</span></span>
<span><span class='va'>gapminder_df</span></span></code></pre>
</div>
<pre><code>  # A tibble: 120 × 4
     country country_code  year gdpPercap
     &lt;chr&gt;   &lt;chr&gt;        &lt;int&gt;     &lt;dbl&gt;
   1 Albania ALB           1992     2497.
   2 Albania ALB           1997     3193.
   3 Albania ALB           2002     4604.
   4 Albania ALB           2007     5937.
   5 Austria AUT           1992    27042.
   6 Austria AUT           1997    29096.
   7 Austria AUT           2002    32418.
   8 Austria AUT           2007    36126.
   9 Belgium BEL           1992    25576.
  10 Belgium BEL           1997    27561.
  # ℹ 110 more rows</code></pre>
</div>
<p>This time, let’s see the desired output (plot) first and build our way up. The goal is to plot the GDP growth of Germany over the years, <em>and</em> its yearly <strong>GDP neighbors</strong> side-by-side:</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="row-relational-operations_files/figure-html5/final-gapminder-plot-1.png" width="624" /></p>
</div>
<p>First, let’s think about what a “GDP neighbor” means in row-relational terms. If you arranged the data by GDP, the GDP neighbors would be the rows that come immediately before and after the rows for Germany. You need to recalculate neighbors every year though, so this <code>arrange()</code> + <code>slice()</code> combo should happen by-year.</p>
<p>With that in mind, let’s set up a <code>year</code> grouping and arrange by <code>gdpPercap</code> within <code>year</code>:<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>gdpPercap</span>, .by_group <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 120 × 4
  # Groups:   year [4]
     country                country_code  year gdpPercap
     &lt;chr&gt;                  &lt;chr&gt;        &lt;int&gt;     &lt;dbl&gt;
   1 Albania                ALB           1992     2497.
   2 Bosnia and Herzegovina BIH           1992     2547.
   3 Turkey                 TUR           1992     5678.
   4 Bulgaria               BGR           1992     6303.
   5 Romania                ROU           1992     6598.
   6 Montenegro             MNE           1992     7003.
   7 Poland                 POL           1992     7739.
   8 Croatia                HRV           1992     8448.
   9 Serbia                 SRB           1992     9325.
  10 Slovak Republic        SVK           1992     9498.
  # ℹ 110 more rows</code></pre>
</div>
<p>Now within each year, we want to grab the row for Germany <em>and</em> its neighboring rows. We can do this by taking the <code>outer()</code> sum of <code>-1:1</code> and the row indices for Germany:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>gdpPercap</span>, .by_group <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>"Germany"</span><span class='op'>)</span>, <span class='va'>`+`</span> <span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 12 × 4
  # Groups:   year [4]
     country        country_code  year gdpPercap
     &lt;chr&gt;          &lt;chr&gt;        &lt;int&gt;     &lt;dbl&gt;
   1 Denmark        DNK           1992    26407.
   2 Germany        DEU           1992    26505.
   3 Netherlands    NLD           1992    26791.
   4 Belgium        BEL           1997    27561.
   5 Germany        DEU           1997    27789.
   6 Iceland        ISL           1997    28061.
   7 United Kingdom GBR           2002    29479.
   8 Germany        DEU           2002    30036.
   9 Belgium        BEL           2002    30486.
  10 France         FRA           2007    30470.
  11 Germany        DEU           2007    32170.
  12 United Kingdom GBR           2007    33203.</code></pre>
</div>
<details>
<summary>
Slicing all the way down: Case 2
</summary>
<p>The new <code>.by</code> argument in <code>slice()</code> comes in handy again here, allowing us to collapse the <code>group_by()</code> + <code>arrange()</code> combo into one <code>slice()</code> call:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>gdpPercap</span><span class='op'>)</span>, .by <span class='op'>=</span> <span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>"Germany"</span><span class='op'>)</span>, <span class='va'>`+`</span> <span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 12 × 4
     country        country_code  year gdpPercap
     &lt;chr&gt;          &lt;chr&gt;        &lt;int&gt;     &lt;dbl&gt;
   1 Denmark        DNK           1992    26407.
   2 Germany        DEU           1992    26505.
   3 Netherlands    NLD           1992    26791.
   4 Belgium        BEL           1997    27561.
   5 Germany        DEU           1997    27789.
   6 Iceland        ISL           1997    28061.
   7 United Kingdom GBR           2002    29479.
   8 Germany        DEU           2002    30036.
   9 Belgium        BEL           2002    30486.
  10 France         FRA           2007    30470.
  11 Germany        DEU           2007    32170.
  12 United Kingdom GBR           2007    33203.</code></pre>
</div>
For our purposes here we want actually the grouping to <strong>persist</strong> for the following <code>mutate()</code> call, but there may be other cases where you’d want to use <code>slice(.by = )</code> for temporary grouping.
</details>
<p>Now we’re already starting to see the shape of the data that we want! The last step is to encode the relationship of each row to Germany - does a row represent Germany itself, or a country that’s one GDP ranking below or above Germany?</p>
<p>Continuing with our grouped context, we make a new column <code>grp</code> that assigns a factor value <code>"lo"</code>-<code>"is"</code>-<code>"hi"</code> (for “lower” than Germany, “is” Germany and “higher” than Germany) to each country trio by year. Notice the use of <code>fct_inorder()</code> below - this ensures that the factor levels are in the order of their occurrence (necessary for the correct ordering of bars in <code>geom_col()</code> later):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>gdpPercap</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>"Germany"</span><span class='op'>)</span>, <span class='va'>`+`</span> <span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>grp <span class='op'>=</span> <span class='fu'>forcats</span><span class='fu'>::</span><span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_inorder.html'>fct_inorder</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"lo"</span>, <span class='st'>"is"</span>, <span class='st'>"hi"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 12 × 5
  # Groups:   year [4]
     country        country_code  year gdpPercap grp  
     &lt;chr&gt;          &lt;chr&gt;        &lt;int&gt;     &lt;dbl&gt; &lt;fct&gt;
   1 Denmark        DNK           1992    26407. lo   
   2 Germany        DEU           1992    26505. is   
   3 Netherlands    NLD           1992    26791. hi   
   4 Belgium        BEL           1997    27561. lo   
   5 Germany        DEU           1997    27789. is   
   6 Iceland        ISL           1997    28061. hi   
   7 United Kingdom GBR           2002    29479. lo   
   8 Germany        DEU           2002    30036. is   
   9 Belgium        BEL           2002    30486. hi   
  10 France         FRA           2007    30470. lo   
  11 Germany        DEU           2007    32170. is   
  12 United Kingdom GBR           2007    33203. hi</code></pre>
</div>
<p>We now have everything that’s necessary to make our desired plot, so we <code>ungroup()</code>, write some <code>{ggplot2}</code> code, and voila!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>gdpPercap</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>"Germany"</span><span class='op'>)</span>, <span class='va'>`+`</span> <span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>grp <span class='op'>=</span> <span class='fu'>forcats</span><span class='fu'>::</span><span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_inorder.html'>fct_inorder</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"lo"</span>, <span class='st'>"is"</span>, <span class='st'>"hi"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='co'># Ungroup and make ggplot</span></span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span>, <span class='va'>gdpPercap</span>, group <span class='op'>=</span> <span class='va'>grp</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_col</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='va'>grp</span> <span class='op'>==</span> <span class='st'>"is"</span><span class='op'>)</span>, position <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/position_dodge.html'>position_dodge</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label <span class='op'>=</span> <span class='va'>country_code</span><span class='op'>)</span>,</span>
<span>    vjust <span class='op'>=</span> <span class='fl'>1.3</span>,</span>
<span>    position <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/position_dodge.html'>position_dodge</a></span><span class='op'>(</span>width <span class='op'>=</span> <span class='fl'>.9</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_fill_manual</a></span><span class='op'>(</span></span>
<span>    values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"grey75"</span>, <span class='st'>"steelblue"</span><span class='op'>)</span>,</span>
<span>    guide <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_none.html'>guide_none</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_classic</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span></span>
<span>  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>"Year"</span>, y <span class='op'>=</span> <span class='st'>"GDP per capita"</span><span class='op'>)</span></span></code></pre>
</div>
<p><img src="row-relational-operations_files/figure-html5/final-gapminder-plot-1.png" width="624" /></p>
</div>
<details>
<summary>
Solving the harder version of the problem
</summary>
<p>The solution presented above relies on a fragile assumption that Germany will always have a higher <em>and</em> lower ranking GDP neighbor every year. But nothing about the problem description guarantees this, so how can we re-write our code to be more robust?</p>
<p>First, let’s simulate a data where Germany is the lowest ranking country in 2002 and the highest ranking in 2007. In other words, Germany only has one GDP neighbor in those years:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_harder_df</span> <span class='op'>&lt;-</span> <span class='va'>gapminder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/order.html'>order</a></span><span class='op'>(</span><span class='va'>gdpPercap</span><span class='op'>)</span>, .by <span class='op'>=</span> <span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span> <span class='op'>-</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>"Germany"</span><span class='op'>)</span>, <span class='va'>`+`</span> <span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='op'>-</span><span class='fl'>7</span>, <span class='op'>-</span><span class='fl'>12</span> <span class='op'>)</span></span>
<span><span class='va'>gapminder_harder_df</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 4
     country     country_code  year gdpPercap
     &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;     &lt;dbl&gt;
   1 Denmark     DNK           1992    26407.
   2 Germany     DEU           1992    26505.
   3 Netherlands NLD           1992    26791.
   4 Belgium     BEL           1997    27561.
   5 Germany     DEU           1997    27789.
   6 Iceland     ISL           1997    28061.
   7 Germany     DEU           2002    30036.
   8 Belgium     BEL           2002    30486.
   9 France      FRA           2007    30470.
  10 Germany     DEU           2007    32170.</code></pre>
</div>
<p>Given this data, we cannot assign the full, length-3 lo-is-hi factor by group, because the groups for year 2002 and 2007 only have 2 observations:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_harder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>grp <span class='op'>=</span> <span class='fu'>forcats</span><span class='fu'>::</span><span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_inorder.html'>fct_inorder</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"lo"</span>, <span class='st'>"is"</span>, <span class='st'>"hi"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  Error in `mutate()`:
  ℹ In argument: `grp = forcats::fct_inorder(c(&quot;lo&quot;, &quot;is&quot;, &quot;hi&quot;))`.
  ℹ In group 3: `year = 2002`.
  Caused by error:
  ! `grp` must be size 2 or 1, not 3.</code></pre>
</div>
<p>The trick here is to turn each group of rows into an integer sequence where Germany is “anchored” to 2, and then use that vector to subset the lo-is-hi factor:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>gapminder_harder_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    Germany_anchored_to_2 <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>"Germany"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>2</span>,</span>
<span>    grp <span class='op'>=</span> <span class='fu'>forcats</span><span class='fu'>::</span><span class='fu'><a href='https://forcats.tidyverse.org/reference/fct_inorder.html'>fct_inorder</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"lo"</span>, <span class='st'>"is"</span>, <span class='st'>"hi"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>[</span><span class='va'>Germany_anchored_to_2</span><span class='op'>]</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 6
  # Groups:   year [4]
     country     country_code  year gdpPercap Germany_anchored_to_2 grp  
     &lt;chr&gt;       &lt;chr&gt;        &lt;int&gt;     &lt;dbl&gt;                 &lt;dbl&gt; &lt;fct&gt;
   1 Denmark     DNK           1992    26407.                     1 lo   
   2 Germany     DEU           1992    26505.                     2 is   
   3 Netherlands NLD           1992    26791.                     3 hi   
   4 Belgium     BEL           1997    27561.                     1 lo   
   5 Germany     DEU           1997    27789.                     2 is   
   6 Iceland     ISL           1997    28061.                     3 hi   
   7 Germany     DEU           2002    30036.                     2 is   
   8 Belgium     BEL           2002    30486.                     3 hi   
   9 France      FRA           2007    30470.                     1 lo   
  10 Germany     DEU           2007    32170.                     2 is</code></pre>
</div>
<p>We find that the lessons of working with row indices from <code>slice()</code> translated to solving this complex <code>mutate()</code> problem - neat!</p>
</details>
<h3 id="windowed-minmaxmedian-etc.">Windowed min/max/median (etc.)</h3>
<p>Let’s say we have this small time series data, and we want to calculate a <strong>lagged 3-window moving minimum</strong> for the <code>val</code> column:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ts_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  time <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>6</span>,</span>
<span>  val <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>6</span> <span class='op'>*</span> <span class='fl'>10</span><span class='op'>)</span></span>
<span><span class='op'>)</span></span>
<span><span class='va'>ts_df</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 2
     time   val
    &lt;int&gt; &lt;dbl&gt;
  1     1    50
  2     2    40
  3     3    60
  4     4    30
  5     5    20
  6     6    10</code></pre>
</div>
<p>If you’re new to window functions, think of them as a special kind of <code>group_by()</code> + <code>summarize()</code> where groups are chunks of observations along a (typically unique) continuous measure like time, and observations can be shared between groups.</p>
<p>There are several packages implementing moving/sliding/rolling window functions. My current favorite is <code>{r2c}</code> (see a <a href="https://github.com/brodieG/r2c#fast-group-and-rolling-statistics">review of other implementations therein</a>), but I also like <code>{slider}</code> for an implementation that follows familiar <a href="https://design.tidyverse.org/">“tidy” design principles</a>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/r-lib/slider'>slider</a></span><span class='op'>)</span></span>
<span><span class='va'>ts_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>moving_min <span class='op'>=</span> <span class='fu'><a href='https://slider.r-lib.org/reference/summary-slide.html'>slide_min</a></span><span class='op'>(</span><span class='va'>val</span>, before <span class='op'>=</span> <span class='fl'>2L</span>, complete <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 3
     time   val moving_min
    &lt;int&gt; &lt;dbl&gt;      &lt;dbl&gt;
  1     1    50         NA
  2     2    40         NA
  3     3    60         40
  4     4    30         30
  5     5    20         20
  6     6    10         10</code></pre>
</div>
<p>Moving window is a general class of operations that encompass any arbitrary summary statistic - so not just min but other reducing functions like mean, standard deviation, etc. But what makes moving <strong>min</strong> (along with max, median, etc.) a particularly interesting case for our current discussion is that the value comes from <strong>an existing observation</strong> in the data. And if our time series is tidy, every observation makes up a row. See where I’m going with this?</p>
<p>Using <code>outer()</code> again, we can take the outer sum of all row indices of <code>ts_df</code> and <code>-2:0</code>. This gives us a matrix where each column represents a lagged size-3 moving window:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>windows_3lag</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>2</span><span class='op'>:</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>ts_df</span><span class='op'>)</span>, <span class='st'>"+"</span><span class='op'>)</span></span>
<span><span class='va'>windows_3lag</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4] [,5] [,6]
  [1,]   -1    0    1    2    3    4
  [2,]    0    1    2    3    4    5
  [3,]    1    2    3    4    5    6</code></pre>
</div>
<p>The “lagged size-3” property of this moving window means that the first two windows are incomplete (consisting of less than 3 observations). We want to treat those as invalid, so we can drop the first two columns from our matrix:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>windows_3lag</span><span class='op'>[</span>,<span class='op'>-</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4]
  [1,]    1    2    3    4
  [2,]    2    3    4    5
  [3,]    3    4    5    6</code></pre>
</div>
<p>For each remaining column, we want to grab the values of <code>val</code> at the corresponding row indices and find which row has the minimum <code>val</code>. In terms of code, we use <code>apply()</code> with <code>MARGIN = 2L</code> to column-wise apply a function where we use <code>which.min()</code> to find the location of the minimum <code>val</code> and convert it back to row index via subsetting:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>windows_3lag</span><span class='op'>[</span>, <span class='op'>-</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span>MARGIN <span class='op'>=</span> <span class='fl'>2L</span>, \<span class='op'>(</span><span class='va'>i</span><span class='op'>)</span> <span class='va'>i</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/which.min.html'>which.min</a></span><span class='op'>(</span><span class='va'>ts_df</span><span class='op'>$</span><span class='va'>val</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] 2 4 5 6</code></pre>
</div>
<p>Now let’s stick this inside <code>slice()</code>, exploiting the fact that it’s <em>data-masked</em> (<code>ts_df$val</code> can just be <code>val</code>) and exposes <em>context-dependent expressions</em> (<code>1:nrow(ts_df)</code> can just be <code>row_number()</code>):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>moving_mins</span> <span class='op'>&lt;-</span> <span class='va'>ts_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>2</span><span class='op'>:</span><span class='fl'>0</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='st'>"+"</span><span class='op'>)</span><span class='op'>[</span>,<span class='op'>-</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span>MARGIN <span class='op'>=</span> <span class='fl'>2L</span>, \<span class='op'>(</span><span class='va'>i</span><span class='op'>)</span> <span class='va'>i</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/which.min.html'>which.min</a></span><span class='op'>(</span><span class='va'>val</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span><span class='va'>moving_mins</span></span></code></pre>
</div>
<pre><code>  # A tibble: 4 × 2
     time   val
    &lt;int&gt; &lt;dbl&gt;
  1     2    40
  2     4    30
  3     5    20
  4     6    10</code></pre>
</div>
<p>From here, we can grab the <code>val</code> column and pad it with <code>NA</code> to add our desired <code>window_min</code> column to the original data frame:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ts_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>moving_min <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='cn'>NA</span>, <span class='va'>moving_mins</span><span class='op'>$</span><span class='va'>val</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 3
     time   val moving_min
    &lt;int&gt; &lt;dbl&gt;      &lt;dbl&gt;
  1     1    50         NA
  2     2    40         NA
  3     3    60         40
  4     4    30         30
  5     5    20         20
  6     6    10         10</code></pre>
</div>
<p>At this point you might think that this is a very round-about way of solving the same problem. But actually I think that it’s a faster route to solving a slightly more complicated problem - augmenting each observation of a data frame with information about <strong>comparison observations</strong>.</p>
<p>For example, our <code>slice()</code>-based solution sets us up nicely for also bringing along information about the time at which the <code>moving_min</code> occurred. After some <code>rename()</code>-ing and adding the original time information back in, we get back a relational data structure where <code>time</code> is a <strong>key</strong> shared with <code>ts_df</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>moving_mins2</span> <span class='op'>&lt;-</span> <span class='va'>moving_mins</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>moving_min_val <span class='op'>=</span> <span class='va'>val</span>, moving_min_time <span class='op'>=</span> <span class='va'>time</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>time <span class='op'>=</span> <span class='va'>ts_df</span><span class='op'>$</span><span class='va'>time</span><span class='op'>[</span><span class='op'>-</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span>, .before <span class='op'>=</span> <span class='fl'>1L</span><span class='op'>)</span></span>
<span><span class='va'>moving_mins2</span></span></code></pre>
</div>
<pre><code>  # A tibble: 4 × 3
     time moving_min_time moving_min_val
    &lt;int&gt;           &lt;int&gt;          &lt;dbl&gt;
  1     3               2             40
  2     4               4             30
  3     5               5             20
  4     6               6             10</code></pre>
</div>
<p>We can then left-join this to the original data to augment it with information about both the value of the 3-window minimum and the time that the minimum occurred:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>ts_df</span>, <span class='va'>moving_mins2</span>, by <span class='op'>=</span> <span class='st'>"time"</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 4
     time   val moving_min_time moving_min_val
    &lt;int&gt; &lt;dbl&gt;           &lt;int&gt;          &lt;dbl&gt;
  1     1    50              NA             NA
  2     2    40              NA             NA
  3     3    60               2             40
  4     4    30               4             30
  5     5    20               5             20
  6     6    10               6             10</code></pre>
</div>
<p>This is particularly useful if rows contain other useful information for comparison and you have memory to spare:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>ts_wide_df</span> <span class='op'>&lt;-</span> <span class='va'>ts_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span></span>
<span>    col1 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>6</span><span class='op'>)</span>,</span>
<span>    col2 <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>6</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span><span class='va'>ts_wide_df</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 4
     time   val    col1     col2
    &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
  1     1    50  0.0183  0.00501
  2     2    40  0.705  -0.0376 
  3     3    60 -0.647   0.724  
  4     4    30  0.868  -0.497  
  5     5    20  0.376   0.0114 
  6     6    10  0.310   0.00986</code></pre>
</div>
<p>The below code augments each observation in the original <code>ts_wide_df</code> data with information about the corresponding 3-window moving min (columns prefixed with <code>"min3val_"</code>)</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>moving_mins_wide</span> <span class='op'>&lt;-</span> <span class='va'>ts_wide_df</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>2</span><span class='op'>:</span><span class='fl'>0</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span>, <span class='st'>"+"</span><span class='op'>)</span><span class='op'>[</span>,<span class='op'>-</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/apply.html'>apply</a></span><span class='op'>(</span>MARGIN <span class='op'>=</span> <span class='fl'>2L</span>, \<span class='op'>(</span><span class='va'>i</span><span class='op'>)</span> <span class='va'>i</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/which.min.html'>which.min</a></span><span class='op'>(</span><span class='va'>val</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename_with</a></span><span class='op'>(</span><span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"min3val_"</span>, <span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>time <span class='op'>=</span> <span class='va'>ts_wide_df</span><span class='op'>$</span><span class='va'>time</span><span class='op'>[</span><span class='op'>-</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>ts_wide_df</span>, <span class='va'>moving_mins_wide</span>, by <span class='op'>=</span> <span class='st'>"time"</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 6 × 8
     time   val    col1     col2 min3val_time min3val_val min3val_col1
    &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;        &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;
  1     1    50  0.0183  0.00501           NA          NA       NA    
  2     2    40  0.705  -0.0376            NA          NA       NA    
  3     3    60 -0.647   0.724              2          40        0.705
  4     4    30  0.868  -0.497              4          30        0.868
  5     5    20  0.376   0.0114             5          20        0.376
  6     6    10  0.310   0.00986            6          10        0.310
  # ℹ 1 more variable: min3val_col2 &lt;dbl&gt;</code></pre>
</div>
<!-- ### Dependency relations between rows -->
<!-- In tidy representations of nested, hierarchical data, the parent-child relationship between rows are often encoded in a column that reference other rows in the data. -->
<!-- Let's take the case of dependency parsing in NLP (using [spaCy](https://spacy.io/)) for example. Given a sentence like "June likes cute cats", the dependency relationship between tokens can be represented like so: -->
<!-- <details> -->
<!-- <summary>Code to produce the figure</summary> -->
<!-- ```{r displacy, eval = FALSE} -->
<!-- library(reticulate) -->
<!-- spacy <- import("spacy") -->
<!-- nlp <- spacy$load("en_core_web_sm") -->
<!-- py_parsed <- nlp("June likes cute cats") -->
<!-- displacy_render <- function(x) { -->
<!--   spacy$displacy$render(x) |>  -->
<!--     htmltools::HTML() |> -->
<!--     htmltools::html_print() -->
<!-- } -->
<!-- displacy_render(py_parsed) -->
<!-- ``` -->
<!-- </details> -->
<!-- ```{r displacy, message = FALSE} -->
<!-- ``` -->
<!-- There's a lot going on here, but I want to draw attention to the fact that there's an arrow going from `"likes"` to `"cats"` and from `"cats"` to `"cute"`. In NLP terms, we say that in this sentence, the head of "cute" is "cats", and the head of "cats" is "likes". -->
<!-- To demonstrate this using **spacy** in *python*, we can parse the sentence and store the parsed object in `py_parsed`: -->
<!-- ```{r, eval = FALSE} -->
<!-- library(reticulate) -->
<!-- spacy <- import("spacy") -->
<!-- nlp <- spacy$load("en_core_web_sm") -->
<!-- py_parsed <- nlp("June likes cute cats") -->
<!-- ``` -->
<!-- Using python's 0-indexing, we extract the token object corresponding to "cats". From there, we can see the dependency relationship where the head of "cute" is "cats" and the head of "cats" is "likes": -->
<!-- ```{r} -->
<!-- py_parsed[2] -->
<!-- py_parsed[2]$head -->
<!-- py_parsed[2]$head$head -->
<!-- ``` -->
<!-- We see that this dependency relationship between "cute"-"cats"-"likes" is expressed concisely in object-oriented programming (you just follow the `head` property of tokens). This gets a bit trickier to work with in tidy data form. -->
<!-- Using the `{spacyr}` package, we can generate a dataframe equivalent of `py_parsed` which stores the dependency relationship in the `head_token_id` column: -->
<!-- ```{r, message = FALSE} -->
<!-- library(spacyr) -->
<!-- sentence <- "June likes cute cats" -->
<!-- parsed <- spacy_parse(sentence, dependency = TRUE, entity = FALSE)[,-c(1:2)] -->
<!-- parsed -->
<!-- ``` -->
<!-- To get from "cute" to "cats" and "likes" by following the arrows, we can use `slice()`: -->
<!-- ```{r} -->
<!-- # Child token -->
<!-- parsed |>  -->
<!--   slice(3) -->
<!-- # Parent head -->
<!-- parsed |>  -->
<!--   slice( head_token_id[3] ) -->
<!-- # Grandparent head -->
<!-- parsed |>  -->
<!--   slice( head_token_id[token_id == head_token_id[3]] ) -->
<!-- ``` -->
<!-- <details> -->
<!-- <summary>The recursive generalization</summary> -->
<!-- ```{r} -->
<!-- # Special case for init -->
<!-- parsed |>  -->
<!--   slice( 3 ) -->
<!-- # Recursive call to `head_token_id[token_id == PREV]` -->
<!-- parsed |>  -->
<!--   slice( head_token_id[token_id == 3] ) -->
<!-- parsed |>  -->
<!--   slice( head_token_id[token_id == head_token_id[token_id == 3]] ) -->
<!-- ``` -->
<!-- </details> -->
<!-- Now let's say that we have a paragraph of sentences describing what June likes and doesn't likes. -->
<!-- ```{r} -->
<!-- paragraph <- "June likes cute cats. June hates angry cats. June likes small dogs." -->
<!-- parsed_paragraph <- spacy_parse(paragraph, dependency = TRUE, entity = FALSE) -->
<!-- parsed_paragraph <- parsed_paragraph |>  -->
<!--   filter(pos != "PUNCT") -->
<!-- parsed_paragraph -->
<!-- ``` -->
<!-- And let's say that our research question is: what kinds of cats does June like? In other words we want to end up with a set of `ADJ`s where the head token is `cats` and the head token of that is `likes`. In `parsed_paragraph`, there's only one token (row) meeting this criteria: -->
<!-- ```{r} -->
<!-- parsed_paragraph[3,] -->
<!-- ``` -->
<!-- In our solution we use a helper function `get_head_tokens()`, which recursively searches for token head using `slice()`. This blog post is already getting too long so I'll just dump the code for now and maybe I'll come back to add more explanations later... -->
<!-- ```{r} -->
<!-- get_head_tokens <- function(df, child, n) { -->
<!--   child <- rlang::eval_tidy(enquo(child), data = df) -->
<!--   purrr::accumulate( -->
<!--     .x = seq_len(n), -->
<!--     .f = ~ slice(df, head_token_id[token_id == .x$token_id]), -->
<!--     .init = slice(df, child) -->
<!--   ) |>  -->
<!--     slice(-1) |>  -->
<!--     pull(token) -->
<!-- } -->
<!-- parsed_paragraph |>  -->
<!--   filter(sentence_id == 1) |>  -->
<!--   get_head_tokens(child = which(pos == "ADJ"), n = 2) -->
<!-- ``` -->
<!-- Applying `get_head_tokens()` for each sentence gets us the solution: -->
<!-- ```{r} -->
<!-- parsed_paragraph |>  -->
<!--   group_by(sentence_id) |>  -->
<!--   filter( -->
<!--     pos == "ADJ", -->
<!--     identical( -->
<!--       c("cats", "likes"), -->
<!--       get_head_tokens(pick(everything()), which(pos == "ADJ"), 2) -->
<!--     ) -->
<!--   ) |>  -->
<!--   ungroup() -->
<!-- ``` -->
<h3 id="evenly-distributed-row-shuffling-of-balanced-categories">Evenly distributed row shuffling of balanced categories</h3>
<p>Sometimes the ordering of rows in a data frame can be meaningful for an external application.</p>
<p>For example, many experiment-building platforms for psychology research require researchers to specify the running order of trials in an experiment via a csv, where each row represents a trial and each column represents information about the trial.</p>
<p>So an experiment testing the classic <a href="https://www.psytoolkit.org/lessons/stroop.html">Stroop effect</a> may have the following template:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>mismatch_trials</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  item_id <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>5</span>,</span>
<span>  trial <span class='op'>=</span> <span class='st'>"mismatch"</span>,</span>
<span>  word <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"red"</span>, <span class='st'>"green"</span>, <span class='st'>"purple"</span>, <span class='st'>"brown"</span>, <span class='st'>"blue"</span><span class='op'>)</span>,</span>
<span>  color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"brown"</span>, <span class='st'>"red"</span>, <span class='st'>"green"</span>, <span class='st'>"blue"</span>, <span class='st'>"purple"</span><span class='op'>)</span></span>
<span><span class='op'>)</span></span>
<span><span class='va'>mismatch_trials</span></span></code></pre>
</div>
<pre><code>  # A tibble: 5 × 4
    item_id trial    word   color 
      &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
  1       1 mismatch red    brown 
  2       2 mismatch green  red   
  3       3 mismatch purple green 
  4       4 mismatch brown  blue  
  5       5 mismatch blue   purple</code></pre>
</div>
<p>We probably also want to mix in some <em>control</em> trials where the word and color do match:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>match_trials</span> <span class='op'>&lt;-</span> <span class='va'>mismatch_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>trial <span class='op'>=</span> <span class='st'>"match"</span>, color <span class='op'>=</span> <span class='va'>word</span><span class='op'>)</span></span>
<span><span class='va'>match_trials</span></span></code></pre>
</div>
<pre><code>  # A tibble: 5 × 4
    item_id trial word   color 
      &lt;int&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; 
  1       1 match red    red   
  2       2 match green  green 
  3       3 match purple purple
  4       4 match brown  brown 
  5       5 match blue   blue</code></pre>
</div>
<p>Now that we have all materials for our experiment, we next want the running order to interleave the match and mismatch trials.</p>
<p>We first add them together into a longer data frame:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>stroop_trials</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind_rows.html'>bind_rows</a></span><span class='op'>(</span><span class='va'>mismatch_trials</span>, <span class='va'>match_trials</span><span class='op'>)</span></span>
<span><span class='va'>stroop_trials</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       2 mismatch green  red   
   3       3 mismatch purple green 
   4       4 mismatch brown  blue  
   5       5 mismatch blue   purple
   6       1 match    red    red   
   7       2 match    green  green 
   8       3 match    purple purple
   9       4 match    brown  brown 
  10       5 match    blue   blue</code></pre>
</div>
<p>And from here we can exploit the fact that all mismatch items come before match items, and that they share the same length of 5:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>stroop_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/outer.html'>outer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>5</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>5</span>, <span class='st'>"+"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       1 match    red    red   
   3       2 mismatch green  red   
   4       2 match    green  green 
   5       3 mismatch purple green 
   6       3 match    purple purple
   7       4 mismatch brown  blue  
   8       4 match    brown  brown 
   9       5 mismatch blue   purple
  10       5 match    blue   blue</code></pre>
</div>
<p>This relies on a strong assumptions about the row order in the original data, though. So a safer alternative is to represent the row indices for <code>"match"</code> and <code>"mismatch"</code> trials as rows of a matrix, and then collapse column-wise.</p>
<p>Let’s try this outside of <code>slice()</code> first. We start with a call to <code>sapply()</code> to construct a matrix where the columns contain row indices for each unique category of <code>trial</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>stroop_trials</span><span class='op'>$</span><span class='va'>trial</span><span class='op'>)</span>, \<span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>stroop_trials</span><span class='op'>$</span><span class='va'>trial</span> <span class='op'>==</span> <span class='va'>x</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       mismatch match
  [1,]        1     6
  [2,]        2     7
  [3,]        3     8
  [4,]        4     9
  [5,]        5    10</code></pre>
</div>
<p>Then we transpose the matrix with <code>t()</code>, which rotates it:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>stroop_trials</span><span class='op'>$</span><span class='va'>trial</span><span class='op'>)</span>, \<span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>stroop_trials</span><span class='op'>$</span><span class='va'>trial</span> <span class='op'>==</span> <span class='va'>x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>           [,1] [,2] [,3] [,4] [,5]
  mismatch    1    2    3    4    5
  match       6    7    8    9   10</code></pre>
</div>
<p>Now lets stick that inside slice, remembering to collapse the transposed matrix into vector:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>interleaved_stroop_trials</span> <span class='op'>&lt;-</span> <span class='va'>stroop_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>trial</span><span class='op'>)</span>, \<span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>trial</span> <span class='op'>==</span> <span class='va'>x</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span>
<span><span class='va'>interleaved_stroop_trials</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       1 match    red    red   
   3       2 mismatch green  red   
   4       2 match    green  green 
   5       3 mismatch purple green 
   6       3 match    purple purple
   7       4 mismatch brown  blue  
   8       4 match    brown  brown 
   9       5 mismatch blue   purple
  10       5 match    blue   blue</code></pre>
</div>
<p>At the moment, we have both “red” word trails showing up together, and then the “green”s, the “purple”s, and so on. If we wanted to introduce some randomness to the presentation order within each type of trial, we can wrap the row indices in <code>sample()</code> to shuffle them first:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>shuffled_stroop_trials</span> <span class='op'>&lt;-</span> <span class='va'>stroop_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>trial</span><span class='op'>)</span>, \<span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>trial</span> <span class='op'>==</span> <span class='va'>x</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>)</span></span>
<span><span class='va'>shuffled_stroop_trials</span></span></code></pre>
</div>
<pre><code>  # A tibble: 10 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       5 match    blue   blue  
   3       2 mismatch green  red   
   4       4 match    brown  brown 
   5       3 mismatch purple green 
   6       1 match    red    red   
   7       4 mismatch brown  blue  
   8       3 match    purple purple
   9       5 mismatch blue   purple
  10       2 match    green  green</code></pre>
</div>
<!-- applies to monotonically increasing continuous sequences too -->
<h3 id="inserting-a-new-row-at-specific-intervals">Inserting a new row at specific intervals</h3>
<p>Continuing with our Stroop experiment template example, let’s say we want to give participants a break every two trials.</p>
<p>In a matrix representation, this means constructing this 2-row matrix of row indices:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>shuffled_stroop_trials</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4] [,5]
  [1,]    1    3    5    7    9
  [2,]    2    4    6    8   10</code></pre>
</div>
<p>And adding a row of that represent a separator/break, before collapsing column-wise:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>shuffled_stroop_trials</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fl'>11</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4] [,5]
  [1,]    1    3    5    7    9
  [2,]    2    4    6    8   10
  [3,]   11   11   11   11   11</code></pre>
</div>
<p>Using slice, this means adding a row to the data representing a break trial first, and then adding a row to the row index matrix representing that row:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>stroop_with_breaks</span> <span class='op'>&lt;-</span> <span class='va'>shuffled_stroop_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/add_row.html'>add_row</a></span><span class='op'>(</span>trial <span class='op'>=</span> <span class='st'>"BREAK"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>[</span><span class='op'>-</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>]</span>, nrow <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span>
<span><span class='va'>stroop_with_breaks</span></span></code></pre>
</div>
<pre><code>  # A tibble: 15 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       5 match    blue   blue  
   3      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   4       2 mismatch green  red   
   5       4 match    brown  brown 
   6      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   7       3 mismatch purple green 
   8       1 match    red    red   
   9      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  10       4 mismatch brown  blue  
  11       3 match    purple purple
  12      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  13       5 mismatch blue   purple
  14       2 match    green  green 
  15      NA BREAK    &lt;NA&gt;   &lt;NA&gt;</code></pre>
</div>
<p>If we don’t want a break after the last trial, we can use negative indexing with <code>slice(-n())</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>stroop_with_breaks</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 14 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       5 match    blue   blue  
   3      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   4       2 mismatch green  red   
   5       4 match    brown  brown 
   6      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   7       3 mismatch purple green 
   8       1 match    red    red   
   9      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  10       4 mismatch brown  blue  
  11       3 match    purple purple
  12      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  13       5 mismatch blue   purple
  14       2 match    green  green</code></pre>
</div>
<p>What about after 3 trials, where the number of trials (10) is not divisibly by 3? Can we still use a matrix?</p>
<p>Yes, you’d just need to explicitly fill in the “blanks”!</p>
<p>Conceptually, we want a matrix like this, where extra “cells” are padded with 0s (recall that 0s are ignored in <code>slice()</code>):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>3</span> <span class='op'>-</span> <span class='fl'>10</span> <span class='op'><a href='https://rdrr.io/r/base/Arithmetic.html'>%%</a></span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4]
  [1,]    1    4    7   10
  [2,]    2    5    8    0
  [3,]    3    6    9    0</code></pre>
</div>
<p>And this is how that could be implemented inside <code>slice()</code>, minding the fact that adding the break trial increases original row count by 1:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>shuffled_stroop_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/add_row.html'>add_row</a></span><span class='op'>(</span>trial <span class='op'>=</span> <span class='st'>"BREAK"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq_len</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>3</span> <span class='op'>-</span> <span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'><a href='https://rdrr.io/r/base/Arithmetic.html'>%%</a></span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span>nrow <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 13 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       5 match    blue   blue  
   3       2 mismatch green  red   
   4      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   5       4 match    brown  brown 
   6       3 mismatch purple green 
   7       1 match    red    red   
   8      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   9       4 mismatch brown  blue  
  10       3 match    purple purple
  11       5 mismatch blue   purple
  12      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  13       2 match    green  green</code></pre>
</div>
<p>How about inserting a break trial after every <code>"purple"</code> word trials?</p>
<p>Conceptually, we want a matrix that binds these two vectors as rows before collapsing:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>shuffled_stroop_trials</span><span class='op'>)</span> <span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/replace.html'>replace</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>shuffled_stroop_trials</span><span class='op'>)</span><span class='op'>)</span>,</span>
<span>          <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>shuffled_stroop_trials</span><span class='op'>$</span><span class='va'>word</span> <span class='op'>==</span> <span class='st'>"purple"</span><span class='op'>)</span>, <span class='fl'>11</span><span class='op'>)</span></span>
<span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>   [1]  1  2  3  4  5  6  7  8  9 10
   [1]  0  0  0  0 11  0  0 11  0  0</code></pre>
</div>
<p>And this is how you could do that inside <code>slice()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>shuffled_stroop_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/add_row.html'>add_row</a></span><span class='op'>(</span>trial <span class='op'>=</span> <span class='st'>"BREAK"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq_len</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/replace.html'>replace</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>-</span><span class='fl'>1</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>word</span> <span class='op'>==</span> <span class='st'>"purple"</span><span class='op'>)</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span></span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span>nrow <span class='op'>=</span> <span class='fl'>2</span>, byrow <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 12 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       5 match    blue   blue  
   3       2 mismatch green  red   
   4       4 match    brown  brown 
   5       3 mismatch purple green 
   6      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   7       1 match    red    red   
   8       4 mismatch brown  blue  
   9       3 match    purple purple
  10      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  11       5 mismatch blue   purple
  12       2 match    green  green</code></pre>
</div>
<p>You might protest that this is a pretty convoluted approach to a seemingly simple problem of inserting rows, and you’d be right!<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Not only is the code difficult to read, you can only insert the same single row over and over.</p>
<p>It turns out that these cases of row insertion actually fall under the broader class of interweaving <strong>unequal categories</strong> - let’s see this next.</p>
<h3 id="evenly-distributed-row-shuffling-of-unequal-categories">Evenly distributed row shuffling of unequal categories</h3>
<p>Let’s return to our solution for the initial “break every 2 trials” problem:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>shuffled_stroop_trials</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://tibble.tidyverse.org/reference/add_row.html'>add_row</a></span><span class='op'>(</span>trial <span class='op'>=</span> <span class='st'>"BREAK"</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/row_number.html'>row_number</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>[</span><span class='op'>-</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>]</span>, nrow <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>      <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span>  <span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 14 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 mismatch red    brown 
   2       5 match    blue   blue  
   3      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   4       2 mismatch green  red   
   5       4 match    brown  brown 
   6      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
   7       3 mismatch purple green 
   8       1 match    red    red   
   9      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  10       4 mismatch brown  blue  
  11       3 match    purple purple
  12      NA BREAK    &lt;NA&gt;   &lt;NA&gt;  
  13       5 mismatch blue   purple
  14       2 match    green  green</code></pre>
</div>
<p>Here, we were working with a matrix that looks like this, where <code>11</code> represents the new row we added representing a break trial:</p>
<div class="layout-chunk" data-layout="l-body">
<pre><code>       [,1] [,2] [,3] [,4] [,5]
  [1,]    1    3    5    7    9
  [2,]    2    4    6    8   10
  [3,]   11   11   11   11   11</code></pre>
</div>
<p>And recall that to insert every <em>3</em> rows, we needed to pad with <code>0</code> first to satisfy the matrix’s rectangle constraint:</p>
<div class="layout-chunk" data-layout="l-body">
<pre><code>       [,1] [,2] [,3] [,4]
  [1,]    1    4    7   10
  [2,]    2    5    8    0
  [3,]    3    6    9    0
  [4,]   11   11   11   11</code></pre>
</div>
<p>But a better way of thinking about this is to have one matrix row representing all row indices, and then add a <strong>sparse row</strong> that represent breaks:</p>
<ul>
<li><p>Break after every 2 trials:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep_len</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>11</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>2</span>, byrow <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
  [1,]    1    2    3    4    5    6    7    8    9    10
  [2,]    0   11    0   11    0   11    0   11    0    11</code></pre>
</div></li>
<li><p>Break after every 3 trials:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep_len</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0</span>, <span class='fl'>11</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>2</span>, byrow <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
  [1,]    1    2    3    4    5    6    7    8    9    10
  [2,]    0    0   11    0    0   11    0    0   11     0</code></pre>
</div></li>
<li><p>Break after every 4 trials:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep_len</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0</span>, <span class='fl'>0</span>, <span class='fl'>11</span><span class='op'>)</span>, <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span>, nrow <span class='op'>=</span> <span class='fl'>2</span>, byrow <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
  [1,]    1    2    3    4    5    6    7    8    9    10
  [2,]    0    0    0   11    0    0    0   11    0     0</code></pre>
</div></li>
</ul>
<p>And it turns out that this method generalizes to balanced shuffling across categories that are not equal in size!</p>
<p>Let’s start with a really basic example - here we have three kinds of fruits with varying counts:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>fruits</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"🍎"</span>, <span class='st'>"🍋"</span>, <span class='st'>"🍇"</span><span class='op'>)</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2</span>,<span class='fl'>1</span>,<span class='fl'>3</span>,<span class='fl'>3</span>,<span class='fl'>2</span>,<span class='fl'>3</span>,<span class='fl'>1</span>,<span class='fl'>2</span>,<span class='fl'>2</span>,<span class='fl'>1</span>,<span class='fl'>2</span>,<span class='fl'>2</span>,<span class='fl'>3</span>,<span class='fl'>3</span>,<span class='fl'>3</span><span class='op'>)</span><span class='op'>]</span></span>
<span><span class='va'>fruits</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>fruits</span>, levels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"🍇"</span>, <span class='st'>"🍋"</span>, <span class='st'>"🍎"</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>fruits</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  fruits
  🍇 🍋 🍎 
   6  6  3</code></pre>
</div>
<p>Their current order looks like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>fruits</span><span class='op'>)</span><span class='op'>[</span><span class='va'>fruits</span><span class='op'>]</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  🍋 🍎 🍇 🍇 🍋 🍇 🍎 🍋 🍋 🍎 🍋 🍋 🍇 🍇 🍇</code></pre>
</div>
<p>But I want them to be ordered such that individuals of the same fruit kind are maximally apart from one another. This effectively re-orders the fruits to be distributed “evenly”:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>fruits</span><span class='op'>)</span><span class='op'>[</span><span class='va'>fruits</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>3</span>,<span class='fl'>1</span>,<span class='fl'>2</span>,<span class='fl'>4</span>,<span class='fl'>5</span>,<span class='fl'>0</span>,<span class='fl'>6</span>,<span class='fl'>8</span>,<span class='fl'>10</span>,<span class='fl'>13</span>,<span class='fl'>9</span>,<span class='fl'>0</span>,<span class='fl'>14</span>,<span class='fl'>11</span>,<span class='fl'>7</span>,<span class='fl'>15</span>,<span class='fl'>12</span>,<span class='fl'>0</span><span class='op'>)</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  🍇 🍋 🍎 🍇 🍋 🍇 🍋 🍎 🍇 🍋 🍇 🍋 🍎 🍇 🍋</code></pre>
</div>
<p>With our “build row-wise, collapse col-wise” approach, this takes the following steps:</p>
<ol type="1">
<li><p>Find the most frequent category - that N-max becomes the number of columns in the matrix of row indices.</p>
<p>In this case it’s grapes and lemons, of which there are 6 each:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>grape_rows</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>fruits</span> <span class='op'>==</span> <span class='st'>"🍇"</span><span class='op'>)</span></span>
 <span><span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span><span class='va'>grape_rows</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"🍇"</span>, <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  🍇 🍇 🍇 🍇 🍇 🍇 
   3  4  6 13 14 15</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>lemon_rows</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>fruits</span> <span class='op'>==</span> <span class='st'>"🍋"</span><span class='op'>)</span></span>
 <span><span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span><span class='va'>lemon_rows</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='st'>"🍋"</span>, <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  🍋 🍋 🍋 🍋 🍋 🍋 
   1  5  8  9 11 12</code></pre>
</div></li>
<li><p>Normalize (“stretch”) all vectors to have the same length as N.</p>
<p>In this case we need to stretch the apples vector, which is currently only length-3:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>apple_rows</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>fruits</span> <span class='op'>==</span> <span class='st'>"🍎"</span><span class='op'>)</span></span>
 <span><span class='va'>apple_rows</span></span></code></pre>
</div>
<pre><code>  [1]  2  7 10</code></pre>
</div>
<p>The desired “sparse” representation is something like this, where each instance of apple is equidistant, with 0s in between:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>apple_rows_sparse</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2</span>, <span class='fl'>0</span>, <span class='fl'>7</span>, <span class='fl'>0</span>, <span class='fl'>10</span>, <span class='fl'>0</span><span class='op'>)</span></span>
 <span><span class='fu'><a href='https://rdrr.io/r/stats/setNames.html'>setNames</a></span><span class='op'>(</span><span class='va'>apple_rows_sparse</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"🍎"</span>, <span class='st'>""</span>, <span class='st'>"🍎"</span>, <span class='st'>""</span>, <span class='st'>"🍎"</span>, <span class='st'>""</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  🍎    🍎    🍎    
   2  0  7  0 10  0</code></pre>
</div>
<p>There are many ways to get at this, but one trick involves creating an evenly spaced float sequence from 1 to N-apple over N-max steps:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>3</span>, length.out <span class='op'>=</span> <span class='fl'>6</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] 1.0 1.4 1.8 2.2 2.6 3.0</code></pre>
</div>
<p>From there, we round the numbers:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>3</span>, length.out <span class='op'>=</span> <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1] 1 1 2 2 3 3</code></pre>
</div>
<p>Then mark the first occurance of each number using <code>!duplicated()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/duplicated.html'>duplicated</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>3</span>, length.out <span class='op'>=</span> <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1]  TRUE FALSE  TRUE FALSE  TRUE FALSE</code></pre>
</div>
<p>And lastly, we initialize a vector of 0s and <code>replace()</code> the <code>TRUE</code>s with apple indices:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='fu'><a href='https://rdrr.io/r/base/replace.html'>replace</a></span><span class='op'>(</span></span>
 <span>  <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>6</span><span class='op'>)</span>,</span>
 <span>  <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/duplicated.html'>duplicated</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>3</span>, length.out <span class='op'>=</span> <span class='fl'>6</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,</span>
 <span>  <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>fruits</span> <span class='op'>==</span> <span class='st'>"🍎"</span><span class='op'>)</span></span>
 <span><span class='op'>)</span></span></code></pre>
</div>
<pre><code>  [1]  2  0  7  0 10  0</code></pre>
</div></li>
<li><p>Stack up the category vectors by row and collapse column-wise:</p>
<p>Manually, we would build the full matrix row-by-row like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>fruits_matrix</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span></span>
 <span>  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>grape_rows</span>, <span class='va'>lemon_rows</span>, <span class='va'>apple_rows_sparse</span><span class='op'>)</span>,</span>
 <span>  nrow <span class='op'>=</span> <span class='fl'>3</span>, byrow <span class='op'>=</span> <span class='cn'>TRUE</span></span>
 <span><span class='op'>)</span></span>
 <span><span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>fruits_matrix</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"🍇"</span>, <span class='st'>"🍋"</span>, <span class='st'>"🍎"</span><span class='op'>)</span></span>
 <span><span class='va'>fruits_matrix</span></span></code></pre>
</div>
<pre><code>     [,1] [,2] [,3] [,4] [,5] [,6]
  🍇    3    4    6   13   14   15
  🍋    1    5    8    9   11   12
  🍎    2    0    7    0   10    0</code></pre>
</div>
<p>And dynamically we can use <code>sapply()</code> to fill the matrix column-by-column, and then <code>t()</code>-ing the output:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>fruits_distributed</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>fruits</span><span class='op'>)</span>, \<span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span></span>
 <span>  <span class='va'>n_max</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>fruits</span><span class='op'>)</span><span class='op'>)</span></span>
 <span>  <span class='va'>ind</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>fruits</span> <span class='op'>==</span> <span class='va'>x</span><span class='op'>)</span></span>
 <span>  <span class='va'>nums</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>ind</span><span class='op'>)</span>, length.out <span class='op'>=</span> <span class='va'>n_max</span><span class='op'>)</span></span>
 <span>  <span class='fu'><a href='https://rdrr.io/r/base/replace.html'>replace</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>n_max</span><span class='op'>)</span>, <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/duplicated.html'>duplicated</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nums</span><span class='op'>)</span><span class='op'>)</span>, <span class='va'>ind</span><span class='op'>)</span></span>
 <span><span class='op'>}</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
 <span>  <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='op'>)</span></span>
 <span><span class='va'>fruits_distributed</span></span></code></pre>
</div>
<pre><code>     [,1] [,2] [,3] [,4] [,5] [,6]
  🍇    3    4    6   13   14   15
  🍋    1    5    8    9   11   12
  🍎    2    0    7    0   10    0</code></pre>
</div>
<p>Finally, we collapse the vector and we see that it indeed distributed the fruits evenly!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>fruits</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>fruits_distributed</span><span class='op'>)</span><span class='op'>]</span></span></code></pre>
</div>
<pre><code>   [1] 🍇 🍋 🍎 🍇 🍋 🍇 🍋 🍎 🍇 🍋 🍇 🍋 🍎 🍇 🍋
  Levels: 🍇 🍋 🍎</code></pre>
</div></li>
</ol>
<p>We can go even further and wrap the dynamic, <code>sapply()</code>-based solution into a function for use within <code>slice()</code>. Here, I also added an optional argument for shuffling within categories:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>rshuffle</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>shuffle_within</span> <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>  <span class='va'>categories</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span></span>
<span>  <span class='va'>n_max</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/table.html'>table</a></span><span class='op'>(</span><span class='va'>categories</span><span class='op'>)</span><span class='op'>)</span></span>
<span>  <span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span><span class='op'>(</span><span class='va'>categories</span><span class='op'>)</span>, \<span class='op'>(</span><span class='va'>lvl</span><span class='op'>)</span> <span class='op'>{</span></span>
<span>    <span class='va'>ind</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>categories</span> <span class='op'>==</span> <span class='va'>lvl</span><span class='op'>)</span></span>
<span>    <span class='kw'>if</span> <span class='op'>(</span><span class='va'>shuffle_within</span><span class='op'>)</span> <span class='va'>ind</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='va'>ind</span><span class='op'>)</span></span>
<span>    <span class='va'>nums</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>ind</span><span class='op'>)</span>, length.out <span class='op'>=</span> <span class='va'>n_max</span><span class='op'>)</span></span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/replace.html'>replace</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='va'>n_max</span><span class='op'>)</span>, <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/duplicated.html'>duplicated</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='va'>nums</span><span class='op'>)</span><span class='op'>)</span>, <span class='va'>ind</span><span class='op'>)</span></span>
<span>  <span class='op'>}</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>    <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='op'>)</span></span>
<span><span class='op'>}</span></span></code></pre>
</div>
</div>
<p>Returning back to our Stroop experiment template example, imagine we also had two filler trials, where no word is shown and just the color flashes on the screen:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>stroop_fillers</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span></span>
<span>  item_id <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span>,</span>
<span>  trial <span class='op'>=</span> <span class='st'>"filler"</span>,</span>
<span>  word <span class='op'>=</span> <span class='cn'>NA</span>,</span>
<span>  color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"red"</span>, <span class='st'>"blue"</span><span class='op'>)</span></span>
<span><span class='op'>)</span></span>
<span><span class='va'>stroop_with_fillers</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind_rows.html'>bind_rows</a></span><span class='op'>(</span><span class='va'>stroop_fillers</span>, <span class='va'>stroop_trials</span><span class='op'>)</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>trial <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>trial</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"match"</span>, <span class='st'>"mismatch"</span>, <span class='st'>"filler"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span></span>
<span><span class='va'>stroop_with_fillers</span></span></code></pre>
</div>
<pre><code>  # A tibble: 12 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;fct&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       1 filler   &lt;NA&gt;   red   
   2       2 filler   &lt;NA&gt;   blue  
   3       1 mismatch red    brown 
   4       2 mismatch green  red   
   5       3 mismatch purple green 
   6       4 mismatch brown  blue  
   7       5 mismatch blue   purple
   8       1 match    red    red   
   9       2 match    green  green 
  10       3 match    purple purple
  11       4 match    brown  brown 
  12       5 match    blue   blue</code></pre>
</div>
<p>We can evenly shuffle between the unequal trial types with our new <code>rshuffle()</code> function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span><span class='va'>stroop_with_fillers</span> <span class='op'>|&gt;</span> </span>
<span>  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span> <span class='fu'>rshuffle</span><span class='op'>(</span><span class='va'>trial</span>, shuffle_within <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>)</span></span></code></pre>
</div>
<pre><code>  # A tibble: 12 × 4
     item_id trial    word   color 
       &lt;int&gt; &lt;fct&gt;    &lt;chr&gt;  &lt;chr&gt; 
   1       2 match    green  green 
   2       2 mismatch green  red   
   3       1 filler   &lt;NA&gt;   red   
   4       1 match    red    red   
   5       4 mismatch brown  blue  
   6       3 match    purple purple
   7       3 mismatch purple green 
   8       2 filler   &lt;NA&gt;   blue  
   9       4 match    brown  brown 
  10       5 mismatch blue   purple
  11       5 match    blue   blue  
  12       1 mismatch red    brown</code></pre>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>When I started drafting this blog post, I thought I’d come with a principled taxonomy of row-relational operations. Ha. This was a lot trickier to think through than I thought.</p>
<p>But I hope that this gallery of esoteric use-cases for <code>slice()</code> inspires you to use it more, and to think about “tidy” solutions to seemingly “untidy” problems.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>The <code>.by_group = TRUE</code> is not strictly necessary here, but it’s good for visually inspecting the within-group ordering.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Although row insertion is a generally tricky problem for column-major data frame structures, which is partly why dplyr’s <a href="https://dplyr.tidyverse.org/reference/rows.html">row manipulation verbs</a> have stayed experimental for quite some time.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<div class="article-footer">
  <p class="social_footer">
    <span class="article-sharing">
      Share: &nbsp;
      <a href="https://twitter.com/share?text=Row%20relational%20operations%20with%20slice%28%29&amp;url=https%3A%2F%2Fyjunechoe.github.io%2Fposts%2F2023-06-11-row-relational-operations%2F" aria-label="share on twitter">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
    </span>
  </p>
</div>
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<!--radix_placeholder_navigation_after_body--><html><body>
<div class="distill-site-nav distill-site-footer">
<p><span style="font-family: 'Open Sans'"> June Choe | Created with
{<a href="https://github.com/rstudio/distill" style="color: #24addb">distill</a>}
</span></p>
</div>
<!--/radix_placeholder_navigation_after_body-->
</body></html>


</body>

</html>
