<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>


  <!--radix_placeholder_meta_tags-->
<title>June Choe: Demystifying delayed aesthetic evaluation: Part 2</title>

<meta property="description" itemprop="description" content="Exposing the `Stat` ggproto in functional programming terms"/>

<link rel="canonical" href="https://yjunechoe.github.io/posts/2022-07-06-ggplot2-delayed-aes-2/"/>
<link rel="icon" type="image/png" href="../../static/img/icon.png"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2022-07-06"/>
<meta property="article:created" itemprop="dateCreated" content="2022-07-06"/>
<meta name="article:author" content="June Choe"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="June Choe: Demystifying delayed aesthetic evaluation: Part 2"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Exposing the `Stat` ggproto in functional programming terms"/>
<meta property="og:url" content="https://yjunechoe.github.io/posts/2022-07-06-ggplot2-delayed-aes-2/"/>
<meta property="og:image" content="https://yjunechoe.github.io/posts/2022-07-06-ggplot2-delayed-aes-2/preview.png"/>
<meta property="og:image:width" content="3469"/>
<meta property="og:image:height" content="2224"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="June Choe"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="June Choe: Demystifying delayed aesthetic evaluation: Part 2"/>
<meta property="twitter:description" content="Exposing the `Stat` ggproto in functional programming terms"/>
<meta property="twitter:url" content="https://yjunechoe.github.io/posts/2022-07-06-ggplot2-delayed-aes-2/"/>
<meta property="twitter:image" content="https://yjunechoe.github.io/posts/2022-07-06-ggplot2-delayed-aes-2/preview.png"/>
<meta property="twitter:image:width" content="3469"/>
<meta property="twitter:image:height" content="2224"/>
<meta property="twitter:site" content="@yjunechoe"/>

<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","categories","base_url","author","date","output","editor_options","preview","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["Demystifying delayed aesthetic evaluation: Part 2"]},{"type":"character","attributes":{},"value":["Exposing the `Stat` ggproto in functional programming terms"]},{"type":"character","attributes":{},"value":["data visualization","ggplot2","tutorial"]},{"type":"character","attributes":{},"value":["https://yjunechoe.github.io"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","affiliation_url","orcid_id"]}},"value":[{"type":"character","attributes":{},"value":["June Choe"]},{"type":"character","attributes":{},"value":["University of Pennsylvania Linguistics"]},{"type":"character","attributes":{},"value":["https://live-sas-www-ling.pantheon.sas.upenn.edu/"]},{"type":"character","attributes":{},"value":["0000-0002-0701-921X"]}]}]},{"type":"character","attributes":{},"value":["2022-07-06"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["include-after-body","toc","self_contained","css"]}},"value":[{"type":"character","attributes":{},"value":["highlighting.html"]},{"type":"logical","attributes":{},"value":[true]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["../../styles.css"]}]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["chunk_output_type"]}},"value":[{"type":"character","attributes":{},"value":["console"]}]},{"type":"character","attributes":{},"value":["preview.png"]},{"type":"character","attributes":{},"value":["https://yjunechoe.github.io/posts/2022-07-06-ggplot2-delayed-aes-2/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["ggplot2-delayed-aes-2_files/anchor-4.2.2/anchor.min.js","ggplot2-delayed-aes-2_files/bowser-1.9.3/bowser.min.js","ggplot2-delayed-aes-2_files/core-js-2.5.3/LICENSE","ggplot2-delayed-aes-2_files/core-js-2.5.3/package.json","ggplot2-delayed-aes-2_files/core-js-2.5.3/shim.min.js","ggplot2-delayed-aes-2_files/distill-2.2.21/template.v2.js","ggplot2-delayed-aes-2_files/figure-html5/after-scale-example-1.png","ggplot2-delayed-aes-2_files/figure-html5/demo-orientation-1.png","ggplot2-delayed-aes-2_files/figure-html5/highjacked-compute-group-output-1.png","ggplot2-delayed-aes-2_files/figure-html5/highjacked-compute-layer-output-1.png","ggplot2-delayed-aes-2_files/figure-html5/p-bar-facetted-1.png","ggplot2-delayed-aes-2_files/figure-html5/p-bar2-1.png","ggplot2-delayed-aes-2_files/figure-html5/stage-example-1.png","ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-group-1.png","ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-group-constructor-1.png","ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-group-constructor-flexibility-1.png","ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-layer-1.png","ggplot2-delayed-aes-2_files/figure-html5/stat-unique-demo-problem-1.png","ggplot2-delayed-aes-2_files/figure-html5/stat-unique-demo-solution-1.png","ggplot2-delayed-aes-2_files/figure-html5/stat-unique-panel-demo-1.png","ggplot2-delayed-aes-2_files/figure-html5/unnamed-chunk-1-1.png","ggplot2-delayed-aes-2_files/header-attrs-2.14/header-attrs.js","ggplot2-delayed-aes-2_files/htmlwidgets-1.5.4/htmlwidgets.js","ggplot2-delayed-aes-2_files/jquery-3.6.0/jquery-3.6.0.js","ggplot2-delayed-aes-2_files/jquery-3.6.0/jquery-3.6.0.min.js","ggplot2-delayed-aes-2_files/jquery-3.6.0/jquery-3.6.0.min.map","ggplot2-delayed-aes-2_files/pagedtable-1.1/css/pagedtable.css","ggplot2-delayed-aes-2_files/pagedtable-1.1/js/pagedtable.js","ggplot2-delayed-aes-2_files/panelset-0.2.6/panelset.css","ggplot2-delayed-aes-2_files/panelset-0.2.6/panelset.js","ggplot2-delayed-aes-2_files/popper-2.6.0/popper.min.js","ggplot2-delayed-aes-2_files/react-17.0.0/AUTHORS","ggplot2-delayed-aes-2_files/react-17.0.0/LICENSE.txt","ggplot2-delayed-aes-2_files/react-17.0.0/react-dom.min.js","ggplot2-delayed-aes-2_files/react-17.0.0/react.min.js","ggplot2-delayed-aes-2_files/reactable-binding-0.2.3/reactable.js","ggplot2-delayed-aes-2_files/reactwidget-1.0.0/react-tools.js","ggplot2-delayed-aes-2_files/reactwidget-1.0.0/react-tools.js.map","ggplot2-delayed-aes-2_files/tippy-6.2.7/tippy-bundle.umd.min.js","ggplot2-delayed-aes-2_files/tippy-6.2.7/tippy-light-border.css","ggplot2-delayed-aes-2_files/tippy-6.2.7/tippy.css","ggplot2-delayed-aes-2_files/tippy-6.2.7/tippy.umd.min.js","ggplot2-delayed-aes-2_files/webcomponents-2.0.0/webcomponents.js","highlighting.html","preview.png","stat_identity_unique.png"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/font-awesome-6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
  font-size: 100%;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme
  $('code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      const citeChild = $(this).children()[0]
      // Do not process if @xyz has been used without escaping and without bibliography activated
      // https://github.com/rstudio/distill/issues/466
      if (citeChild === undefined) return true

      if (citeChild.nodeName == "D-FOOTNOTE") {
        var fn = citeChild
        $(this).html(fn.shadowRoot.querySelector("sup"))
        $(this).id = fn.id
        fn.remove()
      }
      var refs = $(this).attr('data-cites').split(" ");
      var refHtml = refs.map(function(ref) {
        // Could use CSS.escape too here, we insure backward compatibility in navigator
        return "<p>" + $('div[id="ref-' + ref + '"]').html() + "</p>";
      }).join("\n");
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // fix footnotes in tables (#411)
    // replacing broken distill.pub feature
    $('table d-footnote').each(function() {
      // we replace internal showAtNode methode which is triggered when hovering a footnote
      this.hoverBox.showAtNode = function(node) {
        // ported from https://github.com/distillpub/template/pull/105/files
        calcOffset = function(elem) {
            let x = elem.offsetLeft;
            let y = elem.offsetTop;
            // Traverse upwards until an `absolute` element is found or `elem`
            // becomes null.
            while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                x += elem.offsetLeft;
                y += elem.offsetTop;
            }

            return { left: x, top: y };
        }
        // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
        const bbox = node.getBoundingClientRect();
        const offset = calcOffset(node);
        this.show([offset.left + bbox.width, offset.top + bbox.height]);
      }
    })

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    // ignore leaflet img layers (#106)
    figures = figures.filter(':not(img[class*="leaflet"])')
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.14/header-attrs.js"></script>
  <link href="../../site_libs/panelset-0.2.6/panelset.css" rel="stylesheet" />
  <script src="../../site_libs/panelset-0.2.6/panelset.js"></script>
  <link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
  <script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>
  <script src="../../site_libs/core-js-2.5.3/shim.min.js"></script>
  <script src="../../site_libs/react-17.0.0/react.min.js"></script>
  <script src="../../site_libs/react-17.0.0/react-dom.min.js"></script>
  <script src="../../site_libs/reactwidget-1.0.0/react-tools.js"></script>
  <script src="../../site_libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
  <script src="../../site_libs/reactable-binding-0.2.3/reactable.js"></script>
  <script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script type="text/javascript" cookie-consent="tracking" async src="https://www.googletagmanager.com/gtag/js?id=UA-178413324-1"></script>
<script type="text/javascript" cookie-consent="tracking">
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-178413324-1');
</script>
<style type="text/css">
/* ---------- Global Styles ---------- */

@import url('https://fonts.googleapis.com/css?family=Atkinson+Hyperlegible&display=swap');
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap');
@import url('https://fonts.googleapis.com/css?family=Roboto+Slab&display=swap');
@import url('https://fonts.googleapis.com/css?family=Roboto&display=swap');
@import url('https://fonts.googleapis.com/css?family=Fira+Mono&display=swap');

html, body, p {
  
  font-family: 'Atkinson Hyperlegible';
  font-weight: 400;
  line-height: 1.7; 
  font-size: 1em;
  color: #333333;
  font-style: normal;
  
}

h2, h3 {
  font-family: 'Roboto Slab'
}

d-article h4 {
  font-size: 20px;
  text-align: center;
  margin-top: 0.5em;
  padding: 5px 0px;
  outline: 1px solid black;
}

d-article h5 {
  font-size: 18px;
  text-decoration: underline;
  margin-bottom: 0.5em;
}

em {
  margin-right: 3px;
}

div.opener {
  text-align: justify;
}

/* Small caps */

.sc {
  font-variant: small-caps;
  letter-spacing: 0.1em;
}


/* ---------- Index Page Styles ---------- */


/* Name time */

div.nav-left.title {
  font-family: 'Roboto Slab';
}


/* Search bar */

.angolia-autocomplete {
  width: 300px;
}

.nav-search {
    font-size: inherit;
}

/* Publication Date */

.publishedDate {
  font-size: 1.1em;
}


/* Post Description */

.posts-list .description h2 {
  font-family: 'Roboto Slab';
}

.description p {
  font-style: italic;
  padding-top: 5px;
}


/* Tags */

.posts-list .dt-tags {
  margin-top: 10px;
  margin-right: 10px;
}


.posts-list .dt-tags .dt-tag {
  font-family: 'Roboto Slab';
  font-weight: bold;
  letter-spacing: 1px;
  background-color: #565656;
  color: white;
}

/* Top & Bot bars */

.distill-site-nav {
  background-color: #262c2f;
}

.distill-site-footer p {
  color: white;
}



/* Post published date medatada */
.posts-list .metadata .publishedDate{
  font-family: 'Roboto Mono';
}


/* Post list caption */
.posts-list .posts-list-caption{
  font-family: 'Fira Mono';
  border-bottom: 5px solid #f3f3f3;
  padding-bottom: 2rem;
}


/* Sidebar Categories */
.posts-sidebar {
  font-family: 'Fira Mono';
}

.sidebar-section h3 {
  font-size: 22px;
  margin-bottom: 20px;
}


/* ---------- Article Styles ---------- */


/* Title */

d-title {
  padding-bottom: 0;
}

d-title h1 {
  font-family: 'Roboto Slab';
  line-height: 1.3;
}

d-title p {
  font-weight: 600;
}


/* General */

d-article > h2 {
  margin: 2.5rem 0 1.5rem 0;
  border-bottom: 2px solid black;
}

div.l-body + h2 {
  margin-top: 0px;
}

d-article > h3 {
  margin-top: 1em;
  font-size: 28px;
  padding-bottom: 10px;
  border-bottom: 2px solid lightgrey;
}

d-article ol {
  padding-bottom: 15px;
}

/* Aside */

aside {
  margin-left: 20px;
  width: 200px;
  font-family: 'Roboto Slab';
}

div.sourceCode + aside {
  margin-top: 1.5em;
}

aside code {
  font-weight: 600;
}

/* Details */
summary {
  padding-left: 5px;
}

details {
  background-color: #008bff0f;
  outline: 2px solid #38566F;
  padding: 1rem;
}

d-article details[open] summary {
  margin-bottom: 1em;
}

/* Block Quotes */

d-article blockquote {
  border-left: 5px solid rgba(0, 0, 0, 0.2);
  padding-left: 1em;
}

blockquote p {
  margin-bottom: 0;
}


/* Footnote margins */
d-footnote {
  margin-left: -.2em;
  margin-right: .1em;
}

/* Footnote Image */

d-footnote-list ol li img {
  width: 700px;
}

d-footnote img {
  width: 660px;
  padding: 10px;
}


/* -------- Layout Helpers -------- */

/* 2-column Even */

.pull-left {
  float: left;
  width: 47%;
}

.pull-right {
  float: right;
  width: 47%;
}

/* 2-column Left-skew */

.pull-left-wide {
  float: left;
  width: 75%;
}

.pull-right-narrow {
  float: right;
  width: 20%;
}

/* 2-column Right-skew */

.pull-left-narrow {
  float: left;
  width: 20%;
}

.pull-right-wide {
  float: right;
  width: 75%;
}


/* ---------- Code Styles ---------- */

/* Inline Code */

p > code, li > code, summary > code {
  border-radius: 4px;
  padding: 2px;
  color: black;
  background-color: #fbc4ff80;
  font-family: 'Fira Mono';
  font-weight: 600;
  font-size: 0.8em;
}

a > code {
    font-weight: bold;
}


/* Code Chunk */

d-article div.sourceCode pre {
  position: relative;
  background-color: white;
  padding-top: 10px;
  padding-bottom: 10px;
  margin-bottom: 10px;
  border-left: 5px solid #4D8DC9;
}

d-article pre.out-extended {
  width: fit-content;
  max-width: fit-content;
  padding-right: 10px;
}

/* R chunk */
d-article div.sourceCode pre.r {
  background-color: #faffff;
}

/* Julia chunk */
d-article div.sourceCode pre.julia {
  background-color: #f8fffb;
  border-left: 5px solid #4A916B;
}

d-article details div.sourceCode pre {
  background-color: white;
}

/*
d-article div.sourceCode pre.r:before {
  position: absolute;
  font-size: 1rem;
  content: 'R';
  font-family: 'Fira Mono';
  font-weight: 600;
  left: -20px;
  top: -5px;
  color: #59a2e6;
}
*/

d-article div.sourceCode pre code {
  font-family: 'Fira Mono';
  font-weight: 600;
}


/* overrides some syntax highlighting */

span.va {
  color: black;
}
span.fu {
  color: #3456cc;
}
span.cn {
  color: #ef3e3a;
}
span.fl {
  color: #c8531d;
}
span.kw {
  color: #9f1eb1;
}
span.st {
  color: #148a14;
}
span.co {
  color: #999999;
  font-weight: 500;
}

i.code-hl {
  font-style: normal;
  font-weight: bold;
  background-color: #acf120;
  padding: 2px 5px;
  font-size: 1.1em;
  outline: 1px solid lightgrey;
}

/* underline auto-linked functions */

span.va a {
  text-decoration: underline;
}
span.fu a {
  text-decoration: underline;
}


/* Output Chunk */

d-article pre code {
  font-family: 'Fira Mono';
  font-weight: 500;
}

d-article pre {
  background-color: #f9f9f9;
  padding-top: 10px;
  padding-bottom: 10px;
  margin-bottom: 30px;
  overflow-x: scroll;
}


/* Footnote inline code */

d-footnote-list code {
  color: rgb(0 0 0 / 0.70);
  font-weight: 600;
}

/* ---------- ADD-ONS ---------- */


/* {rmarkdown} */

.pagedtable-wrapper {
  margin-bottom: 20px;
}


/* html widgets */

.html-widget {
  margin-top: 1.0em;
  margin-bottom: 1.0em;
}


/* {reactable} */

.ReactTable {
  font-size: 14px;
  font-family: 'Roboto Slab';
  background-color: #fbfbfb;
}


/* {xaringanExtra} */

.panelset {
  margin-top: 10px;
  --panel-tabs-border-bottom: black;
  --panel-tab-font-family: 'Roboto Slab';
  --panel-tab-hover-background: #ddd;
  --panel-tab-text-decoration: none;
  border-bottom: 2px solid black;
  margin-bottom: 30px;
}

.panelset section {
    margin-top: 30px;
    margin-bottom: 20px;
}

.panel > pre {
  overflow-x: auto !important;
}

</style>
<!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="../../styles.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Demystifying delayed aesthetic evaluation: Part 2","description":"Exposing the `Stat` ggproto in functional programming terms","authors":[{"author":"June Choe","authorURL":"#","affiliation":"University of Pennsylvania Linguistics","affiliationURL":"https://live-sas-www-ling.pantheon.sas.upenn.edu/","orcidID":"0000-0002-0701-921X"}],"publishedDate":"2022-07-06T00:00:00.000+09:00","citationText":"Choe, 2022"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="../../index.html" class="title">June Choe</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../index.html">Home</a>
<a href="../../blog.html">Blog</a>
<a href="../../research.html">Research</a>
<a href="../../static/cv.pdf">CV</a>
<a href="../../news.html">News</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Misc.
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="../../resources.html">Resources</a>
</div>
</div>
<a href="https://twitter.com/yjunechoe">
<i class="fa fa-twitter" aria-hidden="true"></i>
</a>
<a href="https://github.com/yjunechoe">
<i class="fa fa-github" aria-hidden="true"></i>
</a>
<a href="https://osf.io/72vrb/" class="nav-image">
<img src="../../static/img/osf.png"/>
</a>
<a href="../../sitemap.xml">
<i class="fa fa-rss" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Demystifying delayed aesthetic evaluation: Part 2</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../blog.html#category:data_visualization" class="dt-tag">data visualization</a>
  <a href="../../blog.html#category:ggplot2" class="dt-tag">ggplot2</a>
  <a href="../../blog.html#category:tutorial" class="dt-tag">tutorial</a>
</div>
<!--/radix_placeholder_categories-->
<p><p>Exposing the <code>Stat</code> ggproto in functional programming
terms</p></p>
</div>

<div class="d-byline">
  June Choe  (University of Pennsylvania Linguistics)<a
href="https://live-sas-www-ling.pantheon.sas.upenn.edu/"
class="uri">https://live-sas-www-ling.pantheon.sas.upenn.edu/</a>
  
<br/>2022-07-06
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#where-it-all-happens-statcompute_layer">Where it all
happens: <code>Stat$compute_layer()</code></a></li>
<li><a
href="#where-it-specifically-happens-statcountcompute_group">Where it
specifically happens: <code>StatCount$compute_group()</code></a></li>
<li><a href="#ggproto-minus-the-gg-and-the-proto"><code>ggproto</code>,
minus the “gg” and the “proto”</a>
<ul>
<li><a href="#my-conventions">My conventions</a></li>
<li><a href="#ggplot2-conventions">{ggplot2} conventions</a></li>
</ul></li>
<li><a href="#templates-and-extensions">Templates and
extensions</a></li>
<li><a href="#the-compute_-family-of-methods">The
<code>$compute_*()</code> family of methods</a>
<ul>
<li><a href="#split">1) <strong>Split</strong></a></li>
<li><a href="#apply">2) <strong>Apply</strong></a></li>
<li><a href="#combine">3) <strong>Combine</strong></a></li>
</ul></li>
<li><a href="#the-layers-data-frame-representation">The layer’s data
frame representation</a></li>
<li><a href="#other-compute_-extensions">Other <code>$compute_*()</code>
extensions</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#sneak-peak-of-part-3">Sneak peak of Part 3</a></li>
<li><a href="#a-taste-of-writing-ggproto-extensions">A taste of writing
ggproto extensions</a></li>
</ul>
</nav>
</div>
<p><em>This is a developing series of blog posts, scheduled for three
parts:</em></p>
<ul>
<li><em><a
href="https://yjunechoe.github.io/posts/2022-03-10-ggplot2-delayed-aes-1">Part
1: Exploring the logic of <code>after_stat()</code> to peek inside
ggplot internals</a></em></li>
<li><em><a href="">Part 2: Exposing the <code>Stat</code> ggproto in
functional programming terms</a></em> (you are here)</li>
<li><em>Part 3: Completing the picture with <code>after_scale()</code>
and <code>stage()</code></em> (TBD)</li>
</ul>
<h2 id="introduction">Introduction</h2>
<p>Let’s pick up where we left off in <a
href="https://yjunechoe.github.io/posts/2022-03-10-ggplot2-delayed-aes-1">Part
1</a>. If you’d like to follow along without going back to re-read it,
the relevant code that we’ll carry over here is provided below:</p>
<details>
<summary>
Setup from Part 1
</summary>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Top-level setup</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ggplot2.tidyverse.org'>ggplot2</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://allisonhorst.github.io/palmerpenguins/'>palmerpenguins</a></span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>2022</span><span class='op'>)</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme_get.html'>theme_set</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_classic</a></span><span class='op'>(</span><span class='fl'>13</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># Custom function to inspect `after_stat()`</span>
<span class='va'>inspect_after_stat</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>p</span>, <span class='va'>i</span> <span class='op'>=</span> <span class='fl'>1L</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>._env</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/environment.html'>environment</a></span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>.out</span> <span class='op'>&lt;-</span> <span class='cn'>NULL</span>
  <span class='fu'><a href='https://rdrr.io/r/base/message.html'>suppressMessages</a></span><span class='op'>(</span><span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/trace.html'>trace</a></span><span class='op'>(</span>
      what <span class='op'>=</span> <span class='st'>"ggplot_build.ggplot"</span>,
      tracer <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>substitute</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/assign.html'>assign</a></span><span class='op'>(</span><span class='st'>".out"</span>, <span class='va'>data</span><span class='op'>[[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>]</span>, envir <span class='op'>=</span> <span class='va'>._env</span><span class='op'>)</span>, <span class='va'>._env</span><span class='op'>)</span>,
      at <span class='op'>=</span> <span class='fl'>19L</span>,
      print <span class='op'>=</span> <span class='cn'>FALSE</span>,
      where <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ns-internal.html'>asNamespace</a></span><span class='op'>(</span><span class='st'>"ggplot2"</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot_build.html'>ggplot_build</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>
  <span class='fu'><a href='https://rdrr.io/r/base/message.html'>suppressMessages</a></span><span class='op'>(</span><span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/trace.html'>untrace</a></span><span class='op'>(</span><span class='st'>"ggplot_build.ggplot"</span>, where <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ns-internal.html'>asNamespace</a></span><span class='op'>(</span><span class='st'>"ggplot2"</span><span class='op'>)</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>
  <span class='va'>.out</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
</details>
<p>To recap, the big theme of <a
href="https://yjunechoe.github.io/posts/2022-03-10-ggplot2-delayed-aes-1">Part
1</a> was about how <em>each layer</em> of a ggplot transforms the raw
data under the hood to make it “drawing ready” (i.e., the dataframe
returned by <code>layer_data()</code>). We saw that a lot happens over
the course of this data transformation pipeline, one of which is the
<strong>statistical transformation step</strong>. For example, the
<code>geom_bar()</code> layer uses <code>stat = "count"</code>
(shorthand for <code>stat = StatCount</code>) by default, which computes
new variables like <code>count</code> and <code>prop</code>
internally.</p>
<p>We also saw how <code>after_stat()</code> allows users to declare a
<strong>delayed aesthetic mapping</strong>, which waits to be applied
until after this statistical transformation step. For example, the
<code>StatCount</code> stat used by <code>geom_bar()</code> specifies
the default implicit mapping to <code>after_stat(count)</code>.</p>
<p>Objects like <code>StatCount</code> are called <strong>ggproto
objects</strong>, and they’re the focus of this Part 2 of the series.
We’ll be digging into the implementational details of the internal
statistical transformation step. Along the way, we’ll encounter some
funny looking functions in the form of
<code>&lt;obj&gt;$&lt;method&gt;()</code>. These are called
<strong>ggproto methods</strong> - they look pretty scary, but
needlessly so for our purposes: aside from their odd syntax, most of
them are essentially just data wrangling functions that we’re already
familiar with.</p>
<p>Let’s dive right in!</p>
<h2 id="where-it-all-happens-statcompute_layer">Where it all happens:
<code>Stat$compute_layer()</code></h2>
<p>Let’s again use the <code>penguins</code> dataset and visualize
penguin species counts with <code>geom_bar()</code>. This time we’ll
also give the bars <code>width = 0.7</code> and facet by island:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://allisonhorst.github.io/palmerpenguins/'>palmerpenguins</a></span><span class='op'>)</span>
<span class='va'>p_bar2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>penguins</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>species</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_bar</a></span><span class='op'>(</span>width <span class='op'>=</span> <span class='fl'>0.7</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/facet_wrap.html'>facet_wrap</a></span><span class='op'>(</span><span class='op'>~</span> <span class='va'>island</span><span class='op'>)</span>
<span class='va'>p_bar2</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/p-bar-facetted-1.png" width="624" /></p>
</div>
<p>As expected, <code>geom_bar()</code> maps the internally computed
<code>count</code> variable to the <code>y</code> aesthetic by default.
We suspect that something like <code>{dplyr}</code>’s
<code>group_by()</code> and <code>summarize()</code> (or just
<code>count()</code>) is happening in the statistical transformation
stage:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>penguins</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>island</span>, <span class='va'>species</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>count <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>, .groups <span class='op'>=</span> <span class='st'>"drop"</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  # A tibble: 5 × 3
    island    species   count
    &lt;fct&gt;     &lt;fct&gt;     &lt;int&gt;
  1 Biscoe    Adelie       44
  2 Biscoe    Gentoo      124
  3 Dream     Adelie       56
  4 Dream     Chinstrap    68
  5 Torgersen Adelie       52
</code></pre>
</div>
<p>In <a
href="https://yjunechoe.github.io/posts/2022-03-10-ggplot2-delayed-aes-1">Part
1</a>, I introduced this mystery function called
<code>inspect_after_stat()</code> to show you that this is indeed the
case:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>inspect_after_stat</span><span class='op'>(</span><span class='va'>p_bar2</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>    count prop x width flipped_aes PANEL group
  1    44    1 1   0.7       FALSE     1     1
  2   124    1 3   0.7       FALSE     1     3
  3    56    1 1   0.7       FALSE     2     1
  4    68    1 2   0.7       FALSE     2     2
  5    52    1 1   0.7       FALSE     3     1
</code></pre>
</div>
<p>Now it’s time to unveil the mystery behind this function -
<code>inspect_after_stat()</code> was grabbing the return value of the
ggproto method <code>Stat$compute_layer()</code> when it was called for
the first layer of our plot.<a href="#fn1" class="footnote-ref"
id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>Using the function <code>ggtrace_inspect_return()</code> from my
package <a
href="https://yjunechoe.github.io/ggtrace/articles/intro.html"><code>{ggtrace}</code></a>,
we can achieve this more explicitly. We pass the function our plot and
the ggproto method we want to inspect, and it gives us what the method
returned:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># install.packages("remotes")</span>
<span class='co'># remotes::install_github("yjunechoe/ggtrace")</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://yjunechoe.github.io/ggtrace'>ggtrace</a></span><span class='op'>)</span>
<span class='va'>compute_layer_output</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html'>ggtrace_inspect_return</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span><span class='op'>)</span>
<span class='va'>compute_layer_output</span>
</code></pre>
</div>
<pre><code>    count prop x width flipped_aes PANEL group
  1    44    1 1   0.7       FALSE     1     1
  2   124    1 3   0.7       FALSE     1     3
  3    56    1 1   0.7       FALSE     2     1
  4    68    1 2   0.7       FALSE     2     2
  5    52    1 1   0.7       FALSE     3     1
</code></pre>
</div>
<p>If ggproto methods are essentially functions, they should have inputs
and outputs. We just saw the output of
<code>Stat$compute_layer()</code>, but what’s its input?</p>
<p>We can simply swap out <code>ggtrace_inspect_return()</code> with
<code>ggtrace_inspect_args()</code> to look at the arguments that it was
called with:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>compute_layer_input</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_args.html'>ggtrace_inspect_args</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span> <span class='va'>compute_layer_input</span> <span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] "self"   "data"   "params" "layout"
</code></pre>
</div>
<p>We can ignore the <code>self</code> and <code>layout</code> arguments
for the moment. The crucial ones are the <code>data</code> and
<code>params</code> arguments, which look like this:</p>
<div style="
  display: flex;
  justify-content: space-between;
">
<div style="width:48%">
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>compute_layer_input</span><span class='op'>$</span><span class='va'>data</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["x"],"name":[1],"type":["mppd_dsc"],"align":["right"]},{"label":["PANEL"],"name":[2],"type":["fct"],"align":["left"]},{"label":["group"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"1","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"3","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"1","2":"2","3":"1"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"3","2":"1","3":"3"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"},{"1":"2","2":"2","3":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[5],"max":[5]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div style="width:48%">
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>compute_layer_input</span><span class='op'>$</span><span class='va'>params</span>
</code></pre>
</div>
<pre><code>  $width
  [1] 0.7
  
  $na.rm
  [1] FALSE
  
  $orientation
  [1] NA
  
  $flipped_aes
  [1] FALSE
</code></pre>
</div>
</div>
</div>
<p>Remember how I said ggproto methods are essentially data wrangling
functions? We can think of <code>Stat$compute_layer()</code> as a
function that takes a dataframe and a list of parameters, and does a
simple data wrangling after grouping by the <code>PANEL</code> and
<code>group</code> columns:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>compute_layer_fn</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>params</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>data</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>PANEL</span>, <span class='va'>group</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>
      count <span class='op'>=</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/context.html'>n</a></span><span class='op'>(</span><span class='op'>)</span>,
      x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>,
      width <span class='op'>=</span> <span class='va'>params</span><span class='op'>$</span><span class='va'>width</span>,
      flipped_aes <span class='op'>=</span> <span class='va'>params</span><span class='op'>$</span><span class='va'>flipped_aes</span>,
      .groups <span class='op'>=</span> <span class='st'>'drop'</span>
    <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/relocate.html'>relocate</a></span><span class='op'>(</span><span class='va'>PANEL</span>, <span class='va'>group</span>, .after <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/everything.html'>last_col</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>This gets us the a dataframe that’s very similar to the output of
<code>Stat$compute_layer()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>compute_layer_fn</span><span class='op'>(</span><span class='va'>compute_layer_input</span><span class='op'>$</span><span class='va'>data</span>, <span class='va'>compute_layer_input</span><span class='op'>$</span><span class='va'>params</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  # A tibble: 5 × 6
    count     x width flipped_aes PANEL group
    &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;lgl&gt;       &lt;fct&gt; &lt;int&gt;
  1    44     1   0.7 FALSE       1         1
  2   124     3   0.7 FALSE       1         3
  3    56     1   0.7 FALSE       2         1
  4    68     2   0.7 FALSE       2         2
  5    52     1   0.7 FALSE       3         1
</code></pre>
</div>
<p>So we see that the <code>Stat$compute_layer()</code> method was the
step in the internals responsible for calculating the statistical
summaries necessary to draw our bar layer.</p>
<p>But there’s a catch - the way that the method is written doesn’t
directly reflect this. Nothing about the code for
<code>Stat$compute_layer()</code> says anything about counting:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (self, data, params, layout) 
  {
      check_required_aesthetics(self$required_aes, c(names(data), 
          names(params)), snake_class(self))
      required_aes &lt;- intersect(names(data), unlist(strsplit(self$required_aes, 
          "|", fixed = TRUE)))
      data &lt;- remove_missing(data, params$na.rm, c(required_aes, 
          self$non_missing_aes), snake_class(self), finite = TRUE)
      params &lt;- params[intersect(names(params), self$parameters())]
      args &lt;- c(list(data = quote(data), scales = quote(scales)), 
          params)
      dapply(data, "PANEL", function(data) {
          scales &lt;- layout$get_scales(data$PANEL[1])
          tryCatch(do.call(self$compute_panel, args), error = function(e) {
              warn(glue("Computation failed in `{snake_class(self)}()`:\n{e$message}"))
              new_data_frame()
          })
      })
  }
  &lt;bytecode: 0x000002e49ae09aa0&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>Where’s the relevant calculation actually happening? For that, we
need to go deeper.</p>
<h2 id="where-it-specifically-happens-statcountcompute_group">Where it
specifically happens: <code>StatCount$compute_group()</code></h2>
<p>The actual calculation of counts for the bar layer happens inside
another ggproto method called
<code>StatCount$compute_group()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (self, data, scales, width = NULL, flipped_aes = FALSE) 
  {
      data &lt;- flip_data(data, flipped_aes)
      x &lt;- data$x
      weight &lt;- data$weight %||% rep(1, length(x))
      count &lt;- as.numeric(tapply(weight, x, sum, na.rm = TRUE))
      count[is.na(count)] &lt;- 0
      bars &lt;- new_data_frame(list(count = count, prop = count/sum(abs(count)), 
          x = sort(unique(x)), width = width, flipped_aes = flipped_aes), 
          n = length(count))
      flip_data(bars, flipped_aes)
  }
  &lt;bytecode: 0x000002e49b824e38&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>We don’t need to dwell on trying to understand the code - let’s dive
straight in with the same <code>ggtrace::ggtrace_inspect_*()</code>
functions.</p>
<p>We see that the return value is actually just one row of the return
value of <code>Stat$compute_layer()</code> that we saw earlier, minus
the <code>PANEL</code> and <code>group</code> columns:<a href="#fn2"
class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html'>ggtrace_inspect_return</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>    count prop x width flipped_aes
  1    44    1 1   0.7       FALSE
</code></pre>
</div>
<p>As the name suggests, <code>$compute_group()</code> is called for
each group (in this case, bar) in the <code>geom_bar()</code> layer. The
method is called <em>after the layer’s data is split by facet and
group</em>, much like how we used <code>group_by(PANEL, group)</code> to
simulate <code>compute_layer_fn()</code> above.</p>
<p>Using <code>ggtrace_inspect_n()</code> which returns how many times a
ggproto method was called in a plot, we confirm that
<code>StatCount$compute_group()</code> was indeed called five times,
once for each bar in the plot:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_n.html'>ggtrace_inspect_n</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] 5
</code></pre>
</div>
<p>And we can (mostly) recover the output of
<code>Stat$compute_layer()</code> by combining the return values from
<code>StatCount$compute_group()</code>, all five times it’s called for
the layer. The <code>cond</code> argument here lets us target the
n<sup>th</sup> time the method is called:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_rows</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html'>ggtrace_inspect_return</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span>, cond <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>,
  <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html'>ggtrace_inspect_return</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span>, cond <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>,
  <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html'>ggtrace_inspect_return</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span>, cond <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>,
  <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html'>ggtrace_inspect_return</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span>, cond <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span>,
  <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_return.html'>ggtrace_inspect_return</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span>, cond <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code>    count prop x width flipped_aes
  1    44    1 1   0.7       FALSE
  2   124    1 3   0.7       FALSE
  3    56    1 1   0.7       FALSE
  4    68    1 2   0.7       FALSE
  5    52    1 1   0.7       FALSE
</code></pre>
</div>
<p>So we get a sense that <code>Stat$compute_layer()</code> simply
splits the layer’s data by panel and group, while
<code>StatCount$compute_group()</code> does the heavy lifting.</p>
<p>But what’s the relationship between these two ggproto methods? How
does <code>Stat$compute_layer()</code> know to use
<code>StatCount$compute_group()</code>?</p>
<p>Long story short, the statistical transformation step for
<code>geom_bar()</code> is actually ALL about <code>StatCount</code>. So
<code>Stat$compute_layer()</code> is essentially
<code>StatCount$compute_layer()</code>, but also kind of not.</p>
<p>To understand this distinction fully, we need a slight detour into
the world of ggproto.</p>
<h2 id="ggproto-minus-the-gg-and-the-proto"><code>ggproto</code>, minus
the “gg” and the “proto”</h2>
<p>There are existing resources for learning how ggproto works, such as
<a
href="https://ggplot2-book.org/internals.html#introducing-ggproto">Chapter
20 of the ggplot2 book</a>, so I won’t repeat all the details here. In
fact, if you’re already familiar with object-oriented programming, the
book chapter has all you need. But you’re like me and found it
overwhelming at first, then this is for you!</p>
<details>
<summary>
On notations and conventions
</summary>
<h3 id="my-conventions">My conventions</h3>
<p>In this blog post, I’ll refer to ggproto methods like
<code>$method()</code> to distinguish it from normal functions. I’ll
refer to properties (non-function elements of ggproto objects) like
<code>$property</code> to distinguish it from variables.</p>
<p>Also, whenever I’m printing ggproto methods, I’m actually using
<code>get("method", object)</code> behind the scenes. I do this to bring
attention to the method body - printing ggproto methods as-is comes with
extra baggage that distracts from the topic of this blog post. Just be
aware of this when you go exploring ggproto methods yourself:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># This just prints the method body</span>
<span class='fu'><a href='https://rdrr.io/r/base/get.html'>get</a></span><span class='op'>(</span><span class='st'>"setup_data"</span>, <span class='va'>Stat</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  function (data, params) 
  {
      data
  }
  &lt;bytecode: 0x000002e49adde200&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Prints extra stuff we don't care about</span>
<span class='co'># - see: `ggplot2:::format.ggproto_method`</span>
<span class='va'>Stat</span><span class='op'>$</span><span class='va'>setup_data</span>
</code></pre>
</div>
<pre><code>  &lt;ggproto method&gt;
    &lt;Wrapper function&gt;
      function (...) 
  f(...)
  
    &lt;Inner function (f)&gt;
      function (data, params) 
  {
      data
  }
</code></pre>
</div>
<h3 id="ggplot2-conventions">{ggplot2} conventions</h3>
<p>You might have noticed how ggproto objects are written in upper camel
case like <code>StatCount</code>. This is by convention, but they’re
very important to know and follow. The upper camel case convention for
ggproto objects is closely related to two other conventions:</p>
<ul>
<li><p>The first is in the naming of the layer functions we use to write
ggplot code and chain with the <code>+</code> operator, like
<code>geom_bar()</code> and <code>stat_count()</code>. These names are
derived from ggproto objects like <code>GeomBar</code> and
<code>StatCount</code> through the internal function
<code>ggplot2:::snake_class()</code>. Thus, the camel case convention is
used to distinguish ggproto objects like <code>StatCount</code> from
constructor functions like <code>stat_count()</code>, while maintaining
a predictable connection between the two.</p></li>
<li><p>The second is in the use of character shorthands to refer to
ggproto objects inside layer functions, like
<code>geom_bar(stat = "count")</code>. These shorthands work by turning
the string into upper camel case using the internal function
<code>ggplot2:::camelize(x, first = TRUE)</code> and then prefixing that
with <code>"Stat"</code> (or <code>"Geom"</code> or
<code>"Position"</code>). So <code>"count"</code> gets converted into
<code>"StatCount"</code>, which then gets looked up in the caller
environment. If a ggproto object breaks this convention, the character
shorthand would not work.</p></li>
</ul>
<p>Relatedly, note how variable names like <code>StatCount</code> match
the class name <code>class(StatCount)[1]</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='va'>StatCount</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>
</code></pre>
</div>
<pre><code>  [1] "StatCount"
</code></pre>
</div>
<p>This is also by convention and it’s useful for figuring out what
specific <code>Stat</code>/<code>Geom</code>/<code>Position</code> a
layer uses:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_bar</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>$</span><span class='va'>stat</span> <span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>      <span class='co'># uses `StatCount` ggproto</span>
</code></pre>
</div>
<pre><code>  [1] "StatCount"
</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_bar</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>$</span><span class='va'>geom</span> <span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>      <span class='co'># uses `GeomBar` ggproto</span>
</code></pre>
</div>
<pre><code>  [1] "GeomBar"
</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_bar</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>$</span><span class='va'>position</span> <span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>  <span class='co'># uses `PositionStack` ggproto</span>
</code></pre>
</div>
<pre><code>  [1] "PositionStack"
</code></pre>
</div>
</details>
<p>When we distill it down to the very basics, ggprotos are essentially
<em>lists</em>, and ggproto methods are essentially <em>functions.</em>
For our purposes, the only truly new concept you need to know about
ggproto methods is that they’re <strong>functions that live inside
lists</strong>.</p>
<p>So <code>StatCount$compute_group()</code> calls the
<code>$compute_group()</code> function defined inside a list called
<code>StatCount</code>, kind of like this:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Not run</span>
<span class='va'>StatCount</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
  compute_group <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>...</span><span class='op'>)</span> <span class='op'>{</span> <span class='va'>...</span> <span class='op'>}</span>,
  <span class='va'>...</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>And <code>Stat$compute_layer()</code> calls the
<code>$compute_layer()</code> function defined inside a list called
<code>Stat</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Not run</span>
<span class='va'>Stat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
  compute_layer <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>...</span><span class='op'>)</span> <span class='op'>{</span> <span class='va'>...</span> <span class='op'>}</span>,
  <span class='va'>...</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>The reason why the layer-level statistical transformation for
<code>geom_bar()</code> was handled by <code>Stat$compute_layer()</code>
and not <code>StatCount$compute_layer()</code> is just by technicality.
In fact, <code>StatCount$compute_layer()</code> does “exist”:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_layer</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (self, data, params, layout) 
  {
      check_required_aesthetics(self$required_aes, c(names(data), 
          names(params)), snake_class(self))
      required_aes &lt;- intersect(names(data), unlist(strsplit(self$required_aes, 
          "|", fixed = TRUE)))
      data &lt;- remove_missing(data, params$na.rm, c(required_aes, 
          self$non_missing_aes), snake_class(self), finite = TRUE)
      params &lt;- params[intersect(names(params), self$parameters())]
      args &lt;- c(list(data = quote(data), scales = quote(scales)), 
          params)
      dapply(data, "PANEL", function(data) {
          scales &lt;- layout$get_scales(data$PANEL[1])
          tryCatch(do.call(self$compute_panel, args), error = function(e) {
              warn(glue("Computation failed in `{snake_class(self)}()`:\n{e$message}"))
              new_data_frame()
          })
      })
  }
  &lt;bytecode: 0x000002e49ae09aa0&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>But only in a very specific sense - it just recycles the
<code>$compute_layer()</code> function defined in <code>Stat</code>,
similar to in this implementation:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Not run</span>
<span class='va'>StatCount</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
  compute_group <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>{</span> <span class='va'>...</span> <span class='op'>}</span>,
  compute_layer <span class='op'>=</span> <span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span>,
  <span class='va'>...</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>In object-orientated programming terms, this is called
<strong>inheritance</strong> - the <code>StatCount</code> ggproto is a
<strong>child</strong> of the <strong>parent</strong> <code>Stat</code>
ggproto that inherits some of the parent’s methods (like
<code>$compute_layer()</code>) while overriding and defining some of its
own (like <code>$compute_group()</code>).</p>
<details>
<summary>
A note on class inheritance
</summary>
<p>Class inheritance is reflected in the output of <code>class()</code>,
where order of elements matter:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='va'>Stat</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] "Stat"    "ggproto" "gg"
</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='va'>StatCount</span><span class='op'>)</span> <span class='co'># see also: `inherits(StatCount, "Stat")`</span>
</code></pre>
</div>
<pre><code>  [1] "StatCount" "Stat"      "ggproto"   "gg"
</code></pre>
</div>
<p>By design, all <code>Stat*</code> ggprotos inherit from the top-level
parent <code>Stat</code> ggproto. For example, the
<code>geom_boxplot()</code> layer uses <code>StatBoxplot</code> for its
stat, which also inherits from <code>Stat</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_boxplot.html'>geom_boxplot</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>$</span><span class='va'>stat</span> <span class='op'>)</span> <span class='co'># or `class(StatBoxplot)`</span>
</code></pre>
</div>
<pre><code>  [1] "StatBoxplot" "Stat"        "ggproto"     "gg"
</code></pre>
</div>
<p>Sometimes, an inheritance chain can be more complex - for example,
<code>StatDensity2dFilled</code> inherits from
<code>StatDensity2d</code>, which in turn inherits from
<code>Stat</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='va'>StatDensity2dFilled</span> <span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] "StatDensity2dFilled" "StatDensity2d"       "Stat"               
  [4] "ggproto"             "gg"
</code></pre>
</div>
</details>
<p>But what’s the point of all this? Why do we bother with these clunky
ggproto objects instead of having a single function that does all
bar-related things, all boxplot-related things, etc.?</p>
<h2 id="templates-and-extensions">Templates and extensions</h2>
<p>The rationale behind this inheritance-based design is that the
top-level <code>Stat</code> ggproto serves as a
<strong>template</strong> that’s meant to be filled and customized.</p>
<p>Another term for this customization is <strong>extension</strong> -
for example, we say that <code>StatCount</code> is an <em>extension</em>
of <code>Stat</code>. This is what’s technically meant by “ggplot2
extension packages” - these packages provide new <code>Stat*</code> or
<code>Geom*</code> ggproto objects (like <code>ggforce::StatSina</code>
and <code>ggtext::GeomRichtext</code>) that are extensions of the
top-level <code>Stat</code> and <code>Geom</code> ggprotos.</p>
<p>Since <code>Stat</code> is essentially a list and extensions are
essentially a way of customizing certain elements of a template, each
element of <code>Stat</code> can be thought of as a possible
<strong>extension point</strong>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/names.html'>names</a></span><span class='op'>(</span><span class='va'>Stat</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>   [1] "compute_layer"   "parameters"      "aesthetics"      "setup_data"     
   [5] "retransform"     "optional_aes"    "non_missing_aes" "default_aes"    
   [9] "finish_layer"    "compute_panel"   "extra_params"    "compute_group"  
  [13] "required_aes"    "setup_params"
</code></pre>
</div>
<p>Some extension points are “methods” (functions) and others are
“properties” (non-functions):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='va'>Stat</span>, <span class='va'>class</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>    compute_layer      parameters      aesthetics      setup_data     retransform 
       "function"      "function"      "function"      "function"       "logical" 
     optional_aes non_missing_aes     default_aes    finish_layer   compute_panel 
      "character"     "character"        "uneval"      "function"      "function" 
     extra_params   compute_group    required_aes    setup_params 
      "character"      "function"     "character"      "function"
</code></pre>
</div>
<p>If you want to know what each of these methods and properties are
for, you can read up on the <a
href="https://ggplot2.tidyverse.org/reference/ggplot2-ggproto.html#stats">package
vignette on ggproto</a>. But we don’t need to know every detail - only a
handful are productive extension points.</p>
<p>Below are a few examples of specific <code>Stat*</code> extensions
(e.g., <code>StatCount</code>) and information about what
methods/properties they modify from the top-level <code>Stat</code>
ggproto:</p>
<p><em>Try to get a feel for what kind of methods and properties are the
common targets of extensions. Pay specific attention to the distribution
of methods highlighted in green.</em></p>
<div class="panelset">
<section id="statcount" class="panel-name panel">
<h2 class="panel-name"><code>StatCount</code></h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatCount</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
  [1] "aesthetics"      "<i class='code-hl'>compute_layer</i>"   "<i class='code-hl'>compute_panel</i>"   "finish_layer"   
  [5] "non_missing_aes" "optional_aes"    "parameters"      "retransform"    
  [9] "setup_data"     
  
  $StatCount
  [1] "<i class='code-hl'>compute_group</i>" "default_aes"   "extra_params"  "required_aes" 
  [5] "setup_params"
</code></pre>
</div>
</section>
<section id="statboxplot" class="panel-name panel">
<h2 class="panel-name"><code>StatBoxplot</code></h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatBoxplot</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
  [1] "aesthetics"    "<i class='code-hl'>compute_layer</i>" "<i class='code-hl'>compute_panel</i>" "default_aes"  
  [5] "finish_layer"  "optional_aes"  "parameters"    "retransform"  
  
  $StatBoxplot
  [1] "<i class='code-hl'>compute_group</i>"   "extra_params"    "non_missing_aes" "required_aes"   
  [5] "setup_data"      "setup_params"
</code></pre>
</div>
</section>
<section id="statdensity" class="panel-name panel">
<h2 class="panel-name"><code>StatDensity</code></h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatBin</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
  [1] "aesthetics"      "<i class='code-hl'>compute_layer</i>"   "<i class='code-hl'>compute_panel</i>"   "finish_layer"   
  [5] "non_missing_aes" "optional_aes"    "parameters"      "retransform"    
  [9] "setup_data"     
  
  $StatBin
  [1] "<i class='code-hl'>compute_group</i>" "default_aes"   "extra_params"  "required_aes" 
  [5] "setup_params"
</code></pre>
</div>
</section>
<section id="statsmooth" class="panel-name panel">
<h2 class="panel-name"><code>StatSmooth</code></h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatSmooth</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
   [1] "aesthetics"      "<i class='code-hl'>compute_layer</i>"   "<i class='code-hl'>compute_panel</i>"   "default_aes"    
   [5] "finish_layer"    "non_missing_aes" "optional_aes"    "parameters"     
   [9] "retransform"     "setup_data"     
  
  $StatSmooth
  [1] "<i class='code-hl'>compute_group</i>" "extra_params"  "required_aes"  "setup_params"
</code></pre>
</div>
</section>
<section id="statbin" class="panel-name panel">
<h2 class="panel-name"><code>StatBin</code></h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatBin</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
  [1] "aesthetics"      "<i class='code-hl'>compute_layer</i>"   "<i class='code-hl'>compute_panel</i>"   "finish_layer"   
  [5] "non_missing_aes" "optional_aes"    "parameters"      "retransform"    
  [9] "setup_data"     
  
  $StatBin
  [1] "<i class='code-hl'>compute_group</i>" "default_aes"   "extra_params"  "required_aes" 
  [5] "setup_params"
</code></pre>
</div>
</section>
<section id="statbin-1" class="panel-name panel">
<h2 class="panel-name"><code>StatBin</code></h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatContour</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
   [1] "aesthetics"      "<i class='code-hl'>compute_layer</i>"   "<i class='code-hl'>compute_panel</i>"   "extra_params"   
   [5] "finish_layer"    "non_missing_aes" "optional_aes"    "parameters"     
   [9] "retransform"     "setup_data"     
  
  $StatContour
  [1] "<i class='code-hl'>compute_group</i>" "default_aes"   "required_aes"  "setup_params"
</code></pre>
</div>
</section>
</div>
<p>Did you notice how all these <code>Stat*</code> extensions define
their own <code>$compute_group()</code> method while inheriting the
<code>$compute_layer()</code> and <code>$compute_panel()</code> methods
from the parent <code>stat</code>? This is the intended design - check
out how <code>Stat$compute_group()</code> is defined:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_group</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (self, data, scales) 
  {
      abort("Not implemented")
  }
  &lt;bytecode: 0x000002e49ae09838&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>And this is what I mean by “the top-level <code>Stat</code> ggproto
is a template”. The <code>Stat</code> provides an infrastructure that
splits the data up by layer (<code>Stat$compute_layer()</code>) and
panel (<code>Stat$compute_panel()</code>), but leaves it to the child
<code>Stat*</code> ggprotos to fill in the details about what
statistical summaries are computed by group, after this splitting takes
place.</p>
<details>
<summary>
How are <code>Stat$compute_layer()</code> and
<code>Stat$compute_panel()</code> implemented?
</summary>
<p>In <code>$compute_layer()</code>, the data is split by values of the
<code>PANEL</code> column using an internal function
<code>ggplot2:::dapply()</code>, and <code>$compute_panel()</code> is
called on each split.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (self, data, params, layout) 
  {
      check_required_aesthetics(self$required_aes, c(names(data), 
          names(params)), snake_class(self))
      required_aes &lt;- intersect(names(data), unlist(strsplit(self$required_aes, 
          "|", fixed = TRUE)))
      data &lt;- remove_missing(data, params$na.rm, c(required_aes, 
          self$non_missing_aes), snake_class(self), finite = TRUE)
      params &lt;- params[intersect(names(params), self$parameters())]
      args &lt;- c(list(data = quote(data), scales = quote(scales)), 
          params)
      <i class='code-hl'>dapply</i>(data, "PANEL", function(data) {
          scales &lt;- layout$get_scales(data$PANEL[1])
          tryCatch(do.call(<i class='code-hl'>self$compute_panel</i>, args), error = function(e) {
              warn(glue("Computation failed in `{snake_class(self)}()`:\n{e$message}"))
              new_data_frame()
          })
      })
  }
  &lt;bytecode: 0x000002e49ae09aa0&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>In <code>$compute_panel()</code>, the data is first split by values
of the <code>group</code> column using the <code>split()</code>
function, then <code>$compute_group()</code> is called on each split
inside <code>lapply()</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_panel</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (self, data, scales, ...) 
  {
      if (empty(data)) 
          return(new_data_frame())
      groups &lt;- <i class='code-hl'>split</i>(data, data$group)
      stats &lt;- <i class='code-hl'>lapply</i>(groups, function(group) {
          <i class='code-hl'>self$compute_group</i>(data = group, scales = scales, ...)
      })
      stats &lt;- mapply(function(new, old) {
          if (empty(new)) 
              return(new_data_frame())
          unique &lt;- uniquecols(old)
          missing &lt;- !(names(unique) %in% names(new))
          cbind(new, unique[rep(1, nrow(new)), missing, drop = FALSE])
      }, stats, groups, SIMPLIFY = FALSE)
      rbind_dfs(stats)
  }
  &lt;bytecode: 0x000002e49ade76f0&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>These two methods are implemented slightly differently, though the
exact details are not relevant to the current discussion.<a href="#fn3"
class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>Lastly, a note about <code>self</code>. The <code>self</code>
variable is a reference to the ggproto object that called the method.<a
href="#fn4" class="footnote-ref" id="fnref4"
role="doc-noteref"><sup>4</sup></a> In the context of
<code>p_bar2</code>, the <code>self</code> is
<code>StatCount</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_args.html'>ggtrace_inspect_args</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span><span class='op'>)</span><span class='op'>$</span><span class='va'>self</span> <span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] "StatCount" "Stat"      "ggproto"   "gg"
</code></pre>
</div>
<p>This may be surprising given how <code>$compute_layer()</code> lives
inside <code>Stat</code>, not <code>StatCount</code>. This is an odd
thing about object oriented programming with ggproto that you’ll have to
get used to. Just remember that the choice of the ggproto object is
determined by the layer (e.g., stored in <code>geom_bar()$stat</code>)
and that the <code>self</code> variable keeps track of <strong>which
ggproto object called a method</strong> (<em>context-dependent</em>);
but all of this is separate from the issue of <strong>where a method is
defined in</strong> (<em>context-independent</em>).</p>
<p>In other words, <code>self</code> is <code>StatCount</code> because
the method <code>$compute_layer()</code> is “looked up” by
<code>StatCount</code>. The fact that the actual
<code>$compute_layer()</code> method is defined inside
<code>Stat$compute_layer()</code> is irrelevant here (though it may be
relevant for other purposes).</p>
</details>
<p>In the next section, we’ll look at how the <code>$compute_*()</code>
family of methods behave in the internals.</p>
<details>
<summary>
Wait - what about the other common extension points?
</summary>
<p>You might have also noticed a few more repeated extension points
other than <code>$compute_group()</code>. They usually form some subset
of <code>$default_aes</code>, <code>$required_aes</code>,
<code>$setup_data()</code>, <code>$setup_params()</code>, and
<code>$extra_params</code>. These are also like a family - their job is
to prepare the layer’s data before it’s sent off to the
<code>$compute_*()</code> family of methods.</p>
<p>For example, here’s a walkthrough of how <code>StatCount</code>
prepares the data:</p>
<p>First, the default aesthetic mappings are specified such that
<em>both</em> <code>x</code> and <code>y</code> are mapped to
<code>after_stat(count)</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># or `geom_bar()$stat$default_aes`</span>
<span class='va'>StatCount</span><span class='op'>$</span><span class='va'>default_aes</span>
</code></pre>
</div>
<pre><code>  Aesthetic mapping: 
  * `x`      -&gt; `after_stat(count)`
  * `y`      -&gt; `after_stat(count)`
  * `weight` -&gt; 1
</code></pre>
</div>
<p>Second, the required aesthetic mappings are specified such that
<em>exactly one</em> of <code>x</code> <em>or</em> <code>y</code> must
be provided:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># or `geom_bar()$stat$required_aes`</span>
<span class='va'>StatCount</span><span class='op'>$</span><span class='va'>required_aes</span>
</code></pre>
</div>
<pre><code>  [1] "x|y"
</code></pre>
</div>
<p>By requiring the user to supply one of the two aesthetics, the one
left over takes on the “implicit” value of
<code>after_stat(count)</code>. This is largely handled in
<code>StatCount$setup_params()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Lots of code here but it does 3 things:</span>
<span class='co'># 1) Check if user supplied `y`, not `x` (+ track this in `flipped_aes`)</span>
<span class='co'># 2) Make sure user supplied exactly one of `x` or `y`</span>
<span class='co'># 3) If `flipped_aes` (= `y` is supplied), pretend that it's `x` but</span>
<span class='co'>#    keep that for later (reverted in `StatCount$compute_group()`)</span>
<span class='va'>StatCount</span><span class='op'>$</span><span class='va'>setup_params</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (data, params) 
  {
      params$flipped_aes &lt;- has_flipped_aes(data, params, main_is_orthogonal = FALSE)
      has_x &lt;- !(is.null(data$x) &amp;&amp; is.null(params$x))
      has_y &lt;- !(is.null(data$y) &amp;&amp; is.null(params$y))
      if (!has_x &amp;&amp; !has_y) {
          abort("stat_count() requires an x or y aesthetic.")
      }
      if (has_x &amp;&amp; has_y) {
          abort("stat_count() can only have an x or y aesthetic.")
      }
      if (is.null(params$width)) {
          x &lt;- if (params$flipped_aes) 
              "y"
          else "x"
          params$width &lt;- resolution(data[[x]]) * 0.9
      }
      params
  }
  &lt;bytecode: 0x000002e49b8212e8&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>Lastly, the role of <code>$extra_params</code> is <a
href="https://github.com/tidyverse/ggplot2/issues/2776#issuecomment-450240428">kind
of weird</a>, but in this case it simply says that
<code>StatCount</code> has support for handling different orientations
(which gets standardized to <code>flipped_aes</code> internally).</p>
<div style="
  display: flex;
  justify-content: space-between;
">
<div style="width:48%">
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Stat</span><span class='op'>$</span><span class='va'>extra_params</span>
</code></pre>
</div>
<pre><code>  [1] "na.rm"
</code></pre>
</div>
</div>
<div style="width:48%">
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>StatCount</span><span class='op'>$</span><span class='va'>extra_params</span>
</code></pre>
</div>
<pre><code>  [1] "na.rm"       "orientation"
</code></pre>
</div>
</div>
</div>
<p>In case you didn’t know already, <code>orientation</code> is a <a
href="https://github.com/tidyverse/ggplot2/pull/3506">relatively new
(v3.3.0) argument</a> supported by some layers. It’s allows individual
layers to be “flipped” without applying <code>coord_flip()</code> to the
whole plot:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span>mapping <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fl'>2</span>, y <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_col</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"pink"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_bar.html'>geom_col</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"steelblue"</span>, orientation <span class='op'>=</span> <span class='st'>"y"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/lims.html'>xlim</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>3</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/lims.html'>ylim</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>4</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/demo-orientation-1.png" width="624" /></p>
</div>
</details>
<h2 id="the-compute_-family-of-methods">The <code>$compute_*()</code>
family of methods</h2>
<p>Here, let’s look at how the statistical transformation is implemented
in the <code>$compute_*()</code> family of methods. The
<code>p_bar2</code> ggplot is printed again below.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>p_bar2</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/p-bar2-1.png" width="624" /></p>
</div>
<p>The <code>geom_bar()</code> layer in our plot computes and draws five
bars across three panels. This is reflected in the number of calls to
the <code>$compute_*()</code> methods:</p>
<ul>
<li>One call to <code>Stat$compute_layer()</code> for our one bar
layer</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_n.html'>ggtrace_inspect_n</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] 1
</code></pre>
</div>
<ul>
<li>Three calls to <code>Stat$compute_panel()</code> for three facets in
the bar layer</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_n.html'>ggtrace_inspect_n</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_panel</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] 3
</code></pre>
</div>
<ul>
<li>Five calls to <code>StatCount$compute_group()</code> for five bars
across the three facets</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_inspect_n.html'>ggtrace_inspect_n</a></span><span class='op'>(</span><span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] 5
</code></pre>
</div>
<p>Keep in mind that there’s a hierarchy to how the
<code>$compute_*()</code> functions are called:</p>
<pre>
  Stat$compute_layer()
  |---  Stat$compute_panel()
        |---  StatCount$compute_group()
        |---  StatCount$compute_group()
  |---  Stat$compute_panel()
        |---  StatCount$compute_group()
        |---  StatCount$compute_group()
  |---  Stat$compute_panel()
        |---  StatCount$compute_group()
</pre>
<p>The <code>$compute_*()</code> family of functions implement what’s
called a <strong>split-apply-combine</strong> design. If you haven’t
heard of it before, it’s basically like the “divide and conquer”
strategy: you break down the problem to the smallest, most essential
pieces, work on them individually, then bring them together into one
solution.</p>
<p>Play around with the expandable nested tables below to get a sense of
what kind of information is passed down to the
<code>$compute_group()</code> method, and what each
<code>$compute_group()</code> call returns for the bar layer in our
plot:</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 id="split">1) <strong>Split</strong></h3>
<p>The <code>$compute_layer()</code> method first splits up the data by
facet and passes them down to <code>$compute_panel()</code>. Then, the
<code>$compute_panel()</code> method splits up the data by group and
passes them down to <code>$compute_group()</code>.</p>
<div class="l-body-outset" style="margin:auto;">
<div class="layout-chunk" data-layout="l-body">
<div id="htmlwidget-e3b2cd364ac305becddb" class="reactable html-widget" style="width:705px;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-e3b2cd364ac305becddb">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"layer":[1],"panel":[""],"group":[""],"data":[""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":["","",""],"panel":[1,2,3],"group":["","",""],"data":["","",""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":["",""],"panel":["",""],"group":[1,3],"data":["",""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"x":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],"PANEL":["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],"group":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"columns":[{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"PANEL","name":"PANEL","type":"factor","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"group","name":"group","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":3,"dataKey":"1af62b7b78811ba64d66cd8b1442933d","key":"1af62b7b78811ba64d66cd8b1442933d","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"x":[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],"PANEL":["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1"],"group":[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]},"columns":[{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"PANEL","name":"PANEL","type":"factor","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"group","name":"group","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":3,"dataKey":"69ec1d24b111b30e76fb3259e3d133ea","key":"69ec1d24b111b30e76fb3259e3d133ea","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"group","name":"group","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"data","name":"data","type":"character","width":360,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"9594185ab5c02ba4d866133d16fc55d6","key":"9594185ab5c02ba4d866133d16fc55d6","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":["",""],"panel":["",""],"group":[1,2],"data":["",""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"x":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],"PANEL":["2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2"],"group":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"columns":[{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"PANEL","name":"PANEL","type":"factor","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"group","name":"group","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":3,"dataKey":"b145fef462cd49a761f17c2b6f07702e","key":"b145fef462cd49a761f17c2b6f07702e","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"x":[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],"PANEL":["2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2"],"group":[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2]},"columns":[{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"PANEL","name":"PANEL","type":"factor","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"group","name":"group","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":3,"dataKey":"0c5f3b6180297743fea9b99f29e31d39","key":"0c5f3b6180297743fea9b99f29e31d39","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"group","name":"group","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"data","name":"data","type":"character","width":360,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"c530a59fada5b4eba900ad4c84f9f866","key":"c530a59fada5b4eba900ad4c84f9f866","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":[""],"panel":[""],"group":[1],"data":[""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"x":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],"PANEL":["3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3"],"group":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},"columns":[{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"PANEL","name":"PANEL","type":"factor","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"group","name":"group","type":"numeric","sortable":false,"width":120,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":3,"dataKey":"814bb3a090e5f1635b0d99597de2ef9a","key":"814bb3a090e5f1635b0d99597de2ef9a","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"group","name":"group","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"data","name":"data","type":"character","width":360,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"e7399084b20415c1788d7c57ec3224b0","key":"e7399084b20415c1788d7c57ec3224b0","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"group","name":"group","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"data","name":"data","type":"character","width":360,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"5095b0a1a812cd2a85f4ad7e9350ea66","key":"5095b0a1a812cd2a85f4ad7e9350ea66","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"numeric","width":100,"align":"center"},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center"},{"accessor":"group","name":"group","type":"character","width":100,"align":"center"},{"accessor":"data","name":"data","type":"character","width":360,"align":"center"}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"style":{"padding":"10px"},"width":"705px","dataKey":"49788a03838fac1344f55f5a71666be8","key":"49788a03838fac1344f55f5a71666be8"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<h3 id="apply">2) <strong>Apply</strong></h3>
<p>The <code>$compute_group()</code> method applies to each of the
splits and returns a modified data:</p>
<div class="l-page" style="margin:auto;">
<div class="layout-chunk" data-layout="l-body">
<div id="htmlwidget-7ae80df7065cf1b66fd5" class="reactable html-widget" style="width:845px;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-7ae80df7065cf1b66fd5">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"layer":[1],"panel":[""],"group":[""],"data":[""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":["","",""],"panel":[1,2,3],"group":["","",""],"data":["","",""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":["",""],"panel":["",""],"group":[1,3],"data":["",""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"count":[44],"prop":[1],"x":[1],"width":[0.7],"flipped_aes":[false]},"columns":[{"accessor":"count","name":"count","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"prop","name":"prop","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"width","name":"width","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"flipped_aes","name":"flipped_aes","type":"logical","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":1,"dataKey":"4dc630dde976635c77e734379b0236e9","key":"4dc630dde976635c77e734379b0236e9","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"count":[124],"prop":[1],"x":[3],"width":[0.7],"flipped_aes":[false]},"columns":[{"accessor":"count","name":"count","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"prop","name":"prop","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"width","name":"width","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"flipped_aes","name":"flipped_aes","type":"logical","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":1,"dataKey":"5ac25f95a76016e41a1352ef7dd24a10","key":"5ac25f95a76016e41a1352ef7dd24a10","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"group","name":"group","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"data","name":"data","type":"character","width":500,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"6e0cca4ad657f8b9ed3c9f5ffe88f517","key":"6e0cca4ad657f8b9ed3c9f5ffe88f517","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":["",""],"panel":["",""],"group":[1,2],"data":["",""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"count":[56],"prop":[1],"x":[1],"width":[0.7],"flipped_aes":[false]},"columns":[{"accessor":"count","name":"count","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"prop","name":"prop","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"width","name":"width","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"flipped_aes","name":"flipped_aes","type":"logical","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":1,"dataKey":"52538b9fd0e67feca4a7d961ffc7e97b","key":"52538b9fd0e67feca4a7d961ffc7e97b","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"count":[68],"prop":[1],"x":[2],"width":[0.7],"flipped_aes":[false]},"columns":[{"accessor":"count","name":"count","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"prop","name":"prop","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"width","name":"width","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"flipped_aes","name":"flipped_aes","type":"logical","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":1,"dataKey":"55e1ba3724b59e4a3f3ef68a85fae1cc","key":"55e1ba3724b59e4a3f3ef68a85fae1cc","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"group","name":"group","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"data","name":"data","type":"character","width":500,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"961214e9ccd9bb44cc8cfc61b20950f0","key":"961214e9ccd9bb44cc8cfc61b20950f0","nested":true},"children":[]}]},{"name":"div","attribs":{"style":{"padding-left":"100px"}},"children":[{"name":"Reactable","attribs":{"data":{"layer":[""],"panel":[""],"group":[1],"data":[""]},"columns":[{"accessor":".details","name":"","type":"NULL","width":45,"align":"center","headerStyle":{"color":"grey"},"sortable":false,"resizable":false,"filterable":false,"details":[{"name":"div","attribs":{"style":{"padding-left":"145px"}},"children":[{"name":"Reactable","attribs":{"data":{"count":[52],"prop":[1],"x":[1],"width":[0.7],"flipped_aes":[false]},"columns":[{"accessor":"count","name":"count","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"prop","name":"prop","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"width","name":"width","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"flipped_aes","name":"flipped_aes","type":"logical","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":3,"paginationType":"simple","showPageInfo":true,"minRows":1,"dataKey":"b0405419b310638a1fad66a30bbd8226","key":"b0405419b310638a1fad66a30bbd8226","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"group","name":"group","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"data","name":"data","type":"character","width":500,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"773420c33acbe9651f357deeb1a71c2c","key":"773420c33acbe9651f357deeb1a71c2c","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"panel","name":"panel","type":"numeric","width":100,"align":"center","headerStyle":{"color":"grey"}},{"accessor":"group","name":"group","type":"character","width":100,"align":"center","headerStyle":{"color":"grey"},"show":false},{"accessor":"data","name":"data","type":"character","width":500,"align":"center","headerStyle":{"color":"grey"},"show":false}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"c81dbe3ceae85dc39f208b58ab723562","key":"c81dbe3ceae85dc39f208b58ab723562","nested":true},"children":[]}]}]},{"accessor":"layer","name":"layer","type":"numeric","width":100,"align":"center"},{"accessor":"panel","name":"panel","type":"character","width":100,"align":"center"},{"accessor":"group","name":"group","type":"character","width":100,"align":"center"},{"accessor":"data","name":"data","type":"character","width":500,"align":"center"}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"style":{"padding":"10px"},"width":"845px","dataKey":"1c6723046b8222715685246f8693f246","key":"1c6723046b8222715685246f8693f246"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<h3 id="combine">3) <strong>Combine</strong></h3>
<p>The output of <code>$compute_group()</code> calls are combined by
panel and returned by <code>$compute_panel()</code>, then combined again
and returned by <code>$compute_layer()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div id="htmlwidget-c400321fc06179669c0b" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-c400321fc06179669c0b">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"count":[44,124,56,68,52],"prop":[1,1,1,1,1],"x":[1,3,1,2,1],"width":[0.7,0.7,0.7,0.7,0.7],"flipped_aes":[false,false,false,false,false],"PANEL":["1","1","2","2","3"],"group":[1,3,1,2,1]},"columns":[{"accessor":"count","name":"count","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"prop","name":"prop","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"x","name":"x","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"width","name":"width","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"flipped_aes","name":"flipped_aes","type":"logical","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"PANEL","name":"PANEL","type":"factor","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}},{"accessor":"group","name":"group","type":"numeric","sortable":false,"width":100,"align":"center","style":{"text-transform":"uppercase"}}],"defaultPageSize":10,"paginationType":"numbers","showPageInfo":true,"minRows":1,"dataKey":"db33f0a1ebdff4006724a80bb562a008","key":"db33f0a1ebdff4006724a80bb562a008"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
<h2 id="the-layers-data-frame-representation">The layer’s data frame
representation</h2>
<p>Remember how I said that the output of
<code>Stat$compute_layer()</code> for our <code>geom_bar()</code> layer
is the <strong>dataframe representation</strong> of the layer at a
particular stage in the pipeline? If this dataframe representation were
to change, then it would affect how the layer gets drawn down the
line.</p>
<p>We saw how <code>Stat*</code> extensions do this by changing how a
ggproto method is defined (namely, via <code>$compute_group()</code>).
But we can also test this on-the-fly as well, without writing a whole
ggproto extension ourselves.</p>
<p>For example, we can modify the output of
<code>Stat$compute_layer()</code> that we grabbed with
<code>ggtrace_inspect_return()</code> before and save it to a new
variable:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>modified_compute_layer_output</span> <span class='op'>&lt;-</span> <span class='va'>compute_layer_output</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>count <span class='op'>=</span> <span class='va'>count</span> <span class='op'>^</span> <span class='fl'>2</span><span class='op'>)</span> <span class='co'>#&lt; square the counts</span>

<span class='va'>modified_compute_layer_output</span>
</code></pre>
</div>
<pre><code>    count prop x width flipped_aes PANEL group
  1  1936    1 1   0.7       FALSE     1     1
  2 15376    1 3   0.7       FALSE     1     3
  3  3136    1 1   0.7       FALSE     2     1
  4  4624    1 2   0.7       FALSE     2     2
  5  2704    1 1   0.7       FALSE     3     1
</code></pre>
</div>
<p>Then, we force <code>Stat$compute_layer()</code> to return that
modified dataframe instead when it’s called for <code>p_bar2</code>, by
passing it to the <code>value</code> argument of
<code>ggtrace_highjack_return()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_highjack_return.html'>ggtrace_highjack_return</a></span><span class='op'>(</span>
  <span class='va'>p_bar2</span>, <span class='va'>Stat</span><span class='op'>$</span><span class='va'>compute_layer</span>,
  value <span class='op'>=</span> <span class='va'>modified_compute_layer_output</span>
<span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/highjacked-compute-layer-output-1.png" width="624" /></p>
</div>
<p>See how this has direct consequences for our plot?</p>
<p>Here’s another one - we can modify the dataframe about to be returned
by <code>StatCount$compute_group()</code>, targeting just the third time
it’s called, with <code>cond = 3</code>. This time we do the
modification <em>in place</em> by passing an <a
href="https://adv-r.hadley.nz/expressions.html">expression</a> to the
<code>value</code> argument, where <code>returnValue()</code> evaluates
to the value about to be returned by the method:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/ggtrace_highjack_return.html'>ggtrace_highjack_return</a></span><span class='op'>(</span>
  <span class='va'>p_bar2</span>, <span class='va'>StatCount</span><span class='op'>$</span><span class='va'>compute_group</span>, cond <span class='op'>=</span> <span class='fl'>3</span>,
  value <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/trace.html'>returnValue</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
      <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>count <span class='op'>=</span> <span class='va'>count</span> <span class='op'>^</span> <span class='fl'>2</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/highjacked-compute-group-output-1.png" width="624" /></p>
</div>
<p>Again, a big consequence for the plot down the line.</p>
<p>The lesson here is that <strong>the dataframe representation of the
layer undergoes incremental updates in the internals</strong>, gradually
working up to its final drawing-ready form that we can see using
<code>layer_data()</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot_build.html'>layer_data</a></span><span class='op'>(</span><span class='va'>p_bar2</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>      y count prop x flipped_aes PANEL group ymin ymax xmin xmax colour   fill
  1  44    44    1 1       FALSE     1     1    0   44 0.65 1.35     NA grey35
  2 124   124    1 3       FALSE     1     3    0  124 2.65 3.35     NA grey35
  3  56    56    1 1       FALSE     2     1    0   56 0.65 1.35     NA grey35
  4  68    68    1 2       FALSE     2     2    0   68 1.65 2.35     NA grey35
  5  52    52    1 1       FALSE     3     1    0   52 0.65 1.35     NA grey35
    size linetype alpha
  1  0.5        1    NA
  2  0.5        1    NA
  3  0.5        1    NA
  4  0.5        1    NA
  5  0.5        1    NA
</code></pre>
</div>
<p>In this sense, ggproto methods are like functions that intervene at
different steps of what is essentially a data wrangling pipeline, making
piecemeal changes to the layer data. Consequently, <strong>the work of a
single ggproto method can have far reaching consequences for the plot
down the line</strong>.</p>
<p>I promise this is the end of the <code>{ggtrace}</code> self-promo,
but I encourage you to play around with the internals using the workflow
functions from the package - it can help refine your intuitions about
how ggplot internals work, with low barrier and no risk. Check out the
<a href="https://yjunechoe.github.io/ggtrace/">package website</a> if
you’d like to know more.</p>
<h2 id="other-compute_-extensions">Other <code>$compute_*()</code>
extensions</h2>
<p>Before we wrap up, I have to come clean - I’ve actually been
misleading you in instilling this divide between
<code>$compute_layer()</code> and <code>$compute_panel()</code> on one
hand, and <code>$compute_group()</code> on the other. Of course,
<code>$compute_group()</code> is the most natural extension point, but
nothing stops you from doing the necessary calculations in
<code>$compute_layer()</code> or <code>$compute_panel()</code>
instead.</p>
<p>In fact, there are several circumstances where you don’t want to do
things at the group level:</p>
<p>The first reason is for efficiency. Consider the case of
<code>geom_point()</code> - it’s a layer that draws points from
<code>x</code> and <code>y</code> values, <em>as is</em>. The stat
ggproto for this layer is <code>StatIdentity</code>, and all it does in
the <code>$compute_*()</code> step is to return the data as it received
it.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>$</span><span class='va'>stat</span> <span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] "StatIdentity" "Stat"         "ggproto"      "gg"
</code></pre>
</div>
<p>One way of implementing this is to define a
<code>StatIdentity$compute_group()</code> that just returns
<code>data</code>, but this is unnecessarily complex - you’re still
splitting the data by panel and group, only to not do anything with
it.</p>
<p>Therefore, the appropriate extension point is actually
<code>$compute_layer()</code> - you return the data as soon as you
receive it, without forwarding the data to <code>$compute_panel()</code>
and <code>$compute_group()</code>. Indeed, that’s how
<code>StatIdentity</code> is actually implemented.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatIdentity</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
   [1] "aesthetics"      "compute_group"   "compute_panel"   "default_aes"    
   [5] "extra_params"    "finish_layer"    "non_missing_aes" "optional_aes"   
   [9] "parameters"      "required_aes"    "retransform"     "setup_data"     
  [13] "setup_params"   
  
  $StatIdentity
  [1] "compute_layer"
</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>StatIdentity</span><span class='op'>$</span><span class='va'>compute_layer</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (self, data, params, layout) 
  {
      data
  }
  &lt;bytecode: 0x000002e4a4084350&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>A second reason is that sometimes you need to do calculations at the
panel level, not the group level. This is the case for
<code>StatUnique</code>. It’s an uncommon stat that’s mainly used to
deal with overplotted text by removing duplicates in the dataframe
representation of the layer.<a href="#fn5" class="footnote-ref"
id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>It’s subtle (you need to zoom in to the plots to see), but there’s a
difference in quality between overlapping text on the left (with the
<code>StatIdentity</code> default) versus the solution on the right with
<code>StatUnique</code>.</p>
<div style="
  display: flex;
  justify-content: space-between;
">
<div style="width:48%">
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>50</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='va'>x</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label <span class='op'>=</span> <span class='st'>"Some Text"</span><span class='op'>)</span>,
    size <span class='op'>=</span> <span class='fl'>25</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span>,
    stat <span class='op'>=</span> <span class='va'>StatIdentity</span> <span class='co'>#&lt; default</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stat-unique-demo-problem-1.png" width="624" /></p>
</div>
</div>
<div style="width:48%">
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>50</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='va'>x</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label <span class='op'>=</span> <span class='st'>"Some Text"</span><span class='op'>)</span>,
    size <span class='op'>=</span> <span class='fl'>25</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span>,
    stat <span class='op'>=</span> <span class='va'>StatUnique</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stat-unique-demo-solution-1.png" width="624" /></p>
</div>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:stat-unique-label-img"></span>
<img src="stat_identity_unique.png" alt="Zoomed in to the letter &quot;S&quot; from the two plots." width="70%" />
<p class="caption">
Figure 1: Zoomed in to the letter “S” from the two
plots.
</p>
</div>
</div>
<p>You might think that <code>StatUnique$compute_layer()</code> is
returning <code>unique(data)</code> at the layer level, but consider
this behavior of <code>StatUnique</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>50</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>50</span><span class='op'>)</span>,
       g <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep_len</a></span><span class='op'>(</span><span class='va'>LETTERS</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>4</span><span class='op'>]</span>, <span class='fl'>50</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label <span class='op'>=</span> <span class='st'>"Some Text"</span><span class='op'>)</span>,
    size <span class='op'>=</span> <span class='fl'>10</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span>,
    stat <span class='op'>=</span> <span class='va'>StatUnique</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/facet_wrap.html'>facet_wrap</a></span><span class='op'>(</span><span class='op'>~</span> <span class='va'>g</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stat-unique-panel-demo-1.png" width="624" /></p>
</div>
<p>We see that <code>StatUnique</code> doesn’t remove just any data
point duplicates - it removes duplicates <em>within each facet</em>.
Thus, <code>unique(data)</code> is implemented inside
<code>StatUnique$compute_panel()</code>, which is more in line with the
goal of preventing visually overlapping text.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatUnique</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
   [1] "aesthetics"      "compute_group"   "compute_layer"   "default_aes"    
   [5] "extra_params"    "finish_layer"    "non_missing_aes" "optional_aes"   
   [9] "parameters"      "required_aes"    "retransform"     "setup_data"     
  [13] "setup_params"   
  
  $StatUnique
  [1] "compute_panel"
</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>StatUnique</span><span class='op'>$</span><span class='va'>compute_panel</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre><code>  function (data, scales) 
  unique(data)
  &lt;bytecode: 0x000002e4a28c4838&gt;
  &lt;environment: namespace:ggplot2&gt;
</code></pre>
</div>
<p>Lastly, there are rare cases of where you’d want to extend multiple
<code>$compute_*()</code> methods at once. For example,
<code>StatYdensity</code> is used by <code>geom_violin()</code> to
calculate the size and shape of violins, and it extends both
<code>$compute_panel()</code> and <code>$compute_group()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_violin.html'>geom_violin</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>$</span><span class='va'>stat</span> <span class='op'>)</span>
</code></pre>
</div>
<pre><code>  [1] "StatYdensity" "Stat"         "ggproto"      "gg"
</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://yjunechoe.github.io/ggtrace/reference/get_method.html'>get_method_inheritance</a></span><span class='op'>(</span><span class='va'>StatYdensity</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  $Stat
  [1] "aesthetics"    "compute_layer" "default_aes"   "finish_layer" 
  [5] "optional_aes"  "parameters"    "retransform"   "setup_data"   
  
  $StatYdensity
  [1] "compute_group"   "compute_panel"   "extra_params"    "non_missing_aes"
  [5] "required_aes"    "setup_params"
</code></pre>
</div>
<p>This is done to create an effect where densities are calculated per
group, and then scaled within each facet. Note how violin areas are
equal within a facet but not across facets.<a href="#fn6"
class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-1"></span>
<img src="ggplot2-delayed-aes-2_files/figure-html5/unnamed-chunk-1-1.png" alt="https://stackoverflow.com/questions/47174825" width="80%" />
<p class="caption">
Figure 2: <a
href="https://stackoverflow.com/questions/47174825"
class="uri">https://stackoverflow.com/questions/47174825</a>
</p>
</div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>In <a
href="https://yjunechoe.github.io/posts/2022-03-10-ggplot2-delayed-aes-1">Part
1</a>, we were introduced to this idea of there being a <strong>data
frame representation for each layer</strong>, which gets updated and
augmented over the course of rendering a ggplot. We saw how one of the
changes to the layer data is the <strong>statistical
transformation</strong> whereby new variables like <code>count</code>
are computed internally and become available for <strong>delayed
aesthetic mapping</strong> using <code>after_stat()</code>. We saw how
this statistical transformation step isn’t as scary as it looks - it
looked like a standard data wrangling procedure that we could express
with <code>group_by()</code> and <code>summarize()</code>.</p>
<p>The goal of <a href="">Part 2</a> was to expose the exact details of
the statistical transformation step. We had our first encounter with
<strong>ggproto methods</strong> which we can think of as data wrangling
functions that live inside lists. We saw how a family of
<code>$compute_*()</code> methods called by-layer, by-facet, and
by-group implement a <strong>split-apply-combine</strong> process much
like the <code>group_by()</code> + <code>summarize()</code> combo. We
also learned that the motivation behind this odd-looking ggproto system
is to support an <strong>extension mechanism</strong> that allows us to
subclass new <code>Stat*</code> and <code>Geom*</code> ggprotos that
define their own custom behavior for a method like
<code>$compute_group()</code>.</p>
<p>Sorry if Part 2 was a bit too theoretical! In Part 3, we’ll leave
this whole ggproto thing behind to talk about <code>after_scale()</code>
and <code>stage()</code>, two more delayed aes eval functions.</p>
<h2 id="sneak-peak-of-part-3">Sneak peak of Part 3</h2>
<p>I’ll leave you with two examples as a teaser:</p>
<p>Example 1: <code>after_scale()</code> is like
<code>after_stat()</code>, but targets the data after the
(non-positional) <strong>scale transformation</strong> step, which
happens towards the end of the build pipeline:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://colorspace.R-Forge.R-project.org/'>colorspace</a></span><span class='op'>)</span>
<span class='va'>p_boxplot</span> <span class='op'>&lt;-</span> <span class='va'>penguins</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>flipper_length_mm</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>species</span>, y <span class='op'>=</span> <span class='va'>flipper_length_mm</span>, fill <span class='op'>=</span> <span class='va'>species</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_boxplot.html'>geom_boxplot</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>after_scale</a></span><span class='op'>(</span><span class='fu'><a href='https://colorspace.R-Forge.R-project.org/reference/lighten.html'>darken</a></span><span class='op'>(</span><span class='va'>fill</span>, <span class='fl'>.5</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,
    width <span class='op'>=</span> <span class='fl'>.4</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_classic</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>p_boxplot</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/after-scale-example-1.png" width="624" /></p>
</div>
<!-- ```{r} -->
<!-- inspect_after_scale <- function(p, i) { -->
<!--   ggtrace_inspect_vars( -->
<!--     p, Geom$use_defaults, cond = i, -->
<!--     at = 6, vars = "data" -->
<!--   ) -->
<!-- } -->
<!-- inspect_after_scale(p_boxplot, 1)$fill -->
<!-- inspect_after_scale(p_boxplot, 1) %>%  -->
<!--   mutate(colour = darken(fill, .5)) %>%  -->
<!--   pull(colour) -->
<!-- layer_data(p_boxplot, 1)$colour -->
<!-- ``` -->
<p>Example 2: <code>stage()</code> allows you to re-map to the same
aesthetic using variables from different points in the build
pipeline.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Generates warning in v3.3.6; fixed in dev version (PR #4707)</span>
<span class='va'>p_boxplot</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_text</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>y <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>stage</a></span><span class='op'>(</span><span class='va'>flipper_length_mm</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>lower</span>, <span class='va'>middle</span>, <span class='va'>upper</span><span class='op'>)</span><span class='op'>)</span>,
        label <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>after_stat</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>lower</span>, <span class='va'>middle</span>, <span class='va'>upper</span><span class='op'>)</span><span class='op'>)</span>,
        color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>after_scale</a></span><span class='op'>(</span><span class='fu'><a href='https://colorspace.R-Forge.R-project.org/reference/lighten.html'>darken</a></span><span class='op'>(</span><span class='va'>fill</span>, <span class='fl'>.8</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>,
    size <span class='op'>=</span> <span class='fl'>4</span>, hjust <span class='op'>=</span> <span class='fl'>1</span>,
    position <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/position_nudge.html'>position_nudge</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fl'>.5</span><span class='op'>)</span>,
    stat <span class='op'>=</span> <span class='va'>StatBoxplot</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_classic</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stage-example-1.png" width="624" /></p>
</div>
<h2 id="a-taste-of-writing-ggproto-extensions">A taste of writing
ggproto extensions</h2>
<p>Though writing ggproto extensions is beyond the scope of this blog
series,<a href="#fn7" class="footnote-ref" id="fnref7"
role="doc-noteref"><sup>7</sup></a> we’re now well prepared for it after
working through the logic of how the top-level template
<code>Stat</code> ggproto gets extended in child <code>Stat*</code>
ggprotos like <code>StatCount</code>. All that’s missing is the syntax
that implements this (that’s usually the easy part!).</p>
<p>Just to give you a taste without going into it too deep, this is an
example stat extension inspired by <a
href="https://twitter.com/EvaMaeRey">Gina Reynolds</a> that calculates
an internal variable called <code>rowid</code> inside
<code>$compute_layer()</code> and also sets a default aesthetic mapping
of <code>label = after_stat(rowid)</code> in
<code>$default_aes</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>StatRowID</span> <span class='op'>&lt;-</span> <span class='fu'>ggplot2</span><span class='fu'>::</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggproto.html'>ggproto</a></span><span class='op'>(</span>
  
  <span class='co'># Create a new ggproto of class "StatRowID"</span>
  `_class` <span class='op'>=</span> <span class='st'>"StatRowID"</span>,
  <span class='co'># That inherits from the top-level `Stat` ggproto</span>
  `_inherit` <span class='op'>=</span> <span class='va'>Stat</span>,
  
  <span class='co'># Extension point: add a `rowid` column to the data at layer-level</span>
  compute_layer <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>self</span>, <span class='va'>data</span>, <span class='va'>params</span>, <span class='va'>layout</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>data</span><span class='op'>$</span><span class='va'>rowid</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq_len</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>)</span><span class='op'>)</span>
    <span class='va'>data</span>
  <span class='op'>}</span>,
  
  <span class='co'># Extension point: map the computed `rowid` variable to `label`</span>
  default_aes <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>after_stat</a></span><span class='op'>(</span><span class='va'>rowid</span><span class='op'>)</span><span class='op'>)</span>
  
<span class='op'>)</span>

<span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, g <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"A"</span>, <span class='st'>"B"</span><span class='op'>)</span>, each <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, fill <span class='op'>=</span> <span class='va'>g</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_label</a></span><span class='op'>(</span>stat <span class='op'>=</span> <span class='va'>StatRowID</span><span class='op'>)</span> <span class='co'># or "RowID"</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-layer-1.png" width="624" /></p>
</div>
<p>If we wanted row IDs to be calculated by group, we simply move the
computation to <code>$compute_group()</code></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>StatRowIDbyGroup</span> <span class='op'>&lt;-</span> <span class='fu'>ggplot2</span><span class='fu'>::</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggproto.html'>ggproto</a></span><span class='op'>(</span>
  `_class` <span class='op'>=</span> <span class='st'>"StatRowIDbyGroup"</span>,
  `_inherit` <span class='op'>=</span> <span class='va'>Stat</span>,
  default_aes <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>label <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>after_stat</a></span><span class='op'>(</span><span class='va'>rowid</span><span class='op'>)</span><span class='op'>)</span>,
  <span class='co'># Extend `compute_group` instead of `compute_layer`</span>
  compute_group <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>self</span>, <span class='va'>data</span>, <span class='va'>scales</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>data</span><span class='op'>$</span><span class='va'>rowid</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq_len</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>)</span><span class='op'>)</span>
    <span class='va'>data</span>
  <span class='op'>}</span>
<span class='op'>)</span>

<span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, g <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"A"</span>, <span class='st'>"B"</span><span class='op'>)</span>, each <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, fill <span class='op'>=</span> <span class='va'>g</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_text.html'>geom_label</a></span><span class='op'>(</span>stat <span class='op'>=</span> <span class='va'>StatRowIDbyGroup</span><span class='op'>)</span> <span class='co'># or "RowIDbyGroup"</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-group-1.png" width="624" /></p>
</div>
<p>If the sensible use of <code>statRowIDbyGroup</code> is for it to be
paired with the label geom, then we write a layer function (also called
a <em>constructor function</em>) that wraps around
<code>ggplot2::layer()</code>. Inside <code>stat_rowid()</code>, we hard
code <code>stat = StatRowIDbyGroup</code> and expose the
<code>geom = "label"</code> default argument to the user:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>stat_rowid</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>mapping</span> <span class='op'>=</span> <span class='cn'>NULL</span>, <span class='va'>data</span> <span class='op'>=</span> <span class='cn'>NULL</span>,
                       <span class='va'>geom</span> <span class='op'>=</span> <span class='st'>"label"</span>, <span class='va'>position</span> <span class='op'>=</span> <span class='st'>"identity"</span>,
                       <span class='va'>...</span>, <span class='va'>na.rm</span> <span class='op'>=</span> <span class='cn'>FALSE</span>, <span class='va'>show.legend</span> <span class='op'>=</span> <span class='cn'>NA</span>, <span class='va'>inherit.aes</span> <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'>ggplot2</span><span class='fu'>::</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/layer.html'>layer</a></span><span class='op'>(</span>
    <span class='co'># All layers need data and aesthetic mappings</span>
    data <span class='op'>=</span> <span class='va'>data</span>, mapping <span class='op'>=</span> <span class='va'>mapping</span>,
    <span class='co'># The layer's choice of Stat, Geom, and Position</span>
    stat <span class='op'>=</span> <span class='va'>StatRowIDbyGroup</span>, geom <span class='op'>=</span> <span class='va'>geom</span>, position <span class='op'>=</span> <span class='va'>position</span>,
    <span class='co'># Standard parameters available for all `layer()`s (there are more)</span>
    show.legend <span class='op'>=</span> <span class='va'>show.legend</span>, inherit.aes <span class='op'>=</span> <span class='va'>inherit.aes</span>,
    <span class='co'># Arguments to be passed down to Stat/Geom/Position</span>
    params <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>na.rm <span class='op'>=</span> <span class='va'>na.rm</span>, <span class='va'>...</span><span class='op'>)</span>
  <span class='op'>)</span>
<span class='op'>}</span>

<span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, g <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"A"</span>, <span class='st'>"B"</span><span class='op'>)</span>, each <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, fill <span class='op'>=</span> <span class='va'>g</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>stat_rowid</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-group-constructor-1.png" width="624" /></p>
</div>
<p>By following these design principles, you get a lot of features for
free, like the ability to swap out the geom and map the internally
calculated <code>rowid</code> variable elsewhere via
<code>after_stat()</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>20</span><span class='op'>)</span>, g <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"A"</span>, <span class='st'>"B"</span><span class='op'>)</span>, each <span class='op'>=</span> <span class='fl'>10</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span>, color <span class='op'>=</span> <span class='va'>g</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>stat_rowid</span><span class='op'>(</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>
      size <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>after_stat</a></span><span class='op'>(</span><span class='va'>rowid</span><span class='op'>)</span>,
      alpha <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes_eval.html'>after_stat</a></span><span class='op'>(</span><span class='va'>rowid</span><span class='op'>/</span><span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>rowid</span><span class='op'>)</span><span class='op'>)</span>
    <span class='op'>)</span>,
    geom <span class='op'>=</span> <span class='st'>"text"</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="ggplot2-delayed-aes-2_files/figure-html5/stat-row-id-group-constructor-flexibility-1.png" width="624" /></p>
</div>
<p>If you’re feeling ambitious, I highly recommend starting with <a
href="https://twitter.com/thomasp85">Thomas Lin Pedersen</a>’s <a
href="https://www.rstudio.com/resources/rstudioconf-2020/extending-your-ability-to-extend-ggplot2/">rstudio::conf
talk</a>. Good luck!</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Technically, it was returning the
output of <code>ggplot2:::Layer$compute_statistic()</code> which returns
the <code>$compute_layer()</code> method called by the layer’s stat. But
we don’t need to worry about this distinction for this blog post.<a
href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Missing columns get added back in
when <code>$compute_panel()</code> combines the output of
<code>$compute_group()</code> calls.<a href="#fnref2"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>For example, one big difference is
that parameters are passed in as a list to the <code>params</code>
argument of <code>compute_layer()</code>, which is then spliced and
passed in as the <code>...</code> of <code>compute_panel()</code>
through <code>do.call()</code>.<a href="#fnref3" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>It’s actually optional and only
available if the method specifies an argument called <code>self</code>.
As long as it’s present in the formals, it can appear in any position.
The convention is to define all ggproto methods with <code>self</code>
as the first argument.<a href="#fnref4" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>An alternative solution that I
personally prefer is <code>annotate(geom = "text", ..)</code>.<a
href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>I’m not sure about the rationale for
this, and <a href="https://stackoverflow.com/questions/47174825">people
have brought up wanting to change this default</a>. Given everything
we’ve discussed so far, we don’t have to read the source code to know
that if you want all violins in the <em>layer</em> to have the same
size, we should move the calculations in <code>$compute_panel()</code>
to <code>$compute_layer()</code> instead.<a href="#fnref6"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>Other resources exist for that (in
fact, most resources on learning the internals focus on writing
extensions). Chapter <a
href="https://ggplot2-book.org/internals.html">20</a> and <a
href="https://ggplot2-book.org/extensions.html">21</a> of the ggplot2
book is a good place to start.<a href="#fnref7" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<div class="article-footer">
  <p class="social_footer">
    <span class="article-sharing">
      Share: &nbsp;
      <a href="https://twitter.com/share?text=Demystifying%20delayed%20aesthetic%20evaluation%3A%20Part%202&amp;url=https%3A%2F%2Fyjunechoe.github.io%2Fposts%2F2022-07-06-ggplot2-delayed-aes-2%2F" aria-label="share on twitter">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
    </span>
  </p>
</div>
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<!--radix_placeholder_navigation_after_body--><html><body>
<div class="distill-site-nav distill-site-footer">
<p><span style="font-family: 'Open Sans'"> June Choe | Created with
{<a href="https://github.com/rstudio/distill" style="color: #24addb">distill</a>}
</span></p>
</div>
<!--/radix_placeholder_navigation_after_body-->
</body></html>


</body>

</html>
